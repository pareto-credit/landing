{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/vault-requests/libs/vault-requests.lib.ts"],"sourcesContent":["import moment from 'moment'\n\nimport { VaultBlock, VaultBlockRequest } from '../../vault-blocks'\n\n/**\n * Get vault request processing date\n *\n * REDEEM -> normal withdraw (netting withdraw)\n * * isCurrentRequest = cdoEpoch.status === 'WAITING' && request.requestedOn > cdoEpoch.endDate\n * isCurrentRequest -> cdoEpoch.endDate + buffer + duration\n * !isCurrentRequest -> cdoEpoch.endDate\n *\n * DEPOSIT -> queue deposit request\n * * isCurrentRequest = cdoEpoch.status === 'RUNNING' && request.requestedOn < cdoEpoch.endDate\n * isCurrentRequest -> cdoEpoch.endDate\n * !isCurrentRequest -> cdoEpoch.startDate\n *\n * WITHDRAW -> queue withdraw (running normal withdraw)\n * * isCurrentRequest = cdoEpoch.status === 'RUNNING' && request.requestedOn < cdoEpoch.endDate\n * isCurrentRequest -> cdoEpoch.endDate + bufferDuration + duration\n * !isCurrentRequest -> cdoEpoch.endDate\n *\n * INSTANT_WITHDRAW -> queue withdraw (running instant withdraw)\n * * isCurrentRequest = cdoEpoch.status === 'RUNNING' && request.requestedOn < cdoEpoch.endDate\n * isCurrentRequest -> cdoEpoch.endDate + bufferDuration + instantWithdrawDuration\n * !isCurrentRequest -> cdoEpoch.startDate + instantWithdrawDuration\n *\n * @param block - the vault block\n * @param request - the vault block request\n * @returns the request processing date\n */\nexport function getVaultRequestProcessingDate(\n  block: VaultBlock,\n  request: VaultBlockRequest\n): string | undefined {\n  const { cdoEpoch } = block\n\n  if (!cdoEpoch) {\n    return\n  }\n\n  const {\n    duration,\n    bufferDuration,\n    instantWithdraws,\n    startDate,\n    endDate,\n    status,\n  } = cdoEpoch\n\n  switch (request.type) {\n    case 'REDEEM': {\n      const isCurrentRequest =\n        status === 'WAITING' &&\n        moment(request.requestedOn).isAfter(moment(endDate))\n\n      return isCurrentRequest\n        ? moment(endDate)\n            .add(duration, 's')\n            .add(bufferDuration, 's')\n            .toISOString()\n        : endDate\n    }\n\n    case 'DEPOSIT': {\n      const isCurrentRequest =\n        status === 'RUNNING' &&\n        moment(request.requestedOn).isBefore(moment(endDate))\n\n      return isCurrentRequest ? endDate : startDate\n    }\n\n    case 'WITHDRAW': {\n      const isCurrentRequest =\n        status === 'RUNNING' &&\n        moment(request.requestedOn).isAfter(moment(startDate))\n\n      if (request.isInstant) {\n        const withdrawDelay = instantWithdraws?.delay\n\n        return isCurrentRequest\n          ? moment(endDate)\n              .add(withdrawDelay, 's')\n              .add(bufferDuration, 's')\n              .toISOString()\n          : moment(startDate).add(withdrawDelay, 's').toISOString()\n      }\n\n      return isCurrentRequest\n        ? moment(endDate)\n            .add(duration, 's')\n            .add(bufferDuration, 's')\n            .toISOString()\n        : endDate\n    }\n\n    // No date available\n    default:\n      return\n  }\n\n  return\n}\n"],"names":["getVaultRequestProcessingDate","block","request","cdoEpoch","duration","bufferDuration","instantWithdraws","startDate","endDate","status","type","isCurrentRequest","moment","requestedOn","isAfter","add","toISOString","isBefore","isInstant","withdrawDelay","delay"],"mappings":";;;;+BA+BgBA;;;eAAAA;;;;iEA/BG;AA+BZ,SAASA,8BACdC,KAAiB,EACjBC,OAA0B;IAE1B,MAAM,EAAEC,QAAQ,EAAE,GAAGF;IAErB,IAAI,CAACE,UAAU;QACb;IACF;IAEA,MAAM,EACJC,QAAQ,EACRC,cAAc,EACdC,gBAAgB,EAChBC,SAAS,EACTC,OAAO,EACPC,MAAM,EACP,GAAGN;IAEJ,OAAQD,QAAQQ,IAAI;QAClB,KAAK;YAAU;gBACb,MAAMC,mBACJF,WAAW,aACXG,IAAAA,eAAM,EAACV,QAAQW,WAAW,EAAEC,OAAO,CAACF,IAAAA,eAAM,EAACJ;gBAE7C,OAAOG,mBACHC,IAAAA,eAAM,EAACJ,SACJO,GAAG,CAACX,UAAU,KACdW,GAAG,CAACV,gBAAgB,KACpBW,WAAW,KACdR;YACN;QAEA,KAAK;YAAW;gBACd,MAAMG,mBACJF,WAAW,aACXG,IAAAA,eAAM,EAACV,QAAQW,WAAW,EAAEI,QAAQ,CAACL,IAAAA,eAAM,EAACJ;gBAE9C,OAAOG,mBAAmBH,UAAUD;YACtC;QAEA,KAAK;YAAY;gBACf,MAAMI,mBACJF,WAAW,aACXG,IAAAA,eAAM,EAACV,QAAQW,WAAW,EAAEC,OAAO,CAACF,IAAAA,eAAM,EAACL;gBAE7C,IAAIL,QAAQgB,SAAS,EAAE;oBACrB,MAAMC,gBAAgBb,oCAAAA,iBAAkBc,KAAK;oBAE7C,OAAOT,mBACHC,IAAAA,eAAM,EAACJ,SACJO,GAAG,CAACI,eAAe,KACnBJ,GAAG,CAACV,gBAAgB,KACpBW,WAAW,KACdJ,IAAAA,eAAM,EAACL,WAAWQ,GAAG,CAACI,eAAe,KAAKH,WAAW;gBAC3D;gBAEA,OAAOL,mBACHC,IAAAA,eAAM,EAACJ,SACJO,GAAG,CAACX,UAAU,KACdW,GAAG,CAACV,gBAAgB,KACpBW,WAAW,KACdR;YACN;QAEA,oBAAoB;QACpB;YACE;IACJ;IAEA;AACF"}