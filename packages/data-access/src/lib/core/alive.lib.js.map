{"version":3,"sources":["../../../../../../../libs/shared/data-access/src/lib/core/alive.lib.ts"],"sourcesContent":["export interface KeepAliveOptions {\n  /**\n   * milliseconds\n   *\n   * @default 1000\n   */\n  minDelay?: number\n  /**\n   * milliseconds\n   *\n   * @default Infinity\n   */\n  maxDelay?: number\n  /**\n   * Reset attempts number delay (milliseconds).\n   *\n   * @default 30000\n   */\n  resetAfter?: number\n  /**\n   * Abort signal.\n   */\n  signal?: AbortSignal\n  /**\n   * Exit handler.\n   */\n  onExit?: (err: any) => any\n}\n\n/**\n * Keep alive an async function with exponential retry.\n */\n\nexport function keepAlive(\n  fn: () => Promise<any>,\n  options: KeepAliveOptions = {}\n) {\n  const minDelay = options.minDelay ?? 1000\n  const maxDelay = options.maxDelay ?? Number.POSITIVE_INFINITY\n  const resetAfter = options.resetAfter ?? 30000\n\n  let tmDelay: any\n  let tmReset: any\n\n  let aborted = false\n  let attempts = 0\n\n  const stop = () => {\n    if (tmDelay) {\n      clearTimeout(tmDelay)\n    }\n    if (tmReset) {\n      clearTimeout(tmReset)\n    }\n  }\n\n  const handler = (err: any) => {\n    if (aborted) {\n      return\n    }\n    stop()\n    if (options.onExit) {\n      options.onExit(err)\n    }\n\n    tmDelay = setTimeout(() => {\n      fn()\n        .then(() => handler(null))\n        .catch(handler)\n    }, Math.min(minDelay * Math.floor(Math.exp(attempts++)), maxDelay))\n\n    tmReset = setTimeout(() => {\n      attempts = 0\n    }, resetAfter)\n  }\n\n  fn()\n    .then(() => handler(null))\n    .catch(handler)\n\n  function abort() {\n    aborted = true\n    stop()\n  }\n  options.signal?.addEventListener('abort', abort)\n  return abort\n}\n"],"names":["keepAlive","fn","options","minDelay","maxDelay","Number","POSITIVE_INFINITY","resetAfter","tmDelay","tmReset","aborted","attempts","stop","clearTimeout","handler","err","onExit","setTimeout","then","catch","Math","min","floor","exp","abort","signal","addEventListener"],"mappings":";;;;+BAiCgBA;;;eAAAA;;;AAAT,SAASA,UACdC,EAAsB,EACtBC,UAA4B,CAAC,CAAC;QAiD9BA;QA/CiBA;IAAjB,MAAMC,WAAWD,CAAAA,oBAAAA,QAAQC,QAAQ,YAAhBD,oBAAoB;QACpBA;IAAjB,MAAME,WAAWF,CAAAA,oBAAAA,QAAQE,QAAQ,YAAhBF,oBAAoBG,OAAOC,iBAAiB;QAC1CJ;IAAnB,MAAMK,aAAaL,CAAAA,sBAAAA,QAAQK,UAAU,YAAlBL,sBAAsB;IAEzC,IAAIM;IACJ,IAAIC;IAEJ,IAAIC,UAAU;IACd,IAAIC,WAAW;IAEf,MAAMC,OAAO;QACX,IAAIJ,SAAS;YACXK,aAAaL;QACf;QACA,IAAIC,SAAS;YACXI,aAAaJ;QACf;IACF;IAEA,MAAMK,UAAU,CAACC;QACf,IAAIL,SAAS;YACX;QACF;QACAE;QACA,IAAIV,QAAQc,MAAM,EAAE;YAClBd,QAAQc,MAAM,CAACD;QACjB;QAEAP,UAAUS,WAAW;YACnBhB,KACGiB,IAAI,CAAC,IAAMJ,QAAQ,OACnBK,KAAK,CAACL;QACX,GAAGM,KAAKC,GAAG,CAAClB,WAAWiB,KAAKE,KAAK,CAACF,KAAKG,GAAG,CAACZ,cAAcP;QAEzDK,UAAUQ,WAAW;YACnBN,WAAW;QACb,GAAGJ;IACL;IAEAN,KACGiB,IAAI,CAAC,IAAMJ,QAAQ,OACnBK,KAAK,CAACL;IAET,SAASU;QACPd,UAAU;QACVE;IACF;KACAV,kBAAAA,QAAQuB,MAAM,qBAAdvB,gBAAgBwB,gBAAgB,CAAC,SAASF;IAC1C,OAAOA;AACT"}