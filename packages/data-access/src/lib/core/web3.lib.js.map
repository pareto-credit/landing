{"version":3,"sources":["../../../../../../../libs/shared/data-access/src/lib/core/web3.lib.ts"],"sourcesContent":["import { decodeParameters } from 'web3-eth-abi'\nimport Web3, { AbiInput, HexString } from 'web3'\nimport {\n  WEB3_HASH_LINKS,\n  WEB3_MAX_TOKEN_AMOUNT,\n  WEB3_MIN_TOKEN_AMOUNT,\n} from './web3.const'\nimport { Web3HashType } from './web3.model'\nimport { BNgte, BNify, BNlte } from './bigint.lib'\nimport { numberFormat } from './utility.lib'\n/**\n * Remove initial '0x' from an address\n * @param addr - the address to strip\n * @returns the address stripped\n */\nexport function strip0x(addr: string): string {\n  return addr.replace(/^0x/, '')\n}\n\n/**\n * Check if a string is a blockchain address\n * @param address - the address string to verify\n * @returns true if is an address\n */\nexport function isAddress(address: string): boolean {\n  return typeof address === 'string' && !!address.match(/^0x[a-fA-F0-9]{40}$/)\n}\n\n/**\n * Check if a string is a blockchain transaction\n * @param hash - the hash string to verify\n * @returns true if is a tx hash\n */\nexport function isTxHash(hash: string): boolean {\n  return typeof hash === 'string' && !!hash.match(/^0x[a-fA-F0-9]{64}$/)\n}\n\n/**\n * Decode ABI parameters\n * @param inputs abi inputs\n * @param bytes hex string\n * @returns decoded parameters\n */\nexport function decodeAbiParameters(inputs: AbiInput[], bytes: HexString): any {\n  return decodeParameters(inputs, bytes)\n}\n\n/**\n * Reduce the length of an hash\n * @param hash - the hash to short\n * @param startLen - the start length\n * @param endLen - the end length\n * @returns the hash shorted\n */\nexport function shortHash(hash: string, startLen = 7, endLen = 4) {\n  const txStart = hash.slice(0, startLen)\n  const txEnd = hash.slice(hash.length - endLen)\n  return `${txStart}...${txEnd}`\n}\n\n/**\n * Make hash link\n * @param hash - the hash\n * @param chainID - the chain ID\n * @returns the link to the transaction/address hash\n */\nexport function makeHashLink(\n  type: Web3HashType,\n  hash: string,\n  chainID: string\n) {\n  const hashLink = WEB3_HASH_LINKS[chainID]\n  return `${hashLink}/${type}/${hash}`\n}\n\n/**\n * Check if the amount is formatted correctly for the contract\n * @param amount normalized amount\n * @returns true | false\n */\nexport function checkWeb3Amount(amount: number | string | undefined): boolean {\n  return (\n    amount !== '' &&\n    !BNify(amount).isNaN() &&\n    BNgte(amount, WEB3_MIN_TOKEN_AMOUNT) &&\n    BNlte(amount, WEB3_MAX_TOKEN_AMOUNT)\n  )\n}\n\n/**\n * Short Web3 amount utility\n * @param amount - the token amount to send\n * @param fromDecimals - the token decimals\n * @param options - the intl options\n * @returns the string to show to the user\n */\nexport function shortWeb3Amount(\n  amount: string | undefined,\n  fromDecimals: string | number,\n  options: Intl.NumberFormatOptions = {\n    maximumFractionDigits: 2,\n    notation: 'compact',\n    compactDisplay: 'short',\n  }\n): string {\n  return numberFormat(\n    BNify(amount).div(`1e${fromDecimals}`).toNumber(),\n    options\n  )\n}\n\n/**\n * Polling for getting the tx receipt\n * @param web3 - web3\n * @param txHash - the tx hash\n * @param timeoutParams -\n * @returns\n */\nexport async function waitForReceiptIndexed(\n  web3: Web3 | undefined,\n  txHash: string,\n  { timeout = 30000, interval = 2000 } = {}\n) {\n  if (!web3) return\n  const start = Date.now()\n  while (Date.now() - start < timeout) {\n    try {\n      const receipt = await web3.eth.getTransactionReceipt(txHash)\n      if (receipt) return receipt\n    } catch (err: unknown) {\n      const errObj = err as Record<string, unknown>\n      const msg =\n        err &&\n        typeof err === 'object' &&\n        'message' in err &&\n        typeof errObj['message'] === 'string'\n          ? (errObj['message'] as string)\n          : String(err)\n      if (!msg.includes('indexing')) {\n        // if it's an unknown error, rethrow\n        throw err\n      }\n      // otherwise fallthrough and retry\n    }\n    await new Promise((r) => setTimeout(r, interval))\n  }\n  // timeout\n  return\n}\n"],"names":["checkWeb3Amount","decodeAbiParameters","isAddress","isTxHash","makeHashLink","shortHash","shortWeb3Amount","strip0x","waitForReceiptIndexed","addr","replace","address","match","hash","inputs","bytes","decodeParameters","startLen","endLen","txStart","slice","txEnd","length","type","chainID","hashLink","WEB3_HASH_LINKS","amount","BNify","isNaN","BNgte","WEB3_MIN_TOKEN_AMOUNT","BNlte","WEB3_MAX_TOKEN_AMOUNT","fromDecimals","options","maximumFractionDigits","notation","compactDisplay","numberFormat","div","toNumber","web3","txHash","timeout","interval","start","Date","now","receipt","eth","getTransactionReceipt","err","errObj","msg","String","includes","Promise","r","setTimeout"],"mappings":";;;;;;;;;;;IAgFgBA,eAAe;eAAfA;;IArCAC,mBAAmB;eAAnBA;;IAnBAC,SAAS;eAATA;;IASAC,QAAQ;eAARA;;IAiCAC,YAAY;eAAZA;;IAZAC,SAAS;eAATA;;IA0CAC,eAAe;eAAfA;;IAjFAC,OAAO;eAAPA;;IAuGMC,qBAAqB;eAArBA;;;4BAtHW;2BAM1B;2BAE6B;4BACP;AAMtB,SAASD,QAAQE,IAAY;IAClC,OAAOA,KAAKC,OAAO,CAAC,OAAO;AAC7B;AAOO,SAASR,UAAUS,OAAe;IACvC,OAAO,OAAOA,YAAY,YAAY,CAAC,CAACA,QAAQC,KAAK,CAAC;AACxD;AAOO,SAAST,SAASU,IAAY;IACnC,OAAO,OAAOA,SAAS,YAAY,CAAC,CAACA,KAAKD,KAAK,CAAC;AAClD;AAQO,SAASX,oBAAoBa,MAAkB,EAAEC,KAAgB;IACtE,OAAOC,IAAAA,4BAAgB,EAACF,QAAQC;AAClC;AASO,SAASV,UAAUQ,IAAY,EAAEI,WAAW,CAAC,EAAEC,SAAS,CAAC;IAC9D,MAAMC,UAAUN,KAAKO,KAAK,CAAC,GAAGH;IAC9B,MAAMI,QAAQR,KAAKO,KAAK,CAACP,KAAKS,MAAM,GAAGJ;IACvC,OAAO,CAAC,EAAEC,QAAQ,GAAG,EAAEE,MAAM,CAAC;AAChC;AAQO,SAASjB,aACdmB,IAAkB,EAClBV,IAAY,EACZW,OAAe;IAEf,MAAMC,WAAWC,0BAAe,CAACF,QAAQ;IACzC,OAAO,CAAC,EAAEC,SAAS,CAAC,EAAEF,KAAK,CAAC,EAAEV,KAAK,CAAC;AACtC;AAOO,SAASb,gBAAgB2B,MAAmC;IACjE,OACEA,WAAW,MACX,CAACC,IAAAA,gBAAK,EAACD,QAAQE,KAAK,MACpBC,IAAAA,gBAAK,EAACH,QAAQI,gCAAqB,KACnCC,IAAAA,gBAAK,EAACL,QAAQM,gCAAqB;AAEvC;AASO,SAAS3B,gBACdqB,MAA0B,EAC1BO,YAA6B,EAC7BC,UAAoC;IAClCC,uBAAuB;IACvBC,UAAU;IACVC,gBAAgB;AAClB,CAAC;IAED,OAAOC,IAAAA,wBAAY,EACjBX,IAAAA,gBAAK,EAACD,QAAQa,GAAG,CAAC,CAAC,EAAE,EAAEN,aAAa,CAAC,EAAEO,QAAQ,IAC/CN;AAEJ;AASO,eAAe3B,sBACpBkC,IAAsB,EACtBC,MAAc,EACd,EAAEC,UAAU,KAAK,EAAEC,WAAW,IAAI,EAAE,GAAG,CAAC,CAAC;IAEzC,IAAI,CAACH,MAAM;IACX,MAAMI,QAAQC,KAAKC,GAAG;IACtB,MAAOD,KAAKC,GAAG,KAAKF,QAAQF,QAAS;QACnC,IAAI;YACF,MAAMK,UAAU,MAAMP,KAAKQ,GAAG,CAACC,qBAAqB,CAACR;YACrD,IAAIM,SAAS,OAAOA;QACtB,EAAE,OAAOG,KAAc;YACrB,MAAMC,SAASD;YACf,MAAME,MACJF,OACA,OAAOA,QAAQ,YACf,aAAaA,OACb,OAAOC,MAAM,CAAC,UAAU,KAAK,WACxBA,MAAM,CAAC,UAAU,GAClBE,OAAOH;YACb,IAAI,CAACE,IAAIE,QAAQ,CAAC,aAAa;gBAC7B,oCAAoC;gBACpC,MAAMJ;YACR;QACA,kCAAkC;QACpC;QACA,MAAM,IAAIK,QAAQ,CAACC,IAAMC,WAAWD,GAAGb;IACzC;IACA,UAAU;IACV;AACF"}