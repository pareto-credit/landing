{"version":3,"sources":["../../../../../../../libs/shared/data-access/src/lib/web3-client/web3-client.class.ts"],"sourcesContent":["import Web3, {\n  Block,\n  Contract,\n  ContractAbi,\n  Filter,\n  Transaction,\n  TransactionReceipt,\n} from 'web3'\nimport BigNumber from 'bignumber.js'\n\nimport {\n  ERC20Token,\n  Web3CallData,\n  Web3CallParam,\n  Web3ClientModel,\n  Web3ClientOptions,\n  Web3DataParam,\n  Web3DataParams,\n  Web3Event,\n  Web3RPCProvider,\n  Web3Topic,\n} from './web3-client.model'\nimport {\n  WEB3_CONTRACT_METHODS,\n  WEB3_DEFAULT_BLOCK_PER_YEAR,\n  WEB3_MULTICALL_CONTRACT_ADDR,\n  WEB3_MULTICALL_FIRST_BLOCK,\n  WEB3_MULTICALL_METHOD_ABI,\n  WEB3_MULTICALL_PARAM_ABI,\n  WEB3_MULTICALL_RESPONSE_ABI,\n} from './web3-client.const'\nimport {\n  Abi,\n  BNify,\n  BNlt,\n  BlockNumber,\n  isAddress,\n  isTxHash,\n  strip0x,\n} from '../core'\nimport { ERC20_ABI, makeWeb3CallData } from '../vaults'\n\n/**\n * Web3 Client class\n */\nexport class Web3Client implements Web3ClientModel {\n  // The internal data\n  readonly provider: Web3RPCProvider\n\n  // The Web3 instance\n  public web3: Web3\n\n  // Default contract address to use for multi-calls\n  public blocksPerYear: number\n  public contractAddress: string\n\n  // TODO: This logger must be typed\n  private logger?: any\n\n  constructor({\n    web3,\n    provider,\n    contractAddress = WEB3_MULTICALL_CONTRACT_ADDR,\n    blocksPerYear = WEB3_DEFAULT_BLOCK_PER_YEAR,\n    logger,\n  }: Web3ClientOptions) {\n    this.web3 = web3\n    this.provider = provider\n    this.contractAddress = contractAddress\n    this.blocksPerYear = blocksPerYear\n    this.logger = logger\n  }\n\n  /**\n   * Initialize contract instance\n   * @param abi - the contract ABI\n   * @param address - the address\n   * @returns the new instance of Web3 Contract\n   */\n  public initContract(abi: ContractAbi, address: string): Contract<Abi> {\n    return new this.web3.eth.Contract(abi, address)\n  }\n\n  /**\n   * Create a topic from a type\n   * @param topicType - the topic type\n   * @returns the topic encoded\n   */\n  public createTopic(topicType: Web3Topic) {\n    const argument =\n      topicType === 'transfer' ? 'Transfer(address,address,uint256)' : ''\n    return this.web3.utils.sha3(argument) || ''\n  }\n\n  /**\n   * Get web3 transaction from hash\n   * @param hash transaction hash\n   * @returns web3 transaction object\n   */\n  public async getTransaction(hash: string): Promise<Transaction | undefined> {\n    if (!isTxHash(hash)) return\n    return this.web3.eth.getTransaction(hash)\n  }\n\n  /**\n   * Get transcation logs from hash\n   * @param hash transaction hash\n   * @returns transaction logs array\n   */\n  public async getTransactionLogs(\n    hash: string\n  ): Promise<TransactionReceipt['logs']> {\n    if (!isTxHash(hash)) return []\n    const receipt = await this.web3.eth.getTransactionReceipt(hash)\n    return receipt?.logs || []\n  }\n\n  /**\n   * Get block data\n   * @param blockNumber - the block number\n   * @returns the promise to load block data\n   */\n  public async getBlock(blockNumber: BlockNumber = 'latest'): Promise<Block> {\n    return this.web3.eth.getBlock(blockNumber)\n  }\n\n  /**\n   * Get contract events using block range\n   * @param contract vault contract\n   * @param eventType event type\n   * @param startBlock start block number\n   * @param endBlock end block number\n   * @param maxBlocks max blocks per batch\n   * @returns concatenated past events\n   */\n  public async getContractEvents(\n    contract: Contract<Abi>,\n    eventType: 'Transfer',\n    startBlock: BlockNumber,\n    endBlock: BlockNumber = 'latest',\n    filters: Filter = {},\n    maxBlocks = 1000\n  ): Promise<Web3Event[]> {\n    // Get latest block if not specified\n    if (endBlock === 'latest') {\n      endBlock = (await this.getBlock()).number\n    }\n\n    if (BNlt(endBlock, startBlock)) {\n      endBlock = startBlock\n    }\n\n    // Total blocks to get\n    const totalBlocks = BigNumber.maximum(\n      1,\n      BNify(endBlock).minus(BNify(startBlock))\n    )\n\n    this.logger?.debug(\n      `Get ${eventType} events for ${contract.options.address} from ${startBlock} to ${endBlock}, maxBlocks: ${maxBlocks}.`\n    )\n\n    // Set from and to block\n    let fromBlock = BNify(startBlock)\n    let toBlock = BNlt(totalBlocks, maxBlocks)\n      ? BNify(endBlock)\n      : BigNumber.minimum(BNify(endBlock), BNify(startBlock).plus(maxBlocks))\n\n    let pastEvents: any[] = []\n    let retry = 0\n    do {\n      try {\n        // @ts-expect-error: use whatever eventType\n        const events = await contract.getPastEvents(eventType, {\n          fromBlock: this.parseBlock(fromBlock.toNumber()),\n          toBlock: this.parseBlock(toBlock.toNumber()),\n          ...filters,\n        })\n\n        // Concat events\n        pastEvents = [...pastEvents, ...events]\n\n        this.logger?.debug(\n          `Get ${eventType} events for ${contract.options.address} from ${fromBlock} to ${toBlock}. Events: ${events.length}, Total: ${pastEvents.length}`\n        )\n\n        // Increment from and to block\n        fromBlock = toBlock.plus(1)\n        toBlock = BigNumber.minimum(BNify(endBlock), toBlock.plus(maxBlocks))\n      } catch (error) {\n        retry++\n        this.logger?.error(\n          `Error while getting past events for ${contract.options.address} from ${fromBlock} to ${toBlock}. Count: ${retry}`\n        )\n      }\n    } while (BNlt(toBlock, endBlock) && retry < 10)\n\n    return pastEvents\n  }\n\n  /**\n   * Parse block number into hex string\n   * @param blockNumber - the block number\n   * @returns the block number HEX string\n   */\n  public parseBlock(blockNumber: BlockNumber): string {\n    return this.web3.utils.toHex(blockNumber)\n  }\n\n  /**\n   * Decode parameters by ABI\n   * @param abi - the ABI\n   * @param params - the params encoded\n   * @returns the parameters\n   */\n  public decodeParams<T = any>(abi: any, params: string): Array<T> {\n    return Object.values(\n      this.web3.eth.abi.decodeParameters(abi, params)\n    ) as Array<T>\n  }\n\n  /**\n   * Extract data param into flag values\n   * @param params - the data params\n   * @returns the object with values\n   */\n  public extractDataParams(params: Web3DataParam[]): Web3DataParams {\n    return params.reduce<Web3DataParams>(\n      (acc, input) => ({\n        names: [...acc.names, input.name],\n        types: [\n          ...acc.types,\n          input.components\n            ? {\n                components: input.components,\n                type: input.type,\n              }\n            : input.type,\n        ],\n        values: [...acc.values, input.value],\n      }),\n      {\n        names: [],\n        types: [],\n        values: [],\n      }\n    )\n  }\n\n  /**\n   * Get ERC20 token info\n   * @param address token address\n   * @returns ERC20 info\n   */\n  public async getERC20(address: string): Promise<ERC20Token | undefined> {\n    if (!isAddress(address)) {\n      return\n    }\n    const contract = this.initContract(ERC20_ABI, address)\n    const methods = WEB3_CONTRACT_METHODS.filter((m) => m.type === 'ERC20')\n    const callData = methods.map((m) => makeWeb3CallData(contract, m))\n    const response = await this.call(callData)\n\n    return response.reduce(\n      (acc, callData) => {\n        const methodName = callData.method.split('(')[0]\n        switch (methodName) {\n          case 'symbol':\n          case 'name':\n          case 'decimals':\n            return {\n              ...acc,\n              [methodName]: callData.outputs[0].value,\n            }\n          default:\n            return acc\n        }\n      },\n      {\n        address,\n        decimals: 18,\n        symbol: '',\n        name: '',\n      }\n    )\n  }\n\n  /**\n   * Execute Web3 Call\n   * @param callData - the call params\n   * @param blockNumber - what block to use as the current state\n   * @returns the promise to use for load contract data\n   */\n  public async call(\n    callData: Web3CallData[],\n    blockNumber: BlockNumber = 'latest'\n  ): Promise<Web3CallData[]> {\n    if (\n      blockNumber !== 'latest' &&\n      BNlt(blockNumber, WEB3_MULTICALL_FIRST_BLOCK)\n    ) {\n      return await this.singleCalls(callData, blockNumber)\n    }\n\n    // Encode params\n    const requests = this.encodeCallsParams(callData)\n\n    // Execute multicalls\n    const responses = await this.web3.eth.call(\n      {\n        data: requests,\n        to: this.contractAddress,\n        from: this.contractAddress,\n      },\n      blockNumber\n    )\n\n    // Decode response\n    return this.decodeCallsResponse(responses, callData)\n  }\n\n  /**\n   * Perform single calls to blockchain\n   * @param callData calls data\n   * @param blockNumber block number\n   * @returns parsed data for passed calls\n   */\n  public async singleCalls(\n    callData: Web3CallData[],\n    blockNumber: BlockNumber = 'latest'\n  ): Promise<Web3CallData[]> {\n    const promises = callData.map((param: Web3CallData) => {\n      const request = this.parseCallParams(param)\n      return this.web3.eth\n        .call(\n          {\n            data: request.bytes,\n            to: request.address,\n            from: request.address,\n          },\n          blockNumber\n        )\n        .catch((err) => '')\n    }, [])\n\n    const responses = await Promise.all(promises)\n\n    return responses.map((response: string, i: number) => {\n      const success = !!response.length\n      return this.decodeCallResponse(success, response, callData[i])\n    })\n  }\n\n  /**\n   * Encode multi calls params\n   * @param callData - the list of the call data\n   * @returns the string encoded of the params\n   */\n  private encodeCallsParams(callData: Web3CallData[], limit?: number): string {\n    // Prepare call method\n    const methodEncoded = this.web3.utils\n      .keccak256(WEB3_MULTICALL_METHOD_ABI)\n      .substring(0, 10)\n\n    const callDataLimited = limit ? callData.slice(0, limit) : callData\n\n    // Prepare call params\n    const params = callDataLimited\n      .map((param) => this.parseCallParams(param))\n      .map((param) => [param.address, param.allowFailure, param.bytes])\n\n    const paramsEncoded = strip0x(\n      this.web3.eth.abi.encodeParameters(WEB3_MULTICALL_PARAM_ABI, [params])\n    )\n\n    return methodEncoded + paramsEncoded\n  }\n\n  /**\n   * Parse call parameters\n   * @param callData - the call data to parse\n   * @returns the call data keccak256 encoded string\n   */\n  private parseCallParams(callData: Web3CallData): Web3CallParam {\n    // Encode params\n    const { types, values } = this.extractDataParams(callData.inputs)\n\n    let params\n    try {\n      params = types.length\n        ? strip0x(this.web3.eth.abi.encodeParameters(types, values))\n        : ''\n    } catch (err) {\n      throw new Error(\n        `Error while encoding parameters types(${types.join(\n          ','\n        )}), values(${values.join(',')}) for method ${callData.method}`\n      )\n    }\n\n    // Encode method\n    const method = this.web3.utils.keccak256(callData.method).substring(0, 10)\n\n    return {\n      address: callData.address,\n      allowFailure: 1,\n      bytes: method + params,\n    }\n  }\n\n  /**\n   * Decode multicall response\n   * @param response - the call encoded response\n   */\n  private decodeCallsResponse(\n    encodedResponses: string,\n    requests: Web3CallData[]\n  ) {\n    // Decode response\n    const res = this.decodeParams<\n      Array<{\n        0: boolean\n        1: string\n      }>\n    >(WEB3_MULTICALL_RESPONSE_ABI, encodedResponses)\n\n    if (!res.length || !res[0]) {\n      throw new Error('Response method not available')\n    }\n\n    // Parse responses based of requests\n    const responses = res[0]\n\n    return responses.map((r, i) => {\n      const response = responses[i]\n      return this.decodeCallResponse(response[0], response[1], requests[i])\n    })\n  }\n\n  /**\n   * Decode single call response\n   * @param success - True if it's ok\n   * @param response - the response encoded\n   * @param request - the request object\n   * @returns the callData object\n   */\n  private decodeCallResponse(\n    success: boolean,\n    response: string,\n    request: Web3CallData\n  ): Web3CallData {\n    // Return empty output if not succeded\n    if (!success) {\n      return request\n    }\n\n    const { types } = this.extractDataParams(request.outputs)\n\n    try {\n      const values = this.decodeParams(types, response)\n      // Parse response values\n      return {\n        ...request,\n        outputs: request.outputs.map((output, i) => ({\n          ...output,\n          value: values[i],\n        })),\n      }\n    } catch (err) {\n      this.logger?.error({ request, types, response }, 'Decode Error')\n      return request\n    }\n  }\n}\n"],"names":["Web3Client","initContract","abi","address","web3","eth","Contract","createTopic","topicType","argument","utils","sha3","getTransaction","hash","isTxHash","getTransactionLogs","receipt","getTransactionReceipt","logs","getBlock","blockNumber","getContractEvents","contract","eventType","startBlock","endBlock","filters","maxBlocks","number","BNlt","totalBlocks","BigNumber","maximum","BNify","minus","logger","debug","options","fromBlock","toBlock","minimum","plus","pastEvents","retry","events","getPastEvents","parseBlock","toNumber","length","error","toHex","decodeParams","params","Object","values","decodeParameters","extractDataParams","reduce","acc","input","names","name","types","components","type","value","getERC20","isAddress","ERC20_ABI","methods","WEB3_CONTRACT_METHODS","filter","m","callData","map","makeWeb3CallData","response","call","methodName","method","split","outputs","decimals","symbol","WEB3_MULTICALL_FIRST_BLOCK","singleCalls","requests","encodeCallsParams","responses","data","to","contractAddress","from","decodeCallsResponse","promises","param","request","parseCallParams","bytes","catch","err","Promise","all","i","success","decodeCallResponse","limit","methodEncoded","keccak256","WEB3_MULTICALL_METHOD_ABI","substring","callDataLimited","slice","allowFailure","paramsEncoded","strip0x","encodeParameters","WEB3_MULTICALL_PARAM_ABI","inputs","Error","join","encodedResponses","res","WEB3_MULTICALL_RESPONSE_ABI","r","output","constructor","provider","WEB3_MULTICALL_CONTRACT_ADDR","blocksPerYear","WEB3_DEFAULT_BLOCK_PER_YEAR"],"mappings":"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"}