{"version":3,"sources":["../../../../../../../libs/shared/data-access/src/lib/web3-client/web3-client.lib.ts"],"sourcesContent":["import Web3, { PayableCallOptions, WebSocketProvider, HttpProvider } from 'web3'\nimport { PayableMethodObject } from 'web3-eth-contract'\nimport BigNumber from 'bignumber.js'\nimport {\n  Web3TransactionFee,\n  Web3PayableOptionsParams,\n  Web3Provider,\n  Web3ProviderConnection,\n  Web3RPCProvider,\n  Web3Tokens,\n} from './web3-client.model'\nimport { BNify } from '../core'\n\n/**\n * Get Web3 Https Provider\n * @param providers - the web3 providers\n * @param tokens - the provider tokens\n * @returns the Web3 provider data\n */\nexport function getWeb3HttpsProvider(\n  providers: Web3ProviderConnection[],\n  tokens: Web3Tokens\n): Web3Provider {\n  const connection = providers.find((c) => !!c.https)\n\n  if (!connection?.https) {\n    throw new Error(`No HTTPS provider available`)\n  }\n\n  // Get web3 provider\n  const { provider, https } = connection\n  const token = getWeb3ProviderToken(provider, tokens)\n  const web3Provider = new HttpProvider(https + token)\n  const web3 = new Web3(web3Provider)\n\n  return {\n    provider,\n    web3,\n  }\n}\n\n/**\n * Get Web3 Socket Provider\n * @param providers - the web3 providers\n * @param tokens - the provider tokens\n * @returns the Web3 provider data\n */\nexport async function getWeb3SocketProvider(\n  providers: Web3ProviderConnection[],\n  tokens: Web3Tokens\n): Promise<Web3Provider> {\n  for (const connection of providers) {\n    try {\n      const provider = await getSocketProvider(connection, tokens)\n      return provider\n    } catch (error) {\n      continue\n    }\n  }\n\n  throw new Error(`No WSS provider available`)\n}\n\nasync function getSocketProvider(\n  { wss, provider }: Web3ProviderConnection,\n  tokens: Web3Tokens\n): Promise<Web3Provider> {\n  if (!wss) {\n    throw new Error(`No WSS provider available`)\n  }\n\n  // Get web3 provider\n  const token = getWeb3ProviderToken(provider, tokens)\n  const web3Provider = new WebSocketProvider(\n    wss + token,\n    {},\n    {\n      delay: 500,\n      autoReconnect: true,\n      maxAttempts: 10000,\n    }\n  )\n  const web3 = new Web3(web3Provider)\n\n  // Check connection\n  const networkId = await Promise.race([\n    web3.eth.net.getId(),\n    new Promise(function (resolve, reject) {\n      setTimeout(function () {\n        reject('Timeout')\n      }, 2000)\n    }),\n  ])\n\n  if (!networkId) {\n    throw new Error(`WSS unreachable ${wss}`)\n  }\n\n  return {\n    web3,\n    provider,\n  }\n}\n\n/**\n * Get Web3 provider token\n * @param provider - the provider\n * @param tokens - the provider tokens\n * @returns the token string\n */\nexport function getWeb3ProviderToken(\n  provider: Web3RPCProvider,\n  tokens: Web3Tokens\n): string {\n  let token\n  switch (provider) {\n    case 'INFURA':\n      token = tokens.INFURA\n      break\n    case 'ALCHEMY':\n      token = tokens.ALCHEMY\n      break\n    case 'PUBLIC':\n      return ''\n    default:\n      break\n  }\n\n  if (!token) {\n    throw new Error('Token provider not provided')\n  }\n\n  return token\n}\n\n/**\n * Get Web3 Payable Options\n * @param web3\n * @param walletAddress\n * @returns the payable options to use for wallet transactions\n */\nexport async function getWeb3PaypableOptions(\n  web3: Web3,\n  { method, from, value, toleranceBearing = 5 }: Web3PayableOptionsParams\n): Promise<PayableCallOptions> {\n  // Get GAS info for the method call\n  const chainID = await web3.eth.getChainId()\n  const gas = await getWeb3GasLimit(method, { from }, toleranceBearing).catch(\n    () => undefined\n  )\n\n  /* const { maxFeePerGas, maxPriorityFeePerGas, gasPrice } = await getWeb3FeeData(\n    web3\n  ) */\n\n  // MainNET check\n  if (chainID === 1n) {\n    return {\n      from,\n      gas,\n      value,\n    }\n  }\n\n  // Pass only the GAS PRICE\n  return {\n    /**\n     * The address transaction should be made from\n     */\n    from,\n    /**\n     * The maximum gas provided for a transaction (gas limit).\n     */\n    gas,\n    /**\n     * The gas price in WEI to use for transactions.\n     * Not necessary if maxFeePerGas is passed\n     */\n    // gasPrice,\n    value,\n  }\n}\n\n/**\n * Get Web3 Gas Limit\n * @param method - the method to simulate for the gas estimation\n * @param callOptions - the call options\n * @param toleranceBearing - the tolerance bearing percentage to add to the estimation\n * @param minGasLimit - the minimum gas limit\n * @returns the gas limit of the method to call\n */\nexport async function getWeb3GasLimit(\n  method: PayableMethodObject,\n  callOptions: PayableCallOptions = {},\n  toleranceBearing = 0,\n  minGasLimit = 0\n): Promise<string> {\n  /**\n   * Here try to estimate the GAS Limit\n   */\n  const gas = await method.estimateGas(callOptions)\n  let gasLimit = BigNumber.maximum(BNify(gas), BNify(minGasLimit))\n\n  // Add tolerance percentage bearing if necessary\n  if (toleranceBearing > 0) {\n    const tolerancePercentage = BNify(toleranceBearing).div(100)\n    gasLimit = gasLimit.plus(gasLimit.times(tolerancePercentage))\n  }\n\n  return gasLimit.integerValue(BigNumber.ROUND_FLOOR).toString()\n}\n\n/**\n * Get Web3 Transaction Gas price\n * @param web3 - the web3 instance\n * @returns the gas price to use for transaction\n */\nexport async function getWeb3FeeData(web3: Web3) {\n  const { gasPrice, maxFeePerGas, maxPriorityFeePerGas, baseFeePerGas } =\n    await web3.eth.calculateFeeData()\n\n  return {\n    gasPrice: gasPrice?.toString(),\n    maxFeePerGas: maxFeePerGas?.toString(),\n    maxPriorityFeePerGas: maxPriorityFeePerGas?.toString(),\n    baseFeePerGas: baseFeePerGas?.toString(),\n  }\n}\n\n/**\n * Get Web3 Gas Price\n * @param web3 - the web3 instance\n * @returns the gas price to use for transaction\n */\nexport async function getWeb3GasPrice(web3: Web3) {\n  const gasPrice = await web3.eth.getGasPrice()\n  return BNify(gasPrice).div(1e9)\n}\n\n/**\n * Get web3 transaction fee\n * @param web3 - the web3 instance\n * @param method - the payable method\n * @param walletAddress - the wallet address\n * @param ETHPrice - the ETH Price\n * @returns\n */\nexport async function getWeb3TransactionFee(\n  web3: Web3,\n  method: PayableMethodObject,\n  walletAddress: string,\n  options: {\n    ETHPrice?: string\n    toleranceBearing?: number\n  } = {}\n): Promise<Web3TransactionFee> {\n  const { ETHPrice, toleranceBearing = 5 } = options\n\n  // Load gas prices\n  const gasPrice = await web3.eth.getGasPrice()\n  const gasLimit = await getWeb3GasLimit(\n    method,\n    { from: walletAddress },\n    toleranceBearing\n  )\n  const gasETH = BNify(gasLimit).times(BNify(gasPrice)).div(1e18)\n  const gasUSD = ETHPrice ? gasETH.times(ETHPrice || 0) : undefined\n\n  return {\n    ETH: gasETH.toString(),\n    USD: gasUSD?.toString(),\n  }\n}\n"],"names":["getWeb3FeeData","getWeb3GasLimit","getWeb3GasPrice","getWeb3HttpsProvider","getWeb3PaypableOptions","getWeb3ProviderToken","getWeb3SocketProvider","getWeb3TransactionFee","providers","tokens","connection","find","c","https","Error","provider","token","web3Provider","HttpProvider","web3","Web3","getSocketProvider","error","wss","WebSocketProvider","delay","autoReconnect","maxAttempts","networkId","Promise","race","eth","net","getId","resolve","reject","setTimeout","INFURA","ALCHEMY","method","from","value","toleranceBearing","chainID","getChainId","gas","catch","undefined","callOptions","minGasLimit","estimateGas","gasLimit","BigNumber","maximum","BNify","tolerancePercentage","div","plus","times","integerValue","ROUND_FLOOR","toString","gasPrice","maxFeePerGas","maxPriorityFeePerGas","baseFeePerGas","calculateFeeData","getGasPrice","walletAddress","options","ETHPrice","gasETH","gasUSD","ETH","USD"],"mappings":"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"}