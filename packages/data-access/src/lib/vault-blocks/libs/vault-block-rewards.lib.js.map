{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/vault-blocks/libs/vault-block-rewards.lib.ts"],"sourcesContent":["import BigNumber from 'bignumber.js'\nimport { BNFixed, BNify, compLower, iBigInt } from '../../core'\nimport {\n  VaultContractData,\n  VaultContractTokenData,\n  VaultContractType,\n  VaultRewardProgram,\n  VaultRewardProgramFrequency,\n} from '../../vaults'\nimport {\n  RewardToken,\n  VaultBlockAPRs,\n  VaultBlockRewardProgram,\n} from '../vault-block.model'\nimport { compoundVaultApr } from './vault-block.lib'\n\n/**\n * Get distribution frequency in days\n * @param frequency frequency params\n * @returns distribution frequency in days\n */\nexport function getDistributionFrequencyInDays(\n  frequency: VaultRewardProgramFrequency\n): number {\n  switch (frequency.unit) {\n    case 'D':\n      return frequency.value\n    case 'W':\n      return frequency.value * 7\n    case 'M':\n      return frequency.value * 30\n    case 'Y':\n      return frequency.value * 365\n    default:\n      throw new Error(`Unsupported frequency unit: ${frequency.unit}`)\n  }\n}\n\n/**\n * Get reward program AMOUNT\n * @param rewardProgram reward program\n * @param options tvl and tokenPrice\n * @returns reward program AMOUNT data\n */\nexport function calculateRewardProgramAmount(\n  rewardProgram: VaultRewardProgram,\n  options?: {\n    tvlUSD?: iBigInt\n    tokenPrice?: iBigInt\n  }\n) {\n  const { tokenPrice, tvlUSD } = options || {}\n  const tokenPriceUSD = BNify(tokenPrice || '1000000')\n  const distributionInDays = getDistributionFrequencyInDays(\n    rewardProgram.distributionFrequency\n  )\n  const distributionPeriod = BNify(365).div(distributionInDays)\n\n  if (BNify(tvlUSD).lte(0)) {\n    return {\n      APR: 0,\n    }\n  }\n\n  const USD = BNify(rewardProgram.distributionValue)\n    .times(tokenPriceUSD)\n    .times(distributionPeriod)\n\n  const APR = Number(BNFixed(USD.div(BNify(tvlUSD)).times(100), 8))\n\n  return {\n    APR,\n    USD: BNFixed(USD),\n  }\n}\n\n/**\n * Get reward program TARGET_APY\n * @param rewardProgram reward program\n * @param APRs vault interest rates\n * @returns reward program TARGET_APY data\n */\nexport function calculateRewardProgramTargetApy(\n  rewardProgram: VaultRewardProgram,\n  baseAPY: number\n) {\n  const APR = Number(\n    BNFixed(\n      BigNumber.maximum(\n        0,\n        BNify(rewardProgram.distributionValue).minus(BNify(baseAPY))\n      ),\n      8\n    )\n  )\n  return {\n    APR,\n  }\n}\n\n/**\n * Get Reward program APR\n * @param APRs Vault block APRs\n * @param rewardProgram reward program object\n * @returns Reward program APR\n */\nexport function makeVaultBlockRewardProgram(\n  rewardProgram: VaultRewardProgram,\n  APRs: VaultBlockAPRs,\n  options?: {\n    tvlUSD?: iBigInt\n    tokenPrice?: iBigInt\n    feePercentage?: number\n    vaultContractType?: VaultContractType\n    epochDuration?: number\n  }\n): {\n  APR: number\n  USD?: iBigInt\n} {\n  // Return 0 if reward program is not active\n  if (!rewardProgram.isActive) {\n    return {\n      APR: 0,\n    }\n  }\n\n  switch (rewardProgram.distributionType) {\n    // Calculate APR by annualized distributed tokens\n    case 'AMOUNT':\n      return calculateRewardProgramAmount(rewardProgram, options)\n    // Target APR - Base APR\n    case 'TARGET_APY': {\n      const { vaultContractType, epochDuration, feePercentage } = options || {}\n      if (!vaultContractType) {\n        throw Error(\n          `VaultContractType not specified for TARGET_APY calculation`\n        )\n      }\n      // Calculate NET APR\n      const netAPR = Number(\n        BNify(APRs.BASE).times(BNify(1).minus(BNify(feePercentage).div(1e5)))\n      )\n      const netAPY = compoundVaultApr(\n        vaultContractType,\n        'BASE',\n        netAPR,\n        epochDuration\n      )\n      return calculateRewardProgramTargetApy(rewardProgram, netAPY)\n    }\n  }\n}\n\n/**\n * Get vault cumulative reward programs APR\n * @param vault vault entity\n * @param vaultData vault contract data\n * @param APRs APRs\n * @param tvlUSD TVL USD\n * @param rewardTokens reward tokens entities\n * @returns cumulative vault reward programs APR\n */\nexport function getVaultRewardProgramsApr(\n  vaultData: VaultContractData,\n  APRs: VaultBlockAPRs,\n  options: {\n    tvlUSD?: iBigInt\n    feePercentage?: number\n    rewardTokens?: RewardToken[]\n    rewardPrograms?: VaultRewardProgram[]\n    vaultContractType?: VaultContractType\n  } = {}\n): number {\n  const vaultBlockRewardPrograms = getVaultBlockRewardPrograms(\n    vaultData,\n    APRs,\n    options\n  )\n  if (!vaultBlockRewardPrograms) {\n    return 0\n  }\n\n  return vaultBlockRewardPrograms?.reduce((acc: number, rewardProgram) => {\n    return BNify(acc).plus(rewardProgram.APR).toNumber()\n  }, 0)\n}\n\n/**\n * Get APRs for each reward program\n * @param vault vault entity\n * @param vaultData vault contract data\n * @param APRs vault APRs\n * @param options system options\n * @returns APR for each reward program\n */\nexport function getVaultBlockRewardPrograms(\n  vaultData: VaultContractData,\n  APRs: VaultBlockAPRs,\n  options: {\n    tvlUSD?: iBigInt\n    feePercentage?: number\n    rewardTokens?: RewardToken[]\n    rewardPrograms?: VaultRewardProgram[]\n    vaultContractType?: VaultContractType\n  } = {}\n): VaultBlockRewardProgram[] | undefined {\n  const { rewardPrograms } = options\n\n  if (!rewardPrograms?.length) {\n    return\n  }\n\n  const epochDuration = vaultData.cdoEpoch?.duration\n\n  // Get vault block reward programs\n  return rewardPrograms.map(\n    (rewardProgram) =>\n      getVaultBlockRewardProgram(rewardProgram, APRs, {\n        ...options,\n        tokens: vaultData.tokens,\n        epochDuration,\n      }),\n    []\n  )\n}\n\n/**\n * Get vault block reward program\n * @param rewardProgram vault reward program\n * @param APRs vault APRs\n * @param options tvl, reward tokens entities, tokens contract data\n * @returns vault block reward program\n */\nexport function getVaultBlockRewardProgram(\n  rewardProgram: VaultRewardProgram,\n  APRs: VaultBlockAPRs,\n  options?: {\n    tvlUSD?: iBigInt\n    feePercentage?: number\n    rewardTokens?: RewardToken[]\n    tokens?: VaultContractTokenData[]\n    vaultContractType?: VaultContractType\n    epochDuration?: number\n  }\n): VaultBlockRewardProgram {\n  const {\n    tokens,\n    tvlUSD,\n    rewardTokens,\n    vaultContractType,\n    epochDuration,\n    feePercentage,\n  } = options || {}\n\n  const token = rewardTokens?.find(\n    (token) => token._id === rewardProgram.tokenId\n  )\n\n  // Throw error if no token found for this program\n  if (!token) {\n    throw Error(\n      `Token not found for reward program (tokenId: ${rewardProgram.tokenId})`\n    )\n  }\n\n  const tokenData = tokens?.find((t) => compLower(t.address, token.address))\n\n  const rewardProgramData = makeVaultBlockRewardProgram(rewardProgram, APRs, {\n    tvlUSD,\n    tokenPrice: tokenData?.price,\n    vaultContractType,\n    epochDuration,\n    feePercentage,\n  })\n\n  return {\n    tokenId: rewardProgram.tokenId,\n    ...rewardProgramData,\n  }\n}\n"],"names":["calculateRewardProgramAmount","calculateRewardProgramTargetApy","getDistributionFrequencyInDays","getVaultBlockRewardProgram","getVaultBlockRewardPrograms","getVaultRewardProgramsApr","makeVaultBlockRewardProgram","frequency","unit","value","Error","rewardProgram","options","tokenPrice","tvlUSD","tokenPriceUSD","BNify","distributionInDays","distributionFrequency","distributionPeriod","div","lte","APR","USD","distributionValue","times","Number","BNFixed","baseAPY","BigNumber","maximum","minus","APRs","isActive","distributionType","vaultContractType","epochDuration","feePercentage","netAPR","BASE","netAPY","compoundVaultApr","vaultData","vaultBlockRewardPrograms","reduce","acc","plus","toNumber","rewardPrograms","length","cdoEpoch","duration","map","tokens","rewardTokens","token","find","_id","tokenId","tokenData","t","compLower","address","rewardProgramData","price"],"mappings":"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"}