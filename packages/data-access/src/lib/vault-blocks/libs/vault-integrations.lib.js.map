{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/vault-blocks/libs/vault-integrations.lib.ts"],"sourcesContent":["import type { SharedLogger } from '../../core'\nimport { BNify } from '../../core'\nimport { IntegrationClient } from '../../integrations/integrations-client.lib'\nimport { VaultIntegration, VaultIntegrationsData } from '../../vaults'\nimport { VaultBlockCdo } from '../vault-block.model'\n\nexport interface VaultIntegrationOptions {\n  chainId?: number\n  tokenSymbol?: string\n  vaultType?: string\n  cdoData?: VaultBlockCdo\n  blockNumber?: number\n  logger?: SharedLogger\n}\n\n/**\n * Get vault integrations data\n * @param integrations vault integrations\n * @returns vault integrations data\n */\nexport async function getVaultIntegrationsData(\n  integrations: VaultIntegration[],\n  options?: VaultIntegrationOptions\n): Promise<VaultIntegrationsData> {\n  const { tokenSymbol, vaultType, cdoData, blockNumber, logger } = options || {}\n\n  const integrationsData: VaultIntegrationsData = {}\n\n  for (const integration of integrations) {\n    const client = new IntegrationClient(integration.provider)\n\n    switch (integration.type) {\n      case 'APR':\n        {\n          if (!tokenSymbol) {\n            throw new Error(\n              `Integration Error: TokenSymbol required but not specified (provider: ${integration.provider}, type: ${integration.type})`\n            )\n          }\n          if (!vaultType) {\n            throw new Error(\n              `Integration Error: vaultType not specified (provider: ${integration.provider}, type: ${integration.type})`\n            )\n          }\n\n          const APR = await client.getApr(tokenSymbol)\n\n          // Get splitted APR for tranches\n          if (['AA', 'BB'].includes(vaultType)) {\n            if (!cdoData?.currentAARatio || !cdoData?.APRSplitRatio) {\n              throw new Error(\n                `Integration Error: Missing or empty cdoData (provider: ${integration.provider}, type: ${integration.type})`\n              )\n            }\n            integrationsData.APR = getTrancheApr(APR, vaultType, cdoData)\n          } else {\n            integrationsData.APR = APR\n          }\n        }\n        break\n      case 'repoTokenHolders':\n        {\n          const collateralToken = integration.params?.collateralToken\n          if (!collateralToken) {\n            throw new Error(\n              `Integration Error: Missing collateralToken (provider: ${integration.provider}, type: ${integration.type})`\n            )\n          }\n\n          try {\n            const repoTokenHolders = await client.getRepoTokensHolders({\n              collateralToken,\n              blockNumber,\n            })\n\n            if (repoTokenHolders?.length) {\n              integrationsData.repoTokenHolders = [\n                ...(integrationsData.repoTokenHolders ?? []),\n                ...repoTokenHolders,\n              ]\n            }\n          } catch (error) {\n            logger?.error?.(\n              `Integration Error: Failed to fetch repoTokenHolders (provider: ${integration.provider}, type: ${integration.type}): ${error}`\n            )\n          }\n        }\n        break\n    }\n  }\n  return integrationsData\n}\n\n/**\n * Get tranche APR depending on tranche split ratio\n * @param strategyApr base strategy APR\n * @param trancheType AA | BB\n * @param cdoData cdo data from contract\n * @returns tranche APR\n */\nexport function getTrancheApr(\n  strategyApr: number,\n  trancheType: string,\n  cdoData: VaultBlockCdo\n): number {\n  const { currentAARatio, APRSplitRatio } = cdoData\n  if (!currentAARatio || !APRSplitRatio) {\n    return 0\n  }\n\n  const FULL_ALLOC = BNify(100000)\n  const isAATranche = trancheType === 'AA'\n\n  if (BNify(currentAARatio).eq(0)) {\n    return isAATranche ? 0 : strategyApr\n  }\n\n  if (BNify(strategyApr).isNaN()) {\n    return 0\n  }\n\n  const apr = isAATranche\n    ? BNify(strategyApr).times(APRSplitRatio).div(currentAARatio)\n    : BNify(strategyApr)\n        .times(FULL_ALLOC.minus(APRSplitRatio))\n        .div(BNify(FULL_ALLOC).minus(currentAARatio))\n  return apr.toNumber()\n}\n"],"names":["getTrancheApr","getVaultIntegrationsData","integrations","options","tokenSymbol","vaultType","cdoData","blockNumber","logger","integrationsData","integration","client","IntegrationClient","provider","type","Error","APR","getApr","includes","currentAARatio","APRSplitRatio","collateralToken","params","repoTokenHolders","getRepoTokensHolders","length","error","strategyApr","trancheType","FULL_ALLOC","BNify","isAATranche","eq","isNaN","apr","times","div","minus","toNumber"],"mappings":"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"}