{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/vaults/classes/vault-pareto-dollar.class.ts"],"sourcesContent":["import { ContractAbi } from 'web3'\nimport { BlockNumber, BNFixed, compLower } from '../../core'\nimport { Token } from '../../tokens'\nimport { Web3CallData } from '../../web3-client'\nimport {\n  Vault,\n  VaultContractData,\n  VaultContractModel,\n  VaultContractOptions,\n  VaultContractPoolData,\n  VaultNonPayableMethodOptions,\n  VaultNonPayableMethodType,\n  VaultPool,\n  VaultPoolOracle,\n} from '../vault.model'\nimport { VaultContract } from './vault-contract.class'\nimport { VaultBlockParetoDollarYieldSource } from '../../vault-blocks'\nimport { getEulerSubAccounts } from '../../integrations/euler-client/euler.lib'\nimport { ensureAbi } from '../libs/vault-web3.lib'\nimport { uniq } from 'lodash'\nimport { ERC20_ABI } from '../abis'\n\nexport class VaultParetoDollar\n  extends VaultContract\n  implements VaultContractModel\n{\n  constructor(vault: Vault, token: Token, options?: VaultContractOptions) {\n    super(vault, token, options)\n  }\n\n  /**\n   * Get contract data\n   * @returns the blockchain contract data\n   */\n  public async getContractData(\n    blockNumber: BlockNumber = 'latest'\n  ): Promise<VaultContractData> {\n    const callData = this.makeCallData(blockNumber)\n    let contractData = await this.getData(callData, blockNumber)\n\n    const [tokensData, additionalData] = await Promise.all([\n      this.getPoolsTokensData(contractData),\n      this.getAdditionalData(blockNumber, contractData),\n    ])\n\n    // Implement pools with tokens data\n    const pools = contractData.pools\n      ? this.implementPoolsTokensData(contractData.pools, tokensData)\n      : undefined\n\n    // Implements wallets with Euler data\n    const wallets =\n      contractData.wallets && additionalData.wallets\n        ? this.implementWalletsData(\n            contractData.wallets,\n            additionalData.wallets\n          )\n        : contractData.wallets\n\n    contractData = {\n      ...contractData,\n      pools,\n      wallets,\n      paretoDollar: {\n        ...contractData.paretoDollar,\n        queue: {\n          ...(contractData.paretoDollar?.queue || {}),\n          ...(additionalData.paretoDollar?.queue || {}),\n        },\n      },\n    }\n\n    return this.parseContractData(contractData)\n  }\n\n  /**\n   * Get Euler vaults data for each wallet\n   * @param blockNumber block number\n   * @param contractData main contract data\n   * @returns euler vaults data\n   */\n  protected getEulerWalletsCalls(): Web3CallData[] {\n    const eulerPool = this.vault.pools?.find((p) => p.protocol === 'Euler')\n    const accountLensContract = eulerPool?.oracle\n    if (!this.web3Client || !accountLensContract) {\n      return []\n    }\n\n    // Get all subaccounts for all other wallets\n    const allSubAccounts = uniq(\n      (this.walletAddresses || [])\n        .flatMap((walletAddr) =>\n          getEulerSubAccounts(walletAddr).filter(\n            (subAddr) => !compLower(subAddr, walletAddr)\n          )\n        )\n        .map((subAddr) => subAddr.toLowerCase())\n    )\n\n    return this.makeEulerVaultsCalls(\n      allSubAccounts,\n      eulerPool,\n      accountLensContract\n    )\n  }\n\n  private makeEulerVaultsCalls(\n    subAccounts: string[],\n    pool: VaultPool,\n    accountLensContract: VaultPoolOracle\n  ): Web3CallData[] {\n    const { abi: oracleAbi, abiCode, address } = accountLensContract\n    const abi = ensureAbi({ abi: oracleAbi, abiCode })\n    const contract = {\n      abi,\n      address,\n      protocol: pool.protocol,\n    }\n\n    return subAccounts.reduce((acc: Web3CallData[], subAccount) => {\n      const callsData = this.makeProtocolData(\n        contract,\n        'WALLET_EULER_ACCOUNT_LENS',\n        undefined,\n        {\n          walletAddress: subAccount,\n          poolAddress: pool.address,\n        },\n        {\n          address: pool.address,\n          protocol: pool.protocol,\n          type: 'WALLET_EULER_ACCOUNT_LENS',\n        }\n      )\n      return [...acc, ...callsData]\n    }, [])\n  }\n\n  /**\n   * Parse Cdo epoch raw contract data\n   * @param contractData Cdo Epoch contract raw data\n   * @returns Parsed Cdo Epoch contract data\n   */\n  protected parseContractData(\n    contractData: VaultContractData\n  ): VaultContractData {\n    return {\n      ...contractData,\n      pools: contractData.pools\n        ? this.parsePools(contractData.pools)\n        : contractData.pools,\n    }\n  }\n\n  /**\n   * Include napierPT pool tokens into napierYT pool\n   * @param pools\n   * @returns parsed pools\n   */\n  protected parsePools(\n    pools: VaultContractPoolData[]\n  ): VaultContractPoolData[] {\n    return pools.map((p) => {\n      switch (p.protocol) {\n        case 'NapierYT': {\n          const napierPTPool = pools.find(\n            (pool) => pool.protocol === 'NapierPT'\n          )\n          return {\n            ...p,\n            tokensInfo: napierPTPool?.tokensInfo,\n          }\n        }\n        default:\n          return p\n      }\n    })\n  }\n\n  /**\n   * Get additional data from queue contract\n   * @param blockNumber block number\n   * @param contractData main contract data\n   * @returns vault contract data\n   */\n  private async getAdditionalData(\n    blockNumber: BlockNumber = 'latest',\n    contractData: VaultContractData\n  ): Promise<VaultContractData> {\n    const eulerWalletCalls = this.getEulerWalletsCalls()\n    const yieldSourceCalls = this.getQueueYieldSourcesCalls(contractData)\n    const epochPendingCalls = this.getQueueEpochPendingCalls(contractData)\n    const callData = [\n      ...eulerWalletCalls,\n      ...yieldSourceCalls,\n      ...epochPendingCalls,\n    ]\n    return await this.getData(callData, blockNumber, { current: contractData })\n  }\n\n  /**\n   * Get contract data from queue contract\n   * @param blockNumber block number\n   * @param contractData main contract data\n   * @returns queue contract data\n   */\n  private getQueueYieldSourcesCalls(\n    contractData: VaultContractData\n  ): Web3CallData[] {\n    if (!contractData.paretoDollar?.queue?.yieldSources?.length) {\n      return []\n    }\n\n    const yieldSources = contractData.paretoDollar.queue.yieldSources\n\n    return yieldSources.reduce(\n      (acc: Web3CallData[], yieldSource) => [\n        ...acc,\n        ...this.makeYieldSourceData(yieldSource),\n      ],\n      []\n    )\n  }\n\n  /**\n   * Prepare call data for deposit queue\n   * @param contractData processed contract data\n   * @returns deposit queue call data\n   */\n  private makeYieldSourceData(\n    yieldSource: VaultBlockParetoDollarYieldSource\n  ): Web3CallData[] {\n    if (!this.vault.paretoDollar?.queue) {\n      return []\n    }\n\n    const { abi: queueAbi, abiCode, address } = this.vault.paretoDollar.queue\n    const abi = ensureAbi({ abi: queueAbi, abiCode })\n    const queueContract = {\n      abi,\n      address,\n      protocol: this.vault.protocol,\n    }\n\n    return this.makeProtocolData(\n      queueContract,\n      'PARETO_DOLLAR_QUEUE_YIELD_SOURCE',\n      undefined,\n      {\n        yieldSourceAddress: yieldSource.sourceAddress,\n      }\n    )\n  }\n\n  /**\n   * Get contract data from queue contract\n   * @param blockNumber block number\n   * @param contractData main contract data\n   * @returns queue contract data\n   */\n  private getQueueEpochPendingCalls(\n    contractData: VaultContractData\n  ): Web3CallData[] {\n    if (\n      !contractData.paretoDollar?.queue?.epochNumber ||\n      isNaN(Number(contractData.paretoDollar.queue.epochNumber))\n    ) {\n      return []\n    }\n\n    const epochNumber = Number(contractData.paretoDollar.queue.epochNumber)\n    const prevEpochNumber = Math.max(0, epochNumber - 1)\n\n    // Get deposit queue data using epochNumber\n    return this.makeQueuePendingEpochData(epochNumber, prevEpochNumber)\n  }\n\n  /**\n   * Prepare call data for deposit queue\n   * @param contractData processed contract data\n   * @returns deposit queue call data\n   */\n  private makeQueuePendingEpochData(\n    epochNumber: number,\n    prevEpochNumber: number\n  ): Web3CallData[] {\n    if (!this.vault.paretoDollar?.queue) {\n      return []\n    }\n\n    const { abi: queueAbi, abiCode, address } = this.vault.paretoDollar.queue\n    const abi = ensureAbi({ abi: queueAbi, abiCode })\n    const queueContract = {\n      abi,\n      address,\n      protocol: this.vault.protocol,\n    }\n\n    return this.makeProtocolData(\n      queueContract,\n      'PARETO_DOLLAR_QUEUE_EPOCH_PENDING',\n      undefined,\n      {\n        epochNumber,\n        prevEpochNumber,\n      }\n    )\n  }\n\n  /**\n   * Prepare call data\n   * @returns the web3 call data\n   */\n  protected makeCallData(blockNumber?: BlockNumber): Web3CallData[] {\n    // Parse vault contract methods\n    const {\n      abi: vaultAbi,\n      abiCode,\n      address,\n      protocol,\n      contractType,\n    } = this.vault\n    const abi = ensureAbi({ abi: vaultAbi, abiCode })\n    let callData = this.makeProtocolData(\n      { abi, address, protocol },\n      contractType\n    )\n\n    const { paretoDollar } = this.vault\n\n    // Make calls for queue contract\n    if (paretoDollar?.queue) {\n      const queueAbi = ensureAbi({\n        abi: paretoDollar.queue.abi,\n        abiCode: paretoDollar.queue.abiCode,\n      })\n      callData = [\n        ...callData,\n        ...this.makeProtocolData(\n          {\n            abi: queueAbi,\n            address: paretoDollar.queue.address,\n            protocol: this.vault.protocol,\n          },\n          'PARETO_DOLLAR_QUEUE'\n        ),\n      ]\n    }\n\n    // Make calls for staking contract\n    if (paretoDollar?.staking) {\n      const stakingAbi = ensureAbi({\n        abi: paretoDollar.staking.abi,\n        abiCode: paretoDollar.staking.abiCode,\n      })\n      callData = [\n        ...callData,\n        ...this.makeProtocolData(\n          {\n            abi: stakingAbi,\n            address: paretoDollar.staking.address,\n            protocol: this.vault.protocol,\n          },\n          'PARETO_DOLLAR_STAKING'\n        ),\n      ]\n\n      if (this.walletAddresses) {\n        // Add staking contract\n        callData = this.walletAddresses.reduce(\n          (acc, walletAddress) => [\n            ...acc,\n            ...this.makeProtocolData(\n              {\n                abi: stakingAbi,\n                address: paretoDollar.staking.address,\n                protocol: this.vault.protocol,\n              },\n              'WALLET_PARETO_DOLLAR_STAKING',\n              undefined,\n              {\n                walletAddress,\n              }\n            ),\n          ],\n          [...callData]\n        )\n      }\n    }\n\n    // Parse wallet methods\n    if (this.walletAddresses) {\n      callData = this.walletAddresses.reduce(\n        (acc, walletAddress) => [\n          ...acc,\n          ...this.makeWalletData(walletAddress, { abi, address, protocol }),\n        ],\n        [...callData]\n      )\n    }\n\n    // Parse token methods\n    if (this.token.oracle) {\n      callData = [\n        ...callData,\n        ...this.makeProtocolData(this.token.oracle, 'ORACLE', this.token),\n      ]\n    }\n\n    // Parse vault pools methods\n    if (this.vault.pools) {\n      callData = this.vault.pools.reduce(\n        (acc, pool) => [...acc, ...this.makePoolData(pool, blockNumber)],\n        [...callData]\n      )\n    }\n\n    return callData\n  }\n\n  /**\n   * Get vault non payable method\n   * @param type\n   * @param params\n   */\n  public getValue(\n    type: VaultNonPayableMethodType,\n    options?: VaultNonPayableMethodOptions\n  ): Promise<any> {\n    try {\n      switch (type) {\n        case 'IS_WALLET_ALLOWED':\n          return this.isWalletAllowed(options)\n        case 'TOKEN_BALANCE':\n          return this.getTokenBalance(options)\n        case 'TOKEN_ALLOWANCE':\n          return this.getTokenAllowance(options)\n        case 'TOKEN_CONVERSION':\n          return this.getTokenConversion(options)\n        case 'WALLET_ALLOWANCE':\n        case 'WALLET_ALLOWANCE_LP':\n        case 'WALLET_BALANCE':\n        case 'WALLET_DEPOSIT':\n        case 'WALLET_WITHDRAWABLE':\n          return Promise.resolve('')\n\n        default:\n          throw new Error('Value not available for this kind of vault')\n      }\n    } catch (error) {\n      console.error(`Contract get value error`, type, error)\n      return Promise.resolve(null)\n    }\n  }\n\n  /**\n   * Check if wallet is allowed\n   * @param options - the method options\n   * @returns true if wallet is allowed\n   */\n  public isWalletAllowed(\n    options?: VaultNonPayableMethodOptions\n  ): Promise<boolean> {\n    try {\n      if (\n        this.vault.contractType !== 'PARETO_DOLLAR' ||\n        !this.vault.paretoDollar\n      ) {\n        throw Error('Wrong vault type')\n      }\n\n      if (options?.walletAddress === undefined) {\n        throw Error('Wallet address is mandatory')\n      }\n\n      const { abi: vaultAbi, abiCode, address } = this.vault\n      const abi = ensureAbi({ abi: vaultAbi, abiCode })\n      const method = this.getContractNonPayableMethod({\n        abi,\n        address,\n        method: 'isWalletAllowed',\n        params: [options.walletAddress],\n      })\n\n      if (!method) {\n        throw Error('Not method available')\n      }\n\n      return method.call<boolean>()\n    } catch (error) {\n      return Promise.resolve(false)\n    }\n  }\n\n  /**\n   * Get token balance\n   * @param options - the method options\n   * @returns the token balance\n   */\n  public async getTokenBalance(options?: VaultNonPayableMethodOptions) {\n    if (\n      options?.walletAddress === undefined ||\n      options?.tokenAddress === undefined\n    ) {\n      return\n    }\n\n    const { tokenAddress, walletAddress } = options\n    const { abi, address } = this.getContractAbi(tokenAddress)\n\n    const method = this.getContractNonPayableMethod({\n      abi,\n      address,\n      method: 'balanceOf',\n      params: [walletAddress],\n    })\n\n    if (!method) {\n      throw Error('Not method available')\n    }\n\n    return method.call<bigint>().then((balance) => BNFixed(balance))\n  }\n\n  /**\n   * Get token allowance\n   * @param options\n   * @returns\n   */\n  public async getTokenAllowance(options?: VaultNonPayableMethodOptions) {\n    if (\n      this.vault.contractType !== 'PARETO_DOLLAR' ||\n      !this.vault.paretoDollar\n    ) {\n      throw Error('Wrong vault type')\n    }\n\n    if (\n      options?.walletAddress === undefined ||\n      options?.tokenAddress === undefined ||\n      options?.spender === undefined\n    ) {\n      return\n    }\n\n    const { tokenAddress, walletAddress, spender } = options\n    const { abi, address } = this.getContractAbi(tokenAddress)\n\n    const method = this.getContractNonPayableMethod({\n      abi,\n      address,\n      method: 'allowance',\n      params: [walletAddress, spender],\n    })\n\n    if (!method) {\n      throw Error('Not method available')\n    }\n\n    return method.call<bigint>().then((balance) => BNFixed(balance))\n  }\n\n  /**\n   * Get token conversion\n   * @param options\n   * @returns\n   */\n  public async getTokenConversion(options?: VaultNonPayableMethodOptions) {\n    if (\n      this.vault.contractType !== 'PARETO_DOLLAR' ||\n      !this.vault.paretoDollar\n    ) {\n      throw Error('Wrong vault type')\n    }\n\n    if (options?.pair === undefined || options?.tokenAmount === undefined) {\n      return\n    }\n\n    const { pair, tokenAmount } = options\n    const { abi, abiCode, address } = this.vault.paretoDollar.staking\n    const methodName =\n      pair === 'USP|sUSP'\n        ? 'convertToShares'\n        : pair === 'sUSP|USP'\n        ? 'convertToAssets'\n        : undefined\n\n    if (!methodName) {\n      return\n    }\n\n    const method = this.getContractNonPayableMethod({\n      abi: ensureAbi({ abi, abiCode }),\n      address,\n      method: methodName,\n      params: [tokenAmount],\n    })\n\n    if (!method) {\n      throw Error('Not method available')\n    }\n\n    return method.call<bigint>().then((balance) => BNFixed(balance))\n  }\n\n  /**\n   * Get address and abi of the pareto token\n   * @param tokenId\n   */\n  private getContractAbi(address: string): {\n    address: string\n    abi: ContractAbi\n  } {\n    if (compLower(address, this.vault.address)) {\n      const { address, abi: vaultAbi, abiCode } = this.vault\n      const abi = ensureAbi({ abi: vaultAbi, abiCode })\n      return { address, abi }\n    }\n\n    // Staking contract\n    if (\n      this.vault.paretoDollar?.staking.address &&\n      compLower(address, this.vault.paretoDollar?.staking.address)\n    ) {\n      const {\n        address,\n        abi: stakingAbi,\n        abiCode,\n      } = this.vault.paretoDollar.staking\n      const abi = ensureAbi({ abi: stakingAbi, abiCode })\n      return { address, abi }\n    }\n\n    // Collateral contract\n    const collateral = this.vault.paretoDollar?.collaterals?.find((c) =>\n      compLower(c.tokenAddress, address)\n    )\n    if (collateral) {\n      const { tokenAddress } = collateral\n      return { address: tokenAddress, abi: ERC20_ABI }\n    }\n\n    throw Error('Abi not found')\n  }\n}\n"],"names":["VaultParetoDollar","VaultContract","getContractData","blockNumber","contractData","additionalData","callData","makeCallData","getData","tokensData","Promise","all","getPoolsTokensData","getAdditionalData","pools","implementPoolsTokensData","undefined","wallets","implementWalletsData","paretoDollar","queue","parseContractData","getEulerWalletsCalls","eulerPool","vault","find","p","protocol","accountLensContract","oracle","web3Client","allSubAccounts","uniq","walletAddresses","flatMap","walletAddr","getEulerSubAccounts","filter","subAddr","compLower","map","toLowerCase","makeEulerVaultsCalls","subAccounts","pool","abi","oracleAbi","abiCode","address","ensureAbi","contract","reduce","acc","subAccount","callsData","makeProtocolData","walletAddress","poolAddress","type","parsePools","napierPTPool","tokensInfo","eulerWalletCalls","yieldSourceCalls","getQueueYieldSourcesCalls","epochPendingCalls","getQueueEpochPendingCalls","current","yieldSources","length","yieldSource","makeYieldSourceData","queueAbi","queueContract","yieldSourceAddress","sourceAddress","epochNumber","isNaN","Number","prevEpochNumber","Math","max","makeQueuePendingEpochData","vaultAbi","contractType","staking","stakingAbi","makeWalletData","token","makePoolData","getValue","options","isWalletAllowed","getTokenBalance","getTokenAllowance","getTokenConversion","resolve","Error","error","console","method","getContractNonPayableMethod","params","call","tokenAddress","getContractAbi","then","balance","BNFixed","spender","pair","tokenAmount","methodName","collateral","collaterals","c","ERC20_ABI","constructor"],"mappings":"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"}