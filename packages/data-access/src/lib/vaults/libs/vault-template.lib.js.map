{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/vaults/libs/vault-template.lib.ts"],"sourcesContent":["import moment from 'moment'\nimport { VaultTemplate, VaultTemplateParams } from '../vault.model'\n\n/**\n * Sanitize a string for safe HTML rendering\n * @param input - the input string\n * @returns sanitized string\n */\nexport function sanitizeHtml(input: string): string {\n  const htmlEscapeMap: Record<string, string> = {\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#39;',\n  }\n\n  const htmlEscapeRegex = /[&<>\"']/g\n  return input.replace(htmlEscapeRegex, (char) => htmlEscapeMap[char] ?? char)\n}\n\nfunction getParamValue(\n  params: VaultTemplateParams,\n  path: string\n): string | undefined {\n  let value: any = { ...params }\n  let segmentStart = 0\n  for (let i = 0; i <= path.length; i++) {\n    if (i === path.length || path.charCodeAt(i) === 46) {\n      const key = path.slice(segmentStart, i)\n      segmentStart = i + 1\n      if (!key) return undefined\n      value = value?.[key]\n      if (value === undefined) return undefined\n    }\n  }\n  return typeof value === 'string' ? value : undefined\n}\n\n/**\n * Render a vault template with the given parameters.\n * @param template vault template\n * @param params parameters to replace in the template\n * @returns rendered template\n */\nexport function renderVaultTemplate(\n  template: VaultTemplate,\n  params: VaultTemplateParams\n) {\n  const templateParams = template.parser ? template.parser(params) : params\n  const unsafeFields = template.unsafeFields || []\n\n  const missingFields = template.requiredFields.filter(\n    (field) => getParamValue(templateParams, field) === undefined\n  )\n\n  if (missingFields.length) {\n    throw new Error(\n      `Missing required template fields (${missingFields.join(', ')})`\n    )\n  }\n\n  const content = unsafeFields.reduce((acc, field) => {\n    const placeholder = `%{${field}}`\n    const value = getParamValue(templateParams, field) || ''\n    return acc.split(placeholder).join(value)\n  }, template.content)\n\n  return template.requiredFields.reduce((acc, field) => {\n    const placeholder = `%{${field}}`\n    const value = getParamValue(templateParams, field) || ''\n    return acc.split(placeholder).join(sanitizeHtml(value))\n  }, content)\n}\n\nexport function pickClosestBoundary(\n  date: moment.Moment,\n  boundaries: moment.Moment[]\n) {\n  return boundaries.reduce<moment.Moment | null>((closest, boundary) => {\n    if (!boundary || !boundary.isValid()) return closest\n    if (\n      !closest ||\n      Math.abs(date.diff(boundary)) < Math.abs(date.diff(closest))\n    ) {\n      return boundary\n    }\n    return closest\n  }, null)\n}\n\nexport function roundStart(\n  date: moment.Moment | null,\n  startOf: 'month' | 'week' | 'day' = 'month'\n): string {\n  if (!date) return ''\n  const candidates = [-1, 0, 1].map((offset) =>\n    date.clone().add(offset, startOf).startOf(startOf)\n  )\n  const closestDate = pickClosestBoundary(date, candidates)\n  return closestDate?.format('MMMM Do, YYYY') || date.format('MMMM Do, YYYY')\n}\n\nexport function roundEnd(\n  date: moment.Moment | null,\n  endOf: 'month' | 'week' | 'day' = 'month'\n): string {\n  if (!date) return ''\n  const candidates = [-1, 0, 1].map((offset) =>\n    date.clone().add(offset, endOf).endOf(endOf)\n  )\n  const closestDate = pickClosestBoundary(date, candidates)\n  return closestDate?.format('MMMM Do, YYYY') || date.format('MMMM Do, YYYY')\n}\n"],"names":["pickClosestBoundary","renderVaultTemplate","roundEnd","roundStart","sanitizeHtml","input","htmlEscapeMap","htmlEscapeRegex","replace","char","getParamValue","params","path","value","segmentStart","i","length","charCodeAt","key","slice","undefined","template","templateParams","parser","unsafeFields","missingFields","requiredFields","filter","field","Error","join","content","reduce","acc","placeholder","split","date","boundaries","closest","boundary","isValid","Math","abs","diff","startOf","candidates","map","offset","clone","add","closestDate","format","endOf"],"mappings":"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"}