{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/vaults/libs/vault-utils.lib.ts"],"sourcesContent":["import { uniq } from 'lodash'\nimport { Vault, VaultSiblingsKeys, VaultYieldSourcesKeys } from '../vault.model'\nimport { VaultBlock } from '../../vault-blocks'\nimport { AbiContract } from '../../core'\nimport { AbiCode } from '../../web3-client'\n\n/**\n * Get the operator IDs from a vault.\n * @param vault - the vault object\n * @returns the operator IDs\n */\nexport function getVaultOperatorIds(vault: Vault): string[] {\n  let operatorIds: string[] = []\n\n  if (vault.operatorIds) {\n    operatorIds = vault.operatorIds\n  }\n\n  if (vault.cdoEpoch?.borrower.operatorId) {\n    operatorIds.push(vault.cdoEpoch.borrower.operatorId)\n  }\n  if (vault.cdoEpoch?.manager.operatorId) {\n    operatorIds.push(vault.cdoEpoch.manager.operatorId)\n  }\n\n  if (vault.pools) {\n    operatorIds = [\n      ...operatorIds,\n      ...vault.pools\n        .filter((p) => !!p.operatorId)\n        .map((p) => p.operatorId as string),\n    ]\n  }\n\n  return uniq(operatorIds)\n}\n\n/**\n * Get the token IDs from a vault\n * @param vault - the vault entity\n * @returns the token IDs\n */\nexport function getVaultTokenIds(vault: Vault): string[] {\n  const tokenIds: string[] = [vault.tokenId]\n\n  if (vault.contractType === 'PARETO_DOLLAR' && vault.paretoDollar) {\n    tokenIds.push(\n      vault.paretoDollar.tokenId,\n      vault.paretoDollar.staking.tokenId,\n      ...(vault.paretoDollar.collaterals || []).map(\n        (collateral) => collateral.tokenId\n      )\n    )\n  }\n\n  return uniq(tokenIds)\n}\n\n/**\n * Get vaults token ids\n * @param vaults - the vaults array\n * @returns the token ids\n */\nexport function getVaultsTokenIds(vaults: Vault[]): string[] {\n  const operatorIds = vaults.reduce(\n    (acc: string[], v) => [...acc, ...getVaultTokenIds(v)],\n    []\n  )\n  return uniq(operatorIds)\n}\n\n/**\n * Get vaults operator ids\n * @param vaults - the vaults array\n * @returns the operator ids\n */\nexport function getVaultsOperatorIds(vaults: Vault[]): string[] {\n  const operatorIds = vaults.reduce(\n    (acc: string[], v) => [...acc, ...getVaultOperatorIds(v)],\n    []\n  )\n  return uniq(operatorIds)\n}\n\n/**\n * Get vaults uniq keys\n * @param vaults - the vaults array\n * @returns the array keys\n */\nexport function getVaultsKeys<T = string>(\n  vaults: Vault[],\n  key: keyof Vault\n): T[] {\n  return uniq(vaults.filter((t) => !!t[key]).map((t) => t[key] as T))\n}\n\n/**\n * Get vault yields sources ids\n * @param block - the vault block\n * @returns the yield sources ids\n */\nexport function getVaultYieldSourcesKeys(\n  block: VaultBlock\n): VaultYieldSourcesKeys {\n  if (!block.paretoDollar?.queue?.yieldSources) {\n    return {}\n  }\n\n  const { yieldSources } = block.paretoDollar.queue\n  const vaultIds = uniq(\n    yieldSources.map((source) => source.vaultId).filter((v) => !!v)\n  ) as string[]\n  const operatorIds = uniq(\n    yieldSources.map((source) => source.operatorId).filter((v) => !!v)\n  ) as string[]\n  const tokenAddresses = uniq(\n    yieldSources.map((source) => source.tokenAddress).filter((v) => !!v)\n  ) as string[]\n\n  return { vaultIds, operatorIds, tokenAddresses }\n}\n\n/**\n * Get vaults yields sources data\n * @param vaults - the vaults array\n * @returns the yield sources data\n */\nexport function getVaultsYieldSourcesKeys(\n  vaults: Vault[],\n  blocks: VaultBlock[]\n): VaultYieldSourcesKeys {\n  const yieldSourcesKeys = vaults.reduce((acc: VaultYieldSourcesKeys, v) => {\n    const block = blocks.find((b) => b.vaultId === v._id)\n\n    if (!block) {\n      return acc\n    }\n\n    const { vaultIds, operatorIds, tokenAddresses } =\n      getVaultYieldSourcesKeys(block)\n\n    return {\n      vaultIds: uniq([...(acc.vaultIds || []), ...(vaultIds || [])]),\n      operatorIds: uniq([...(acc.operatorIds || []), ...(operatorIds || [])]),\n      tokenAddresses: uniq([\n        ...(acc.tokenAddresses || []),\n        ...(tokenAddresses || []),\n      ]),\n    }\n  }, {})\n\n  return yieldSourcesKeys\n}\n\n/**\n * Get vault siblings keys\n * @param vault - the vault\n * @returns the vault siblinngs keys\n */\nexport function getVaultSiblingsKeys(vault: Vault): VaultSiblingsKeys {\n  if (!vault.siblings) {\n    return {}\n  }\n\n  const vaultIds = uniq(vault.siblings.map((s) => s._id))\n  const chainIds = uniq(vault.siblings.map((s) => s.chainId))\n\n  return { vaultIds, chainIds }\n}\n\n/**\n * Get vaults siblings keys\n * @param vaults - the vaults array\n * @returns the siblings keys\n */\nexport function getVaultsSiblingsKeys(vaults: Vault[]): VaultSiblingsKeys {\n  const siblingsKeys = vaults.reduce((acc: VaultSiblingsKeys, v) => {\n    const { vaultIds, chainIds } = getVaultSiblingsKeys(v)\n\n    return {\n      vaultIds: uniq([...(acc.vaultIds || []), ...(vaultIds || [])]),\n      chainIds: uniq([...(acc.chainIds || []), ...(chainIds || [])]),\n    }\n  }, {})\n\n  return siblingsKeys\n}\n\n/**\n * Get vault campaign ids\n * @param vault - the vault\n * @returns the campaign ids\n */\nexport function getVaultCampaignIds(vault: Vault): string[] {\n  return uniq(vault.campaigns?.map((c) => c._id))\n}\n\n/**\n * Get vaults campaign IDs\n * @param vaults - the vaults array\n * @returns the campaign ids\n */\nexport function getVaultsCampaignIds(vaults: Vault[]): string[] {\n  return vaults.reduce<string[]>(\n    (acc, v) => uniq([...acc, ...getVaultCampaignIds(v)]),\n    []\n  )\n}\n\n/**\n * Get vault KYC address\n * @param vault - the vault entity\n * @returns the contract address to use\n */\nexport function getVaultKYCContract(vault: Vault): {\n  abi?: AbiContract\n  abiCode?: AbiCode\n  address?: string\n} {\n  switch (vault.contractType) {\n    case 'CDO_EPOCH': {\n      const { abi, abiCode, address } = vault.cdoEpoch || {}\n      return { abi, abiCode, address }\n    }\n    case 'PARETO_DOLLAR': {\n      const { abi, abiCode, address } = vault\n      return { abi, abiCode, address }\n    }\n    // Not available\n    default:\n      return {}\n  }\n}\n"],"names":["getVaultCampaignIds","getVaultKYCContract","getVaultOperatorIds","getVaultSiblingsKeys","getVaultTokenIds","getVaultYieldSourcesKeys","getVaultsCampaignIds","getVaultsKeys","getVaultsOperatorIds","getVaultsSiblingsKeys","getVaultsTokenIds","getVaultsYieldSourcesKeys","vault","operatorIds","cdoEpoch","borrower","operatorId","push","manager","pools","filter","p","map","uniq","tokenIds","tokenId","contractType","paretoDollar","staking","collaterals","collateral","vaults","reduce","acc","v","key","t","block","queue","yieldSources","vaultIds","source","vaultId","tokenAddresses","tokenAddress","blocks","yieldSourcesKeys","find","b","_id","siblings","s","chainIds","chainId","siblingsKeys","campaigns","c","abi","abiCode","address"],"mappings":"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"}