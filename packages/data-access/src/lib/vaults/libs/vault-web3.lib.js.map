{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/vaults/libs/vault-web3.lib.ts"],"sourcesContent":["import { Contract, Transaction } from 'web3'\nimport { Token } from '../../tokens'\nimport {\n  AbiCode,\n  WEB3_DEFAULT_ADDR,\n  Web3CallData,\n  Web3Clients,\n  Web3ContractMethod,\n  Web3DataParam,\n  Web3Entity,\n  Web3Event,\n} from '../../web3-client'\nimport { VaultContractFactory } from '../classes/vault-contract.factory'\nimport { Vault, VaultContractModel, VaultKycData } from '../vault.model'\nimport { AbiContract, AbiJsonInterface, compLower, isAddress } from '../../core'\nimport { uniq } from 'lodash'\nimport { TransactionType } from '../../transactions'\nimport {\n  CDO_MAIN_V1_ABI,\n  CDO_STRATEGY_MAIN_V1_ABI,\n  POOL_Compound_V1_ABI,\n  POOL_Compound_V2_ABI,\n  POOL_Morpho_V1_ABI,\n  POOL_PendleLP_V1_ABI,\n  POOL_Idle_V1_ABI,\n  POOL_AaveV2_V1_ABI,\n  POOL_Ethena_V1_ABI,\n  POOL_Balancer_V1_ABI,\n  POOL_Gearbox_V1_ABI,\n  POOL_PendlePT_V1_ABI,\n  POOL_PendleYT_V1_ABI,\n  POOL_Sky_V1_ABI,\n  POOL_BalancerGauge_V1_ABI,\n  POOL_NapierLP_V1_ABI,\n  POOL_NapierPT_V1_ABI,\n  POOL_NapierYT_V1_ABI,\n  POOL_InstadApp_V1_ABI,\n  POOL_TermFinance_V1_ABI,\n  POOL_Euler_V1_ABI,\n  BestYield_MAIN_V1_ABI,\n  BestYield_MAIN_V2_ABI,\n  CDO_EPOCH_MAIN_V1_ABI,\n  CDO_EPOCH_MAIN_V2_ABI,\n  CDO_EPOCH_MAIN_V3_ABI,\n  CDO_EPOCH_MAIN_V4_ABI,\n  CDO_EPOCH_DEPOSIT_QUEUE_V1_ABI,\n  CDO_EPOCH_DEPOSIT_QUEUE_V2_ABI,\n  CDO_EPOCH_STRATEGY_MAIN_V1_ABI,\n  CDO_EPOCH_STRATEGY_MAIN_V2_ABI,\n  PARETO_DOLLAR_MAIN_V1_ABI,\n  PARETO_DOLLAR_QUEUE_V1_ABI,\n  PARETO_DOLLAR_STAKING_V1_ABI,\n  ORACLE_PendleSY_V1_ABI,\n  ORACLE_PendlePT_V1_ABI,\n  ORACLE_Balancer_V1_ABI,\n  ORACLE_Euler_V1_ABI,\n  ORACLE_AaveV2_V1_ABI,\n  ORACLE_Clearpool_V1_ABI,\n  ERC20_ABI,\n  CDO_EPOCH_WRITEOFF_V1_ABI,\n  CDO_MAIN_V2_ABI,\n  CDO_MAIN_V3_ABI,\n  CDO_MAIN_V4_ABI,\n  CDO_STRATEGY_MAIN_V2_ABI,\n  CDO_STRATEGY_MAIN_V3_ABI,\n} from '../abis'\n\n/**\n * Load vault web3 data\n * @param web3Clients - the web3 clients\n * @param vault - the vault data\n * @param tokens - the tokens available\n * @param options - the options\n * @returns the web3 data\n */\nexport async function getVaultWeb3Data(\n  web3Clients: Web3Clients,\n  vault: Vault,\n  tokens: Token[],\n  options?: {\n    walletAddress?: string\n  }\n): Promise<VaultKycData> {\n  const token = tokens.find((t) => vault.tokenId === t._id)\n  const web3Client = web3Clients[vault.chainId]\n\n  if (!token) {\n    throw Error('Token not found')\n  }\n\n  // Init contract\n  const contract = VaultContractFactory.fromVault(vault, token, {\n    web3Client,\n  })\n\n  return getVaultKycData(vault, contract, options)\n}\n\n/**\n * Make web3 call data for a specific contract method\n * @param contract contract\n * @param contractMethod contract method to call\n * @param parent parent web3 entity in case of nested calls\n * @returns web3 call data\n */\nexport function makeWeb3CallData(\n  contract: Contract<AbiContract>,\n  contractMethod: Web3ContractMethod,\n  inputs?: Web3DataParam[],\n  parent?: Web3Entity\n): Web3CallData {\n  const { jsonInterface } = contract.options\n  const { protocol, type, method, block, params = [] } = contractMethod\n  const address = contract.options.address\n\n  if (!address) {\n    throw new Error('Contract without a valid address')\n  }\n\n  // Get ABI method to prepare the right types\n  const methodAbi = (jsonInterface as AbiJsonInterface[]).find(\n    (f) => f.name === method && f.inputs.length === params.length\n  )\n\n  if (!methodAbi) {\n    throw new Error(\n      `No ABI method '${method}' found for ${protocol} at contract ${contract.options.address}`\n    )\n  }\n\n  // Method name + params\n  const inputTypes = methodAbi.inputs.map((i) => i.type)\n  const methodName = `${methodAbi.name}(${inputTypes.join(',')})`\n\n  // Outputs\n  const outputs: Web3DataParam[] = methodAbi.outputs.map((output) => ({\n    type: output.type,\n    name: output.name,\n    components: output.components,\n  }))\n\n  return {\n    protocol,\n    type,\n    address,\n    method: methodName,\n    params,\n    block,\n    parent,\n    inputs: inputs || [],\n    outputs,\n  }\n}\n\n/**\n * Load all contract vault contract data\n * @param contract - the vault contract\n * @returns the promise<VaultKycData> for load contract data\n */\nasync function getVaultKycData(\n  vault: Vault,\n  contract: VaultContractModel,\n  options: {\n    walletAddress?: string\n  } = {}\n): Promise<VaultKycData> {\n  const { walletAddress } = options\n  const vaultId = vault._id\n\n  if (!walletAddress || !vault.kyc?.isActive) {\n    return {\n      vaultId,\n      isActive: !!vault.kyc?.isActive,\n    }\n  }\n\n  // Kyc data\n  const isWalletAllowed = await contract.getValue<boolean>(\n    'IS_WALLET_ALLOWED',\n    {\n      walletAddress,\n    }\n  )\n\n  return {\n    vaultId,\n    isActive: !!vault.kyc?.isActive,\n    isWalletAllowed,\n  }\n}\n\n/**\n *\n * @param vault\n * @returns\n */\nexport function getVaultPoolsAddresses(vault: Vault): string[] {\n  return (vault.pools || []).reduce((acc: string[], p) => {\n    const newAcc = [...acc, p.address.toLowerCase()]\n    if (p.oracle) {\n      return [...newAcc, p.oracle.address.toLowerCase()]\n    }\n    return newAcc\n  }, [])\n}\n\n/**\n * Get Pool event type\n * @param vault vault object\n * @param from from address\n * @param to to address\n * @returns pool event type (if any)\n */\nexport function getVaultPoolEventType(\n  vault: Vault,\n  event: Web3Event,\n  from: string,\n  to: string\n): TransactionType | undefined {\n  const poolAddresses = getVaultPoolsAddresses(vault)\n  const isPoolToken = poolAddresses.includes(event.address.toLowerCase())\n  // Handle pool token transfer\n  if (isPoolToken) {\n    // Mint pool token\n    if (from.toLowerCase() === WEB3_DEFAULT_ADDR) {\n      return 'STAKE_POOL'\n    }\n    // Redeem pool token\n    if (to.toLowerCase() === WEB3_DEFAULT_ADDR) {\n      return 'UNSTAKE_POOL'\n    }\n    // Handle pool underlying token transfer\n  } else {\n    if (poolAddresses.includes(to.toLowerCase())) {\n      return 'STAKE_POOL'\n    }\n    if (poolAddresses.includes(from.toLowerCase())) {\n      return 'UNSTAKE_POOL'\n    }\n  }\n  return\n}\n\n/**\n * Check if a transfer is an internal pool\n * @param vault vault object\n * @param from from address\n * @param to to address\n * @returns true | false\n */\nexport function checkVaultPoolInternalTransfer(\n  vault: Vault,\n  event: Web3Event,\n  from: string,\n  to: string\n): boolean {\n  const poolAddresses = getVaultPoolsAddresses(vault)\n  const eventType = getVaultPoolEventType(vault, event, from, to)\n  switch (eventType) {\n    case 'STAKE_POOL':\n      return poolAddresses.includes(from.toLowerCase())\n    case 'UNSTAKE_POOL':\n      return poolAddresses.includes(to.toLowerCase())\n  }\n  return false\n}\n\n/**\n * Check if a specific address corresponds to a vault contract address\n * @param vault vault model\n * @param address address to check\n * @returns true | false\n */\nexport function checkContractAddress(vault: Vault, address: string): boolean {\n  const isVault = compLower(address, vault.address)\n  const isCdo = vault.cdo ? compLower(address, vault.cdo.address) : false\n  const isCdoEpoch = vault.cdoEpoch\n    ? compLower(address, vault.cdoEpoch.address)\n    : false\n  const isStrategy = vault.strategy\n    ? compLower(address, vault.strategy.address)\n    : false\n  const isDepositQueue = vault.cdoEpoch?.depositQueue\n    ? compLower(address, vault.cdoEpoch.depositQueue.address)\n    : false\n  const isWithdrawQueue = vault.cdoEpoch?.withdrawQueue\n    ? compLower(address, vault.cdoEpoch.withdrawQueue.address)\n    : false\n  const isParetoDollarQueue = vault.paretoDollar?.queue\n    ? compLower(address, vault.paretoDollar.queue.address)\n    : false\n  const isParetoDollarStaking = vault.paretoDollar?.staking\n    ? compLower(address, vault.paretoDollar.staking.address)\n    : false\n\n  const poolAddresses = getVaultPoolsAddresses(vault)\n  const isPoolAddress = poolAddresses.includes(address.toLowerCase())\n\n  return (\n    isVault ||\n    isCdo ||\n    isCdoEpoch ||\n    isStrategy ||\n    isDepositQueue ||\n    isWithdrawQueue ||\n    isParetoDollarQueue ||\n    isParetoDollarStaking ||\n    isPoolAddress\n  )\n}\n\n/**\n * Get all wallet addresses to track from a web3 event\n * @param vault vault object\n * @param event web3 event\n * @returns list of addresses\n */\nexport function getWeb3EventAddresses(\n  vault: Vault,\n  event: Web3Event,\n  transaction?: Transaction\n): string[] {\n  const addresses = [\n    transaction?.from as string,\n    event.values['from'] as string,\n    event.values['to'] as string,\n    event.values['_from'] as string,\n    event.values['_to'] as string,\n    event.values['user'] as string,\n    event.values['owner'] as string,\n    event.values['receiver'] as string,\n    event.values['sender'] as string,\n    event.values['owner'] as string,\n    event.values['0'] as string,\n    event.values['1'] as string,\n  ].filter(\n    (address) =>\n      address &&\n      isAddress(address) &&\n      address !== WEB3_DEFAULT_ADDR &&\n      !checkContractAddress(vault, address)\n  )\n  return uniq(addresses.map((addr) => addr.toLowerCase()))\n}\n\n/**\n * Get ABI contract by code\n * @param abiCode ABI code\n * @returns ABI contract\n */\nexport function getAbiByCode(abiCode: AbiCode): AbiContract {\n  switch (abiCode) {\n    // Generic\n    case 'ERC20':\n      return ERC20_ABI\n\n    // CDO\n    case 'CDO_MAIN_V1':\n      return CDO_MAIN_V1_ABI\n    case 'CDO_MAIN_V2':\n      return CDO_MAIN_V2_ABI\n    case 'CDO_MAIN_V3':\n      return CDO_MAIN_V3_ABI\n    case 'CDO_MAIN_V4':\n      return CDO_MAIN_V4_ABI\n\n    // CDO Strategy\n    case 'CDO_STRATEGY_MAIN_V1':\n      return CDO_STRATEGY_MAIN_V1_ABI\n    case 'CDO_STRATEGY_MAIN_V2':\n      return CDO_STRATEGY_MAIN_V2_ABI\n    case 'CDO_STRATEGY_MAIN_V3':\n      return CDO_STRATEGY_MAIN_V3_ABI\n\n    // Best Yield\n    case 'BestYield_MAIN_V1':\n      return BestYield_MAIN_V1_ABI\n    case 'BestYield_MAIN_V2':\n      return BestYield_MAIN_V2_ABI\n\n    // CDO Epoch\n    case 'CDO_EPOCH_MAIN_V1':\n      return CDO_EPOCH_MAIN_V1_ABI\n    case 'CDO_EPOCH_MAIN_V2':\n      return CDO_EPOCH_MAIN_V2_ABI\n    case 'CDO_EPOCH_MAIN_V3':\n      return CDO_EPOCH_MAIN_V3_ABI\n    case 'CDO_EPOCH_MAIN_V4':\n      return CDO_EPOCH_MAIN_V4_ABI\n    case 'CDO_EPOCH_DEPOSIT_QUEUE_V1':\n      return CDO_EPOCH_DEPOSIT_QUEUE_V1_ABI\n    case 'CDO_EPOCH_DEPOSIT_QUEUE_V2':\n      return CDO_EPOCH_DEPOSIT_QUEUE_V2_ABI\n    case 'CDO_EPOCH_WRITEOFF_V1':\n      return CDO_EPOCH_WRITEOFF_V1_ABI\n\n    // CDO Epoch Strategy\n    case 'CDO_EPOCH_STRATEGY_MAIN_V1':\n      return CDO_EPOCH_STRATEGY_MAIN_V1_ABI\n    case 'CDO_EPOCH_STRATEGY_MAIN_V2':\n      return CDO_EPOCH_STRATEGY_MAIN_V2_ABI\n\n    // Pareto Dollar\n    case 'PARETO_DOLLAR_MAIN_V1':\n      return PARETO_DOLLAR_MAIN_V1_ABI\n    case 'PARETO_DOLLAR_QUEUE_V1':\n      return PARETO_DOLLAR_QUEUE_V1_ABI\n    case 'PARETO_DOLLAR_STAKING_V1':\n      return PARETO_DOLLAR_STAKING_V1_ABI\n\n    // Oracles\n    case 'ORACLE_AaveV2_V1':\n      return ORACLE_AaveV2_V1_ABI\n    case 'ORACLE_Balancer_V1':\n      return ORACLE_Balancer_V1_ABI\n    case 'ORACLE_Clearpool_V1':\n      return ORACLE_Clearpool_V1_ABI\n    case 'ORACLE_PendleSY_V1':\n      return ORACLE_PendleSY_V1_ABI\n    case 'ORACLE_PendlePT_V1':\n      return ORACLE_PendlePT_V1_ABI\n    case 'ORACLE_Euler_V1':\n      return ORACLE_Euler_V1_ABI\n\n    // Pools\n    case 'POOL_AaveV2_V1':\n      return POOL_AaveV2_V1_ABI\n    case 'POOL_Balancer_V1':\n      return POOL_Balancer_V1_ABI\n    case 'POOL_BalancerGauge_V1':\n      return POOL_BalancerGauge_V1_ABI\n    case 'POOL_Compound_V1':\n      return POOL_Compound_V1_ABI\n    case 'POOL_Compound_V2':\n      return POOL_Compound_V2_ABI\n    case 'POOL_Ethena_V1':\n      return POOL_Ethena_V1_ABI\n    case 'POOL_Gearbox_V1':\n      return POOL_Gearbox_V1_ABI\n    case 'POOL_Idle_V1':\n      return POOL_Idle_V1_ABI\n    case 'POOL_InstadApp_V1':\n      return POOL_InstadApp_V1_ABI\n    case 'POOL_Morpho_V1':\n      return POOL_Morpho_V1_ABI\n    case 'POOL_NapierLP_V1':\n      return POOL_NapierLP_V1_ABI\n    case 'POOL_NapierPT_V1':\n      return POOL_NapierPT_V1_ABI\n    case 'POOL_NapierYT_V1':\n      return POOL_NapierYT_V1_ABI\n    case 'POOL_PendleLP_V1':\n      return POOL_PendleLP_V1_ABI\n    case 'POOL_PendlePT_V1':\n      return POOL_PendlePT_V1_ABI\n    case 'POOL_PendleYT_V1':\n      return POOL_PendleYT_V1_ABI\n    case 'POOL_Sky_V1':\n      return POOL_Sky_V1_ABI\n    case 'POOL_Euler_V1':\n      return POOL_Euler_V1_ABI\n    case 'POOL_TermFinance_V1':\n      return POOL_TermFinance_V1_ABI\n\n    default:\n      throw new Error(`Unsupported ABI code: ${abiCode}`)\n  }\n}\n\n/**\n * Retrieve Abi Contract by abi or abiCode\n * @param options - the abi or the abiCode\n * @returns the ABI contract\n */\nexport function ensureAbi({\n  abi,\n  abiCode,\n}: {\n  abi?: AbiContract\n  abiCode?: AbiCode\n}): AbiContract {\n  if (abi) {\n    return abi\n  }\n\n  if (abiCode) {\n    return getAbiByCode(abiCode)\n  }\n\n  throw new Error(`ABI not found`)\n}\n"],"names":["checkContractAddress","checkVaultPoolInternalTransfer","ensureAbi","getAbiByCode","getVaultPoolEventType","getVaultPoolsAddresses","getVaultWeb3Data","getWeb3EventAddresses","makeWeb3CallData","web3Clients","vault","tokens","options","token","find","t","tokenId","_id","web3Client","chainId","Error","contract","VaultContractFactory","fromVault","getVaultKycData","contractMethod","inputs","parent","jsonInterface","protocol","type","method","block","params","address","methodAbi","f","name","length","inputTypes","map","i","methodName","join","outputs","output","components","walletAddress","vaultId","kyc","isActive","isWalletAllowed","getValue","pools","reduce","acc","p","newAcc","toLowerCase","oracle","event","from","to","poolAddresses","isPoolToken","includes","WEB3_DEFAULT_ADDR","eventType","isVault","compLower","isCdo","cdo","isCdoEpoch","cdoEpoch","isStrategy","strategy","isDepositQueue","depositQueue","isWithdrawQueue","withdrawQueue","isParetoDollarQueue","paretoDollar","queue","isParetoDollarStaking","staking","isPoolAddress","transaction","addresses","values","filter","isAddress","uniq","addr","abiCode","ERC20_ABI","CDO_MAIN_V1_ABI","CDO_MAIN_V2_ABI","CDO_MAIN_V3_ABI","CDO_MAIN_V4_ABI","CDO_STRATEGY_MAIN_V1_ABI","CDO_STRATEGY_MAIN_V2_ABI","CDO_STRATEGY_MAIN_V3_ABI","BestYield_MAIN_V1_ABI","BestYield_MAIN_V2_ABI","CDO_EPOCH_MAIN_V1_ABI","CDO_EPOCH_MAIN_V2_ABI","CDO_EPOCH_MAIN_V3_ABI","CDO_EPOCH_MAIN_V4_ABI","CDO_EPOCH_DEPOSIT_QUEUE_V1_ABI","CDO_EPOCH_DEPOSIT_QUEUE_V2_ABI","CDO_EPOCH_WRITEOFF_V1_ABI","CDO_EPOCH_STRATEGY_MAIN_V1_ABI","CDO_EPOCH_STRATEGY_MAIN_V2_ABI","PARETO_DOLLAR_MAIN_V1_ABI","PARETO_DOLLAR_QUEUE_V1_ABI","PARETO_DOLLAR_STAKING_V1_ABI","ORACLE_AaveV2_V1_ABI","ORACLE_Balancer_V1_ABI","ORACLE_Clearpool_V1_ABI","ORACLE_PendleSY_V1_ABI","ORACLE_PendlePT_V1_ABI","ORACLE_Euler_V1_ABI","POOL_AaveV2_V1_ABI","POOL_Balancer_V1_ABI","POOL_BalancerGauge_V1_ABI","POOL_Compound_V1_ABI","POOL_Compound_V2_ABI","POOL_Ethena_V1_ABI","POOL_Gearbox_V1_ABI","POOL_Idle_V1_ABI","POOL_InstadApp_V1_ABI","POOL_Morpho_V1_ABI","POOL_NapierLP_V1_ABI","POOL_NapierPT_V1_ABI","POOL_NapierYT_V1_ABI","POOL_PendleLP_V1_ABI","POOL_PendlePT_V1_ABI","POOL_PendleYT_V1_ABI","POOL_Sky_V1_ABI","POOL_Euler_V1_ABI","POOL_TermFinance_V1_ABI","abi"],"mappings":"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"}