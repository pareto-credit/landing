{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/vaults/libs/vault-web3.lib.ts"],"sourcesContent":["import { Contract } from 'web3'\nimport { Token } from '../../tokens'\nimport {\n  Web3CallData,\n  Web3Clients,\n  Web3ContractMethod,\n  Web3DataParam,\n  Web3Entity,\n  Web3EventType,\n} from '../../web3-client'\nimport { VaultContractFactory } from '../classes/vault-contract.factory'\nimport { Vault, VaultContractModel, VaultKycData } from '../vault.model'\nimport { AbiContract, AbiJsonInterface, compLower } from '../../core'\n\n/**\n * Load vault web3 data\n * @param web3Clients - the web3 clients\n * @param vault - the vault data\n * @param tokens - the tokens available\n * @param options - the options\n * @returns the web3 data\n */\nexport async function getVaultWeb3Data(\n  web3Clients: Web3Clients,\n  vault: Vault,\n  tokens: Token[],\n  options?: {\n    walletAddress?: string\n  }\n): Promise<VaultKycData> {\n  const token = tokens.find((t) => vault.tokenId === t._id)\n  const web3Client = web3Clients[vault.chainId]\n\n  if (!token) {\n    throw Error('Token not found')\n  }\n\n  // Init contract\n  const contract = VaultContractFactory.fromVault(vault, token, {\n    web3Client,\n  })\n\n  return getVaultKycData(vault, contract, options)\n}\n\n/**\n * Make web3 call data for a specific contract method\n * @param contract contract\n * @param contractMethod contract method to call\n * @param parent parent web3 entity in case of nested calls\n * @returns web3 call data\n */\nexport function makeWeb3CallData(\n  contract: Contract<AbiContract>,\n  contractMethod: Web3ContractMethod,\n  inputs?: Web3DataParam[],\n  parent?: Web3Entity\n): Web3CallData {\n  const { jsonInterface } = contract.options\n  const { protocol, type, method, block, params = [] } = contractMethod\n  const address = contract.options.address\n\n  if (!address) {\n    throw new Error('Contract without a valid address')\n  }\n\n  // Get ABI method to prepare the right types\n  const methodAbi = (jsonInterface as AbiJsonInterface[]).find(\n    (f) => f.name === method && f.inputs.length === params.length\n  )\n\n  if (!methodAbi) {\n    throw new Error(\n      `No ABI method '${method}' found for ${protocol} at contract ${contract.options.address}`\n    )\n  }\n\n  // Method name + params\n  const inputTypes = methodAbi.inputs.map((i) => i.type)\n  const methodName = `${methodAbi.name}(${inputTypes.join(',')})`\n\n  // Outputs\n  const outputs: Web3DataParam[] = methodAbi.outputs.map((output) => ({\n    type: output.type,\n    name: output.name,\n    components: output.components,\n  }))\n\n  return {\n    protocol,\n    type,\n    address,\n    method: methodName,\n    params,\n    block,\n    parent,\n    inputs: inputs || [],\n    outputs,\n  }\n}\n\n/**\n * Load all contract vault contract data\n * @param contract - the vault contract\n * @returns the promise<VaultKycData> for load contract data\n */\nasync function getVaultKycData(\n  vault: Vault,\n  contract: VaultContractModel,\n  options: {\n    walletAddress?: string\n  } = {}\n): Promise<VaultKycData> {\n  const { walletAddress } = options\n  const vaultId = vault._id\n\n  if (!walletAddress || !vault.kyc?.isActive) {\n    return {\n      vaultId,\n      isActive: !!vault.kyc?.isActive,\n    }\n  }\n\n  // Kyc data\n  const isWalletAllowed = await contract.getValue<boolean>(\n    'IS_WALLET_ALLOWED',\n    {\n      walletAddress,\n    }\n  )\n\n  return {\n    vaultId,\n    isActive: !!vault.kyc?.isActive,\n    isWalletAllowed,\n  }\n}\n\n/**\n * Get Pool event type\n * @param vault vault object\n * @param from from address\n * @param to to address\n * @returns pool event type (if any)\n */\nexport function getVaultPoolEventType(\n  vault: Vault,\n  from: string,\n  to: string\n): Web3EventType | undefined {\n  if (\n    vault.pools?.map((p) => p.address.toLowerCase()).includes(to.toLowerCase())\n  ) {\n    return 'STAKE_POOL'\n  }\n  if (\n    vault.pools\n      ?.map((p) => p.address.toLowerCase())\n      .includes(from.toLowerCase())\n  ) {\n    return 'UNSTAKE_POOL'\n  }\n  return\n}\n\n/**\n * Check if a specific address corresponds to a vault contract address\n * @param vault vault model\n * @param address address to check\n * @returns true | false\n */\nexport function checkContractAddress(vault: Vault, address: string): boolean {\n  const isVault = compLower(address, vault.address)\n  const isCdo = vault.cdo ? compLower(address, vault.cdo.address) : false\n  const isCdoEpoch = vault.cdoEpoch\n    ? compLower(address, vault.cdoEpoch.address)\n    : false\n  const isStrategy = vault.strategy\n    ? compLower(address, vault.strategy.address)\n    : false\n  const isDepositQueue = vault.cdoEpoch?.depositQueue\n    ? compLower(address, vault.cdoEpoch.depositQueue.address)\n    : false\n  const isWithdrawQueue = vault.cdoEpoch?.withdrawQueue\n    ? compLower(address, vault.cdoEpoch.withdrawQueue.address)\n    : false\n  const isParetoDollarQueue = vault.paretoDollar?.queue\n    ? compLower(address, vault.paretoDollar.queue.address)\n    : false\n  const isParetoDollarStaking = vault.paretoDollar?.staking\n    ? compLower(address, vault.paretoDollar.staking.address)\n    : false\n  return (\n    isVault ||\n    isCdo ||\n    isCdoEpoch ||\n    isStrategy ||\n    isDepositQueue ||\n    isWithdrawQueue ||\n    isParetoDollarQueue ||\n    isParetoDollarStaking\n  )\n}\n"],"names":["VaultContractFactory","compLower","getVaultWeb3Data","web3Clients","vault","tokens","options","token","find","t","tokenId","_id","web3Client","chainId","Error","contract","fromVault","getVaultKycData","makeWeb3CallData","contractMethod","inputs","parent","jsonInterface","protocol","type","method","block","params","address","methodAbi","f","name","length","inputTypes","map","i","methodName","join","outputs","output","components","walletAddress","vaultId","kyc","isActive","isWalletAllowed","getValue","getVaultPoolEventType","from","to","pools","p","toLowerCase","includes","checkContractAddress","isVault","isCdo","cdo","isCdoEpoch","cdoEpoch","isStrategy","strategy","isDepositQueue","depositQueue","isWithdrawQueue","withdrawQueue","isParetoDollarQueue","paretoDollar","queue","isParetoDollarStaking","staking"],"mappings":"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"}