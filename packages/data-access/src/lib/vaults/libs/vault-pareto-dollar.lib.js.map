{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/vaults/libs/vault-pareto-dollar.lib.ts"],"sourcesContent":["import { BNgt, BNgte, BNify, BNlt, compLower } from '../../core'\nimport {\n  VaultBlockParetoDollarYieldSource,\n  VaultBlock,\n  VaultBlockRequest,\n} from '../../vault-blocks'\nimport {\n  Vault,\n  VaultYieldSourceGraphData,\n  VaultYieldSourcesData,\n  VaultYieldSourcesGraphData,\n  VaultYieldSourcesGraphOptions,\n  VaultYieldSourcesSideData,\n} from '../vault.model'\n\n/**\n * Get vault pareto dollar spender\n * @param vault - the vault object\n * @param kind - the spender kind\n * @returns the spender address\n */\nexport function getVaultDollarSpender(vault: Vault, kind: 'MINT' | 'STAKE') {\n  switch (kind) {\n    case 'MINT':\n      return vault.address\n    case 'STAKE':\n      return vault.paretoDollar?.staking.address\n  }\n}\n\n/**\n * Get vault pareto dollar unlent amounts\n * @param block\n * @returns the unlent amounts\n */\nexport function getVaultDollarUnlent(block: VaultBlock): {\n  value: string\n  percentage: string\n} {\n  const queue = block.paretoDollar?.queue\n\n  if (!queue) {\n    throw Error('Wrong vault contract type')\n  }\n\n  const { totalCollateralsScaled, unlentBalanceScaled } = queue\n\n  const total = BNify(totalCollateralsScaled).toString()\n  const unlentValue = BNify(unlentBalanceScaled).toString()\n  const unlentPercentage = BNify(unlentValue).div(total).times(100).toString()\n\n  return { value: unlentValue, percentage: unlentPercentage }\n}\n\n/**\n * Get vault dollar available to deposit\n * @param block - the vault block\n * @returns the amount available to deposit\n */\nexport function getVaultDollarToDeposit(block: VaultBlock): string {\n  const queue = block.paretoDollar?.queue\n\n  if (!queue) {\n    throw Error('Wrong vault contract type')\n  }\n\n  const { unlentBalanceScaled } = queue\n\n  const reserved = getVaultDollarReservedToWithdrawals(block)\n  const toDeposit = BNify(unlentBalanceScaled).minus(reserved).toFixed(0)\n\n  if (BNlt(toDeposit)) {\n    return '0'\n  }\n\n  return toDeposit\n}\n\n/**\n * Get the vualt dollar amount to withdraw net of the withdrawal requests already done\n * @param block - the vault block\n * @param yieldSources - the yield sources data\n */\nexport function getVaultDollarToWithdraw(\n  vault: Vault,\n  block: VaultBlock,\n  { blocks }: VaultYieldSourcesData\n): { pending: string; requested: string; toWithdraw: string } {\n  const pending = BNify(block.paretoDollar?.queue?.prevEpochPending).toFixed(0)\n  const queueAddr = vault.paretoDollar?.queue.address\n\n  if (!blocks || !queueAddr) {\n    return { pending, requested: '0', toWithdraw: pending }\n  }\n\n  // Get USP requests\n  const requests = blocks.reduce<VaultBlockRequest[]>((acc, b) => {\n    const r = (b.requests || []).filter((r) =>\n      compLower(r.walletAddress, queueAddr)\n    )\n    return [...acc, ...r]\n  }, [])\n\n  const requested = requests.reduce(\n    (acc, r) => BNify(acc).plus(BNify(r.amount).times(1e12)).toFixed(0),\n    '0'\n  )\n  const toWithdraw = BNgt(pending, requested)\n    ? BNify(pending).minus(requested).toFixed(0)\n    : '0'\n\n  return { pending, requested, toWithdraw }\n}\n\n/**\n * Get vault dollar reserved withdrawals\n * @param block - the vault block\n * @returns the withdrawals reserved amount\n */\nexport function getVaultDollarReservedToWithdrawals(block: VaultBlock): string {\n  const queue = block.paretoDollar?.queue\n\n  if (!queue) {\n    throw Error('Wrong vault contract type')\n  }\n\n  const { epochPending, totalReservedWithdrawals, prevEpochPending } = queue\n\n  return BNify(totalReservedWithdrawals)\n    .minus(BNify(epochPending))\n    .minus(BNify(prevEpochPending))\n    .toFixed(0)\n}\n\n/**\n * Get vault dollar gain/losses\n * @param block the vault block\n * @returns the gain/losses amount\n */\nexport function getVaultDollarGainLosses(block: VaultBlock): string {\n  const { queue } = block.paretoDollar || {}\n\n  if (!queue) {\n    throw Error('Wrong vault contract type')\n  }\n\n  const { totalCollateralsScaled, totalReservedWithdrawals } = queue\n\n  const gainLosses = BNify(totalCollateralsScaled)\n    .minus(BNify(block.totalSupply))\n    .minus(BNify(totalReservedWithdrawals))\n    .toFixed(0)\n\n  return gainLosses\n}\n\n/**\n * Get vault dollar withdrawed\n * @param block - the vault block\n * @returns the amount withdrawed\n */\nexport function getVaultDollarWithdrawAmounts(block: VaultBlock): {\n  value: string | number\n  percentage: number\n} {\n  const queue = block.paretoDollar?.queue\n\n  if (!queue) {\n    throw Error('Wrong vault contract type')\n  }\n\n  const { prevEpochPending, unlentBalanceScaled } = queue\n  const pendingRequests = BNify(prevEpochPending).toString()\n  const unlent = BNify(unlentBalanceScaled).toString()\n\n  if (BNgte(unlent, pendingRequests)) {\n    return {\n      value: pendingRequests,\n      percentage: 100,\n    }\n  }\n\n  const percentage = BNify(unlent).div(pendingRequests).times(100).toNumber()\n\n  return {\n    value: unlent,\n    percentage,\n  }\n}\n\n/**\n * Get Vault pareto dollar collateralization amounts\n * @param block - the vault block\n * @returns the collateralization amounts\n */\nexport function getVaultDollarCollateralization(block: VaultBlock): {\n  value: string\n  percentage: string\n} {\n  const queue = block.paretoDollar?.queue\n\n  if (!queue) {\n    throw Error('Wrong vault contract type')\n  }\n\n  const { totalSupply } = block\n  const { totalCollateralsScaled } = queue\n\n  const value = BNify(totalCollateralsScaled).toString()\n  const percentage = BNify(value).div(BNify(totalSupply)).times(100).toString()\n\n  return { value, percentage }\n}\n\n/**\n * Get vault pareto dollar allocation data\n * @param block - the vault block\n * @param yieldSource - the yield source\n * @returns the allocation data\n */\nexport function getVaultDollarYieldSourceAllocation(\n  block: VaultBlock,\n  yieldSource: VaultBlockParetoDollarYieldSource\n): { value: number; percentage: number } {\n  const queue = block.paretoDollar?.queue\n\n  if (!queue) {\n    throw Error('Wrong vault contract type')\n  }\n\n  // Get yield source data\n  const total = BNify(queue.totalCollateralsScaled).toString()\n  const value = BNify(yieldSource.depositedAmount).toNumber()\n  const percentage = BNify(yieldSource.depositedAmount)\n    .div(total)\n    .times(100)\n    .toNumber()\n\n  return {\n    percentage,\n    value,\n  }\n}\n\n/**\n * Get vault pareto dollar allocation graph data\n * @param block - the vault block\n * @param vaults - the allocation vaults\n * @param operators - the allocation operators\n * @param tokens - the allocation tokens\n * @returns the allocation data\n */\nexport function getVaultDollarAllocationGraph(\n  block: VaultBlock,\n  sourcesSideData?: VaultYieldSourcesSideData,\n  options?: VaultYieldSourcesGraphOptions\n): VaultYieldSourcesGraphData {\n  const queue = block.paretoDollar?.queue\n\n  if (!queue) {\n    throw Error('Wrong vault contract type')\n  }\n\n  const { totalCollateralsScaled, yieldSources = [] } = queue\n\n  const total = BNify(totalCollateralsScaled).toString()\n  const unlent = getVaultDollarUnlent(block)\n\n  // Parse yield sources data\n  const sources = yieldSources\n    .filter((y) => y.vaultType !== 0)\n    .map((yieldSource) =>\n      parseYieldSourceGraphAllocation(\n        total,\n        yieldSource,\n        sourcesSideData,\n        options\n      )\n    )\n\n  return { total, unlent, sources }\n}\n\nfunction parseYieldSourceGraphAllocation(\n  totalSources: string,\n  yieldSource: VaultBlockParetoDollarYieldSource,\n  sourcesData: VaultYieldSourcesSideData = {},\n  options: VaultYieldSourcesGraphOptions = {}\n): VaultYieldSourceGraphData {\n  const { vaults, operators, tokens } = sourcesData\n  const { currentKey, primaryColor } = options\n\n  // Check yield source type\n  const vault = vaults?.find((v) => v._id === yieldSource.vaultId)\n  const operator = operators?.find(\n    (o) =>\n      o._id === yieldSource.operatorId ||\n      o._id === vault?.cdoEpoch?.borrower.operatorId\n  )\n  const token = tokens?.find((t) => t._id === yieldSource.tokenId)\n\n  // Get yield source data\n  const label = vault?.name || token?.name || operator?.name || 'Yield source'\n  const value = BNify(yieldSource.depositedAmount).toNumber()\n  const percentage = BNify(yieldSource.depositedAmount)\n    .div(totalSources)\n    .times(100)\n    .toNumber()\n\n  const key = vault\n    ? `VAULT_${vault.symbol}`\n    : token\n    ? `TOKEN_${token.symbol}`\n    : operator\n    ? `OPERATOR_${operator.code}`\n    : `YIELD_SOURCE_${yieldSource.sourceAddress}`\n\n  // Yield color\n  const sourceColor = operator?.color || token?.color || primaryColor\n  const color = currentKey === key ? sourceColor : `${sourceColor}66`\n\n  return {\n    key,\n    label,\n    value,\n    percentage,\n    color,\n    data: {\n      vault,\n      operator,\n      token,\n    },\n  }\n}\n\n/**\n * Get vault dollar APR NET\n * @param block - the vault block\n * @param yieldSourcesData yield sources blocks\n * @returns the vault dollar APR\n */\nexport function getVaultDollarAPR(\n  { paretoDollar, pools, APRs }: VaultBlock,\n  yieldSourcesData: {\n    blocks: VaultBlock[]\n  }\n): string | undefined {\n  if (!paretoDollar?.queue || !paretoDollar?.staking) {\n    return\n  }\n\n  const { yieldSources, totalCollateralsScaled } = paretoDollar.queue\n  const { totalAssets } = paretoDollar.staking\n  const { blocks } = yieldSourcesData\n\n  if (!yieldSources?.length || !totalAssets) {\n    return\n  }\n\n  const totalCollateralsScaledBN = BNify(totalCollateralsScaled)\n  const totalAssetsBN = BNify(totalAssets)\n\n  const { num, den, totalDepositedAmount } = yieldSources.reduce(\n    (acc, ys) => {\n      const yieldSourceBlock = blocks.find((b) =>\n        compLower(b.vaultAddress, ys.vaultAddress)\n      )\n\n      if (yieldSourceBlock) {\n        const yieldSourceAPR = BNify(yieldSourceBlock?.APRs.NET)\n        const depositedAmount = BNify(ys.depositedAmount)\n        const aprContribution = yieldSourceAPR.times(depositedAmount)\n        const num = acc.num.plus(aprContribution)\n        const den = acc.den.plus(depositedAmount)\n        const totalDepositedAmount =\n          acc.totalDepositedAmount.plus(depositedAmount)\n\n        return {\n          num,\n          den,\n          totalDepositedAmount,\n        }\n      } else {\n        const poolData = pools?.find((p) =>\n          compLower(p.address, ys.vaultAddress)\n        )\n        if (poolData) {\n          const poolAPR = BNify(poolData.APR)\n          const depositedAmount = BNify(ys.depositedAmount)\n          const aprContribution = poolAPR.times(depositedAmount)\n          const num = acc.num.plus(aprContribution)\n          const den = acc.den.plus(depositedAmount)\n          const totalDepositedAmount =\n            acc.totalDepositedAmount.plus(depositedAmount)\n\n          return {\n            totalDepositedAmount,\n            num,\n            den,\n          }\n        }\n      }\n\n      return acc\n    },\n    {\n      num: BNify(0),\n      den: BNify(0),\n      totalDepositedAmount: BNify(0),\n    }\n  )\n\n  const percentageDeposited = totalDepositedAmount.div(totalCollateralsScaledBN)\n  const weightedAPR = BNgt(den)\n    ? num.div(den).times(percentageDeposited)\n    : BNify(0)\n  const uspAnnualizedYield = totalCollateralsScaledBN.times(weightedAPR)\n  const totalAPRGross =\n    BNgt(uspAnnualizedYield) && BNgt(totalAssetsBN)\n      ? uspAnnualizedYield.div(totalAssetsBN)\n      : 0\n\n  // Calculate net APR\n  const feeFraction = BNify(APRs.FEE).div(100)\n  const netPercentage = BNify(1).minus(feeFraction)\n  const totalAPR = BNify(totalAPRGross).times(netPercentage)\n\n  return BNify(totalAPR).toString()\n}\n\n/**\n * Calculate new dollar APR\n */\nexport function getVaultDollarAPRDelta(\n  action: 'DEPOSIT' | 'WITHDRAW',\n  block: VaultBlock,\n  yieldSourcesData: {\n    blocks: VaultBlock[]\n    actions: { sourceAddress: string; amount: string }[]\n  }\n): {\n  currentApr: number\n  newApr: number\n  delta: number\n} {\n  const { actions } = yieldSourcesData\n  const currentApr = block.APRs.NET || 0\n  const queue = block.paretoDollar?.queue\n\n  if (!actions.length || !queue?.yieldSources?.length) {\n    return {\n      currentApr,\n      newApr: currentApr,\n      delta: 0,\n    }\n  }\n\n  // Update yield sources\n  const newYieldSources = queue?.yieldSources?.map((s) => {\n    const updateAction = actions.find((a) =>\n      compLower(a.sourceAddress, s.sourceAddress)\n    )\n\n    if (!updateAction) {\n      return s\n    }\n\n    const updateAmount = BNify(updateAction.amount)\n    const depositedAmount =\n      action === 'DEPOSIT'\n        ? BNify(s.depositedAmount).plus(updateAmount).toFixed(0)\n        : BNify(s.depositedAmount).minus(updateAmount).toFixed(0)\n\n    return {\n      ...s,\n      depositedAmount,\n    }\n  })\n\n  const totalDelta = actions.reduce(\n    (acc, a) => acc.plus(BNify(a.amount)),\n    BNify(0)\n  )\n  const newTotalCollateralsScaled =\n    action === 'DEPOSIT'\n      ? BNify(queue.totalCollateralsScaled).plus(totalDelta).toFixed(0)\n      : BNify(queue.totalCollateralsScaled).minus(totalDelta).toFixed(0)\n\n  const newBlock: VaultBlock = {\n    ...block,\n    paretoDollar: {\n      ...block.paretoDollar,\n      queue: {\n        ...queue,\n        totalCollateralsScaled: newTotalCollateralsScaled,\n        yieldSources: newYieldSources,\n      },\n    },\n  }\n\n  const aprUpdated = getVaultDollarAPR(newBlock, yieldSourcesData)\n  const newApr = BNify(aprUpdated).toNumber()\n  const delta = BNify(aprUpdated).minus(currentApr).toNumber()\n\n  return {\n    currentApr,\n    newApr,\n    delta,\n  }\n}\n"],"names":["getVaultDollarAPR","getVaultDollarAPRDelta","getVaultDollarAllocationGraph","getVaultDollarCollateralization","getVaultDollarGainLosses","getVaultDollarReservedToWithdrawals","getVaultDollarSpender","getVaultDollarToDeposit","getVaultDollarToWithdraw","getVaultDollarUnlent","getVaultDollarWithdrawAmounts","getVaultDollarYieldSourceAllocation","vault","kind","address","paretoDollar","staking","block","queue","Error","totalCollateralsScaled","unlentBalanceScaled","total","BNify","toString","unlentValue","unlentPercentage","div","times","value","percentage","reserved","toDeposit","minus","toFixed","BNlt","blocks","pending","prevEpochPending","queueAddr","requested","toWithdraw","requests","reduce","acc","b","r","filter","compLower","walletAddress","plus","amount","BNgt","epochPending","totalReservedWithdrawals","gainLosses","totalSupply","pendingRequests","unlent","BNgte","toNumber","yieldSource","depositedAmount","sourcesSideData","options","yieldSources","sources","y","vaultType","map","parseYieldSourceGraphAllocation","totalSources","sourcesData","vaults","operators","tokens","currentKey","primaryColor","find","v","_id","vaultId","operator","o","operatorId","cdoEpoch","borrower","token","t","tokenId","label","name","key","symbol","code","sourceAddress","sourceColor","color","data","pools","APRs","yieldSourcesData","totalAssets","length","totalCollateralsScaledBN","totalAssetsBN","num","den","totalDepositedAmount","ys","yieldSourceBlock","vaultAddress","yieldSourceAPR","NET","aprContribution","poolData","p","poolAPR","APR","percentageDeposited","weightedAPR","uspAnnualizedYield","totalAPRGross","feeFraction","FEE","netPercentage","totalAPR","action","actions","currentApr","newApr","delta","newYieldSources","s","updateAction","a","updateAmount","totalDelta","newTotalCollateralsScaled","newBlock","aprUpdated"],"mappings":"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"}