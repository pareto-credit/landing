{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/vault-performances/libs/vault-performances-block.lib.ts"],"sourcesContent":["import BigNumber from 'bignumber.js'\nimport {\n  apr2apy,\n  Block,\n  BNFixed,\n  BNgt,\n  BNgte,\n  BNify,\n  BNlte,\n  SECONDS_IN_YEAR,\n} from '../../core'\nimport { getTokenAmount, Token, TokenPriceData } from '../../tokens'\nimport { Transaction } from '../../transactions'\nimport { VaultBlockData, VaultBlocks } from '../../vault-blocks'\nimport {\n  VaultBlockEarnings,\n  VaultBlockPerformance,\n  VaultPerformance,\n} from '../vault-performance.model'\nimport { cloneDeep, defaultsDeep } from 'lodash'\nimport { WalletBlock } from '../../wallet-blocks'\nimport {\n  getVaultEpochAvgRate,\n  getVaultEpochBufferDuration,\n  VaultEpoch,\n} from '../../vault-epochs'\nimport moment from 'moment'\nimport { Vault } from '../../vaults'\n\n/**\n * Vault performance initial state\n */\nexport const VAULT_PERFORMANCE: VaultBlockPerformance = {\n  age: 0,\n  holders: 0,\n  earnings: {\n    USD: '0',\n    token: '0',\n    percentage: 0,\n  },\n  realizedAPY: 0,\n  accruedRewards: [],\n}\n\n/**\n * Init vault performance object\n * @param options partial vault performance\n * @returns vault performance object\n */\nexport function initVaultPerformance(\n  performance: Partial<VaultBlockPerformance> = {}\n): VaultBlockPerformance {\n  return defaultsDeep(cloneDeep(performance), VAULT_PERFORMANCE)\n}\n\nexport function initVaultEarnings(\n  earnings: Partial<VaultBlockEarnings> = {}\n): VaultBlockEarnings {\n  return defaultsDeep(cloneDeep(earnings), VAULT_PERFORMANCE.earnings)\n}\n\n/**\n * Calculate earnings percentage between two vault blocks\n * @param vaultBlocks current and last vault blocks\n * @returns earnings percentage\n */\nexport function getEarningsPercentage({\n  current,\n  last,\n}: VaultBlocks): BigNumber {\n  if (!last || BNlte(last.totalSupply)) {\n    return BNify()\n  }\n  return BNgt(last.price)\n    ? BNify(current.price).div(BNify(last.price)).minus(1)\n    : BNify()\n}\n\n/**\n * Calculate wallet earnings using transaction price\n * @param earnings earnings accumulator\n * @param token underlying token\n * @param transaction transaction entity\n * @param lastVaultBlock last vault block entity\n * @returns earnings generated for the transaction\n */\nexport function calculateTransactionEarnings(\n  earnings: BigNumber,\n  token: Token,\n  transaction: Transaction,\n  lastVaultBlock: VaultBlockData\n): BigNumber {\n  const tokenDecimalsDiff = 18 - token.decimals\n  const transactionEarningsPercentage = BNify(transaction.price)\n    .div(BNify(lastVaultBlock.price))\n    .minus(1)\n  const transactionEarnings = BNify(transaction.amount)\n    .times(transactionEarningsPercentage)\n    .div(`1e${tokenDecimalsDiff}`)\n  return earnings.plus(transactionEarnings)\n}\n\n/**\n * Calculate earnings using transactions price\n * @param token underlying token\n * @param lastVaultBlock last vault block\n * @param transactions transactions entities\n * @returns total earnings generated\n */\nexport function calculateTransactionsEarnings(\n  token: Token,\n  lastVaultBlock: VaultBlockData,\n  transactions?: Transaction[]\n): BigNumber {\n  if (!transactions) return BNify()\n  return transactions.reduce(\n    (earnings: BigNumber, transaction: Transaction) => {\n      return calculateTransactionEarnings(\n        earnings,\n        token,\n        transaction,\n        lastVaultBlock\n      )\n    },\n    BNify()\n  )\n}\n\n/**\n * Get vault earnings in underlying token\n * @param token token entity\n * @param vaultBlocks current and last vault blocks\n * @param redeemTransactions redeems transactions\n * @returns vault earnings in underlying tokens\n */\nexport function getVaultEarningsToken(\n  token: Token,\n  { current, last }: VaultBlocks,\n  redeemTransactions?: Transaction[]\n): BigNumber {\n  if (!last || BNlte(last.totalSupply)) {\n    return BNify()\n  }\n\n  const earningsPercentage = getEarningsPercentage({ current, last })\n\n  // Calculate earnings using last totalSupply\n  if (BNgte(current.totalSupply, last.totalSupply)) {\n    const prevNAV = BNify(last.totalSupply).times(last.price).div(1e18)\n    const currentNAV = BNify(last.totalSupply).times(current.price).div(1e18)\n    return currentNAV.minus(prevNAV)\n  }\n\n  // Calculate earnings before redeem and for redeemed amounts using transaction price\n\n  // Needed for token amount decimals\n  const tokenDecimalsDiff = 18 - token.decimals\n\n  // Calculate earnings for remaining totalSupply (after redeem)\n  const earningsToken = BNify(current.totalSupply)\n    .times(earningsPercentage)\n    .div(`1e${tokenDecimalsDiff}`)\n\n  // Calculate redeems earnings\n  const redeemEarnings = calculateTransactionsEarnings(\n    token,\n    last,\n    redeemTransactions\n  )\n\n  // Return total earnings\n  return earningsToken.plus(redeemEarnings)\n}\n\n/**\n * Calculate vault performance earnings\n * @param token vault token entity\n * @param vaultBlocks last and current vault block\n * @param tokenPriceData token USD conversion data\n * @param redeemTransactions transactions with type REDEEM for the current block\n * @returns the vault earnings\n */\nexport function getVaultEarnings(\n  token: Token,\n  { current, last }: VaultBlocks,\n  { price }: TokenPriceData,\n  redeemTransactions?: Transaction[]\n): VaultBlockEarnings {\n  if (!last || BNlte(last.totalSupply)) {\n    return initVaultEarnings()\n  }\n\n  const earningsPercentage = getEarningsPercentage({ current, last })\n  const earningsToken = getVaultEarningsToken(\n    token,\n    { current, last },\n    redeemTransactions\n  )\n  const earningsUSD = earningsToken.times(price).div(getTokenAmount(token))\n\n  return initVaultEarnings({\n    percentage: earningsPercentage.times(100).toNumber(),\n    token: BNFixed(earningsToken),\n    USD: BNFixed(earningsUSD),\n  })\n}\n\n/**\n * Get seconds between current and last vault block\n * @param block current block\n * @param lastVaultBlock last vault block data\n * @returns Seconds passed between two blocks\n */\nexport function getSecondsBetweenBlocks(\n  block: Block,\n  lastVaultBlock: VaultBlockData\n): number {\n  return BNgt(lastVaultBlock.totalSupply)\n    ? block.timestamp - lastVaultBlock.block.timestamp\n    : 0\n}\n\nexport function getVaultPerformanceAge(\n  { current, last }: VaultBlocks,\n  epochsDuration?: number\n) {\n  // Seconds between blocks\n  const totalAge = last ? getSecondsBetweenBlocks(current.block, last) : 0\n\n  // For CDO_EPOCH use the age of en epoch duration to calculate the vault performances\n  if (last?.cdoEpoch?.duration) {\n    if (epochsDuration) {\n      return epochsDuration\n    }\n\n    const totalDuration =\n      last.cdoEpoch.duration + (last.cdoEpoch.bufferDuration || 0)\n\n    return Math.max(1, Math.floor(totalAge / totalDuration)) * totalDuration\n  }\n\n  return totalAge\n}\n\nexport function getVaultRealizedAPR(\n  age: number,\n  earningsPercentage: number\n): number {\n  if (BNlte(age) || BNlte(earningsPercentage)) {\n    return 0\n  }\n  return BNify(earningsPercentage).times(SECONDS_IN_YEAR).div(age).toNumber()\n}\n\n/**\n * Calculate realized APY\n * @param secondsBetweenBlocks seconds between last and current vault block\n * @param earningsPercentage earnings generated between blocks in percentage\n * @returns realized APY\n */\nexport function getVaultRealizedAPY(\n  age: number,\n  earningsPercentage: number,\n  compoundingPeriod = 365\n): number {\n  const APR = getVaultRealizedAPR(age, earningsPercentage)\n  if (BNlte(APR)) {\n    return 0\n  }\n  return apr2apy(BNify(APR).div(100), compoundingPeriod).times(100).toNumber()\n}\n\n/**\n * Get vault finished epochs between blocks\n * @param vaultEpochs vault epochs\n * @param currLastBlocks vault current and prev blocks\n * @param lastWalletBlock last wallet block with balance\n * @returns vault finished epochs\n */\nexport function getVaultFinishedEpochs(\n  vaultEpochs: VaultEpoch[],\n  currLastBlocks: VaultBlocks,\n  lastWalletBlock?: WalletBlock\n): VaultEpoch[] {\n  const { current, last } = currLastBlocks\n\n  const minTimestamp = Math.max(\n    lastWalletBlock?.block.timestamp || 0,\n    last?.block.timestamp || 0\n  )\n\n  return vaultEpochs.filter(\n    (vaultEpoch) =>\n      vaultEpoch.status === 'FINISHED' &&\n      moment(vaultEpoch.startDate).isSameOrAfter(moment.unix(minTimestamp)) &&\n      moment(vaultEpoch.endDate).isSameOrBefore(\n        moment.unix(current.block.timestamp)\n      )\n  )\n}\n\nexport function getVaultEpochPerformance(\n  vaultEpochs: VaultEpoch[],\n  { current, last }: VaultBlocks,\n  latestWalletBlockWithBalance: WalletBlock | undefined,\n  token: Token,\n  tokenPrice: TokenPriceData,\n  walletBlocksHolders?: WalletBlock[],\n  lastPerformance?: VaultPerformance,\n  redeemTransactions?: Transaction[]\n): VaultBlockPerformance {\n  if (!last || BNlte(last.totalSupply)) {\n    return initVaultPerformance()\n  }\n\n  const finishedEpochs = getVaultFinishedEpochs(\n    vaultEpochs,\n    { current, last },\n    latestWalletBlockWithBalance\n  )\n\n  if (!finishedEpochs.length) {\n    return initVaultPerformance()\n  }\n\n  const epochsDuration = finishedEpochs.reduce(\n    (duration, epoch) => duration + epoch.duration + epoch.bufferDuration,\n    0\n  )\n\n  const avgEpochDurationDays = epochsDuration / finishedEpochs.length / 86400\n\n  const compoundingPeriod = Math.ceil(\n    BigNumber.maximum(1, BNify(365).div(avgEpochDurationDays)).toNumber()\n  )\n\n  // Update holders\n  const holders = (walletBlocksHolders || []).filter((b) =>\n    BNgt(b.balance)\n  ).length\n  const newHolders = BNify(holders)\n    .minus(BNify(lastPerformance?.holders))\n    .toNumber()\n\n  // Calculate earnings\n  const earnings = getVaultEarnings(\n    token,\n    { current, last },\n    tokenPrice,\n    redeemTransactions\n  )\n\n  // Set age as finished epochs duration\n  const age = epochsDuration\n\n  // Realized APY\n  // TODO: this is APR, need to be converted into APY\n  const realizedAPY = getVaultRealizedAPY(\n    age,\n    earnings.percentage,\n    compoundingPeriod\n  )\n\n  return initVaultPerformance({\n    age,\n    earnings,\n    holders: newHolders,\n    realizedAPY: realizedAPY,\n  })\n}\n\n/**\n * Get vault performance options by vault contract type\n * @param vault vault object\n * @param vaultEpochs vault epochs\n * @param vaultBlocks vault current and previous blocks\n * @param latestWalletBlockWithBalance latest wallet block with balance\n * @returns vault performance options including age and compounding period\n */\nexport function getVaultPerformanceOptions(\n  vault: Vault,\n  vaultEpochs: VaultEpoch[],\n  vaultBlocks: VaultBlocks,\n  latestWalletBlockWithBalance: WalletBlock | undefined\n): {\n  age: number\n  epochs?: number\n  avgAPY?: number\n  avgAPR?: number\n  compoundingPeriod: number\n} {\n  switch (vault.contractType) {\n    case 'CDO_EPOCH': {\n      const finishedEpochs = getVaultFinishedEpochs(\n        vaultEpochs,\n        vaultBlocks,\n        latestWalletBlockWithBalance\n      )\n\n      const totalDuration = finishedEpochs.reduce(\n        (duration, epoch) =>\n          duration +\n          epoch.duration +\n          getVaultEpochBufferDuration(vault.cdoEpoch, epoch.bufferDuration),\n        0\n      )\n\n      if (BNlte(totalDuration)) {\n        return {\n          age: 0,\n          compoundingPeriod: 365,\n          epochs: finishedEpochs.length,\n        }\n      }\n\n      const avgEpochDurationDays = totalDuration / finishedEpochs.length / 86400\n\n      const compoundingPeriod = Math.ceil(\n        BigNumber.maximum(1, BNify(365).div(avgEpochDurationDays)).toNumber()\n      )\n\n      const finishedEpochsDurations = finishedEpochs.map(\n        (e) =>\n          e.duration +\n          getVaultEpochBufferDuration(vault.cdoEpoch, e.bufferDuration)\n      )\n      const avgAPY = getVaultEpochAvgRate(\n        finishedEpochs.map((e) => e.APYs?.NET || 0),\n        finishedEpochsDurations\n      )\n      const avgAPR = getVaultEpochAvgRate(\n        finishedEpochs.map((e) => e.APRs?.NET || 0),\n        finishedEpochsDurations\n      )\n\n      return {\n        avgAPY,\n        avgAPR,\n        age: totalDuration,\n        compoundingPeriod,\n        epochs: finishedEpochs.length,\n      }\n    }\n    default: {\n      return {\n        age: getVaultPerformanceAge(vaultBlocks),\n        compoundingPeriod: 365,\n      }\n    }\n  }\n}\n\n/**\n * Calculate vault performances\n * @param block - the current block\n * @param vaultBlocks - the current and the latest blocks\n * @param tokenData - the token data\n * @returns the current vault performance\n */\nexport function getVaultPerformance(\n  { current, last }: VaultBlocks,\n  token: Token,\n  tokenPrice: TokenPriceData,\n  options: {\n    age?: number\n    avgAPY?: number\n    compoundingPeriod?: number\n    walletBlocksHolders?: WalletBlock[]\n    lastPerformance?: VaultPerformance\n    redeemTransactions?: Transaction[]\n  }\n): VaultBlockPerformance {\n  if (!last || BNlte(last.totalSupply)) {\n    return initVaultPerformance()\n  }\n\n  const {\n    compoundingPeriod = 365,\n    walletBlocksHolders,\n    lastPerformance,\n    redeemTransactions,\n  } = options\n\n  // Update holders\n  const holders = (walletBlocksHolders || []).filter((b) =>\n    BNgt(b.balance)\n  ).length\n  const newHolders = BNify(holders)\n    .minus(BNify(lastPerformance?.holders))\n    .toNumber()\n\n  // Calculate earnings\n  const earnings = getVaultEarnings(\n    token,\n    { current, last },\n    tokenPrice,\n    redeemTransactions\n  )\n\n  // Get vault performance age\n  const age = options.age || getVaultPerformanceAge({ current, last })\n\n  // Realized APY\n  const realizedAPY =\n    options.avgAPY ||\n    getVaultRealizedAPY(age, earnings.percentage, compoundingPeriod)\n\n  return initVaultPerformance({\n    age,\n    earnings,\n    holders: newHolders,\n    realizedAPY: realizedAPY,\n  })\n}\n\n/**\n * Calculate performance aggregation\n * @param currentPerformance - the performance of the current block\n * @param vaultBlocks - the current and the latest blocks\n * @returns the aggregation of the performances\n */\nexport function getVaultAggregatedPerformance(\n  currentPerformance: VaultBlockPerformance,\n  lastPerformance?: VaultBlockPerformance\n): VaultBlockPerformance {\n  if (!lastPerformance) {\n    return currentPerformance\n  }\n\n  // Update holders\n  const holders = BNify(lastPerformance.holders).plus(\n    currentPerformance.holders\n  )\n\n  // Earnings\n  const earnings = {\n    token: BNify(lastPerformance.earnings.token)\n      .plus(currentPerformance.earnings.token)\n      .toFixed(0),\n    USD: BNify(lastPerformance.earnings.USD)\n      .plus(currentPerformance.earnings.USD)\n      .toFixed(0),\n    percentage: BNify(lastPerformance.earnings.percentage)\n      .plus(currentPerformance.earnings.percentage)\n      .toNumber(),\n  }\n\n  // Age\n  const age = BNify(lastPerformance.age).plus(currentPerformance.age).toNumber()\n\n  const realizedAPY = BNgt(age)\n    ? BNify(lastPerformance.realizedAPY)\n        .times(lastPerformance.age || 0)\n        .plus(\n          BNify(currentPerformance.realizedAPY).times(currentPerformance.age)\n        )\n        .div(age)\n    : BNify()\n\n  return initVaultPerformance({\n    age,\n    holders: holders.toNumber(),\n    earnings,\n    realizedAPY: realizedAPY.toNumber(),\n  })\n}\n"],"names":["VAULT_PERFORMANCE","calculateTransactionEarnings","calculateTransactionsEarnings","getEarningsPercentage","getSecondsBetweenBlocks","getVaultAggregatedPerformance","getVaultEarnings","getVaultEarningsToken","getVaultEpochPerformance","getVaultFinishedEpochs","getVaultPerformance","getVaultPerformanceAge","getVaultPerformanceOptions","getVaultRealizedAPR","getVaultRealizedAPY","initVaultEarnings","initVaultPerformance","age","holders","earnings","USD","token","percentage","realizedAPY","accruedRewards","performance","defaultsDeep","cloneDeep","current","last","BNlte","totalSupply","BNify","BNgt","price","div","minus","transaction","lastVaultBlock","tokenDecimalsDiff","decimals","transactionEarningsPercentage","transactionEarnings","amount","times","plus","transactions","reduce","redeemTransactions","earningsPercentage","BNgte","prevNAV","currentNAV","earningsToken","redeemEarnings","earningsUSD","getTokenAmount","toNumber","BNFixed","block","timestamp","epochsDuration","totalAge","cdoEpoch","duration","totalDuration","bufferDuration","Math","max","floor","SECONDS_IN_YEAR","compoundingPeriod","APR","apr2apy","vaultEpochs","currLastBlocks","lastWalletBlock","minTimestamp","filter","vaultEpoch","status","moment","startDate","isSameOrAfter","unix","endDate","isSameOrBefore","latestWalletBlockWithBalance","tokenPrice","walletBlocksHolders","lastPerformance","finishedEpochs","length","epoch","avgEpochDurationDays","ceil","BigNumber","maximum","b","balance","newHolders","vault","vaultBlocks","contractType","getVaultEpochBufferDuration","epochs","finishedEpochsDurations","map","e","avgAPY","getVaultEpochAvgRate","APYs","NET","avgAPR","APRs","options","currentPerformance","toFixed"],"mappings":"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"}