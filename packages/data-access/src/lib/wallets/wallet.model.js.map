{"version":3,"sources":["../../../../../../../libs/shared/data-access/src/lib/wallets/wallet.model.ts"],"sourcesContent":["import S from 'fluent-json-schema'\nimport {\n  WalletPortfolio,\n  WalletPosition,\n  WalletVaultHistory,\n} from '../wallet-performances'\nimport { WALLETS_ROUTES_KEY } from './wallet.const'\nimport {\n  sBCAddress,\n  sClientEntity,\n  sStringId,\n  ClientEntity,\n  iBigInt,\n  Block,\n  PageSearchQuery,\n  Page,\n  sHexString,\n  sPageSearchQuery,\n  sEmail,\n  sDateString,\n} from '../core'\nimport {\n  sVaultContractType,\n  sVaultsSearchQuery,\n  VaultContractType,\n  VaultsSearchQuery,\n} from '../vaults'\nimport { User } from '../users'\n\n/**\n * Client Wallet interface\n */\nexport interface Wallet extends WalletData, ClientEntity {}\n\nexport function sWallet(isPartial?: boolean) {\n  return S.object()\n    .id('#wallet')\n    .additionalProperties(false)\n    .extend(sClientEntity(isPartial))\n    .extend(sWalletData(isPartial))\n}\n\nexport interface WalletData extends WalletBody {\n  // Wallet BlockChain Address\n  address: string\n}\n\nexport function sWalletData(isPartial?: boolean) {\n  return S.object()\n    .additionalProperties(false)\n    .prop('address', sBCAddress())\n    .required(isPartial ? [] : ['address'])\n    .extend(sWalletBody())\n}\n\nexport interface WalletBody {\n  userId?: string\n  referralCode?: string\n\n  // Ethereum Name Service\n  ens?: string\n\n  // Wallet signatures\n  signatures?: WalletSignature[]\n\n  // Wallet campaigns\n  campaigns?: WalletCampaign[]\n\n  // The wallets children that are referred by this wallet\n  affiliates?: WalletAffiliate[]\n\n  // The wallets parents that referred this wallet\n  referred?: WalletReferred[]\n}\n\nexport function sWalletBody() {\n  return S.object()\n    .additionalProperties(false)\n    .prop('userId', sStringId())\n    .prop('ens', S.string())\n    .prop('referralCode', S.string().minLength(6).maxLength(12))\n    .prop('signatures', S.array().items(sWalletSignature()))\n    .prop('campaigns', S.array().items(sWalletCampaign()))\n    .prop('affiliates', S.array().items(sWalletAffiliate()))\n    .prop('referred', S.array().items(sWalletReferred()))\n}\n\nexport interface WalletUserBody {\n  name?: string\n  email?: string\n  telegram?: string\n}\n\nexport function sWalletUserBody() {\n  return S.object()\n    .additionalProperties(false)\n    .prop('name', S.string())\n    .description('User name')\n    .prop('email', sEmail())\n    .description('User email')\n    .prop('telegram', S.string())\n    .description('User telegram profile')\n}\n\nexport interface WalletContractData {\n  balance?: iBigInt\n  allowance?: iBigInt\n}\n\nexport interface WalletAmounts {\n  balance: iBigInt\n  allowance: iBigInt\n}\n\nexport interface WalletSignature {\n  _id: string\n  hash: string\n  signedOn: string\n}\n\nexport function sWalletSignature() {\n  return S.object()\n    .additionalProperties(false)\n    .prop('_id', sStringId())\n    .required()\n    .prop('hash', sHexString())\n    .required()\n    .prop('signedOn', sDateString())\n    .required()\n}\n\nexport interface WalletCampaign {\n  _id: string\n  referralCode: string\n  activatedOn: string\n}\n\nexport function sWalletCampaign() {\n  return S.object()\n    .additionalProperties(false)\n    .prop('_id', sStringId())\n    .required()\n    .prop('referralCode', S.string())\n    .required()\n    .prop('activatedOn', sDateString())\n    .required()\n}\n\nexport interface WalletAffiliate {\n  _id: string\n  address: string\n  activatedOn: string\n}\n\nexport function sWalletAffiliate() {\n  return S.object()\n    .additionalProperties(false)\n    .prop('_id', sStringId())\n    .required()\n    .prop('address', sBCAddress())\n    .required()\n    .prop('activatedOn', sDateString())\n    .required()\n}\n\nexport interface WalletReferred extends WalletAffiliate {\n  referralCode: string\n}\n\nexport function sWalletReferred() {\n  return S.object()\n    .additionalProperties(false)\n    .prop('referralCode', S.string().minLength(6).maxLength(12))\n    .required()\n    .extend(sWalletAffiliate())\n}\n\nexport interface WalletPortfolioQuery\n  extends WalletPortfolioFilters,\n    VaultsSearchQuery {}\n\nexport function sWalletPortfolioQuery() {\n  return S.object()\n    .additionalProperties(false)\n    .extend(sVaultsSearchQuery())\n    .extend(sWalletPortfolioFilters())\n}\n\nexport interface WalletPortfolioFilters {\n  vaultId?: string | string[]\n  'block:gte'?: Block['number']\n  'block:lte'?: Block['number']\n  'timestamp:gte'?: Block['timestamp']\n  'timestamp:lte'?: Block['timestamp']\n}\n\nexport function sWalletPortfolioFilters() {\n  return S.object()\n    .additionalProperties(false)\n    .prop('vaultId', S.array().minItems(1).maxItems(200).items(sStringId()))\n    .description('VaultID that must match')\n    .prop('block:gte', S.number())\n    .description('Start block')\n    .prop('block:lte', S.number())\n    .description('End Block')\n    .prop('timestamp:gte', S.number())\n    .description('Start timestamp')\n    .prop('timestamp:lte', S.number())\n    .description('End timestamp')\n}\n\nexport interface WalletAccess {\n  vaults: WalletVault[]\n  canAccessManager: boolean\n}\n\nexport function sWalletAccess() {\n  return S.object()\n    .additionalProperties(false)\n    .prop('vaults', S.array().items(sWalletVault()))\n    .required()\n    .prop('canAccessManager', S.boolean())\n    .required()\n}\n\nexport interface WalletVault {\n  vaultId: string\n  contractType: VaultContractType\n  role: WalletRole\n}\n\nexport function sWalletVault() {\n  return S.object()\n    .additionalProperties(false)\n    .prop('vaultId', sStringId())\n    .required()\n    .prop('contractType', sVaultContractType())\n    .required()\n    .prop('role', sWalletRole())\n    .required()\n}\n\nexport type WalletRole = 'MANAGER' | 'BORROWER'\n\nexport function sWalletRole() {\n  return S.string().enum(['MANAGER', 'BORROWER'])\n}\n\nexport enum WalletErrorCodes {\n  vaultsMissing = 'VAULT_IDS_MISSING',\n  alreadyExists = 'WALLET_ALREADY_EXISTS',\n  notDeletable = 'WALLET_NOT_DELETABLE',\n  malformed = 'WALLET_ADDRESS_MALFORMED',\n  notFound = 'WALLET_NOT_FOUND',\n}\n\nexport enum WalletRoutes {\n  v1Access = `v1/${WALLETS_ROUTES_KEY}/:walletId/access`,\n  v1Create = `v1/${WALLETS_ROUTES_KEY}`,\n  v1Delete = `v1/${WALLETS_ROUTES_KEY}/:walletId`,\n  v1Ensure = `v1/${WALLETS_ROUTES_KEY}/ensure`,\n  v1Perform = `v1/${WALLETS_ROUTES_KEY}/:walletId/perform`,\n  v1Portfolio = `v1/${WALLETS_ROUTES_KEY}/:walletId/portfolio`,\n  v1Read = `v1/${WALLETS_ROUTES_KEY}/:walletId`,\n  v1Referral = `v1/${WALLETS_ROUTES_KEY}/:walletId/referral`,\n  v1Search = `v1/${WALLETS_ROUTES_KEY}`,\n  v1Update = `v1/${WALLETS_ROUTES_KEY}/:walletId`,\n  v1User = `v1/${WALLETS_ROUTES_KEY}/:walletId/user`,\n  v1Vaults = `v1/${WALLETS_ROUTES_KEY}/:walletId/vaults`,\n  v1History = `v1/${WALLETS_ROUTES_KEY}/:walletId/history/:vaultId`,\n}\n\nexport type WalletFields =\n  | '_id'\n  | 'address'\n  | 'userId'\n  | 'ens'\n  | 'signatures'\n  | 'createdAt'\n  | 'createdBy'\n  | 'updatedAt'\n  | 'updatedBy'\n\nexport const WALLET_FIELDS = [\n  '_id',\n  'address',\n  'userId',\n  'ens',\n  'signatures',\n  'createdAt',\n  'createdBy',\n  'updatedAt',\n  'updatedBy',\n]\n\nexport const WALLET_SORT_FIELDS = ['address']\n\nexport function sWalletsSearchQuery() {\n  return S.object()\n    .additionalProperties(false)\n    .prop('address', sBCAddress())\n    .description('Wallet blockchain address')\n    .extend(sPageSearchQuery(WALLET_FIELDS, WALLET_SORT_FIELDS))\n}\n\nexport type WalletSideData =\n  | 'kyc'\n  | 'position'\n  | 'signature'\n  | 'balance'\n  | 'deposit'\n  | 'withdrawable'\n  | 'depositAllowance'\n  | 'depositSpender'\n  | 'withdrawSpender'\n  | 'withdrawAllowance'\n\nexport interface WalletsSearchQuery\n  extends PageSearchQuery<'address', WalletFields> {\n  address?: string\n}\nexport enum WalletsRoutingKey {\n  paretoEvents = 'pareto.wallet.*',\n  paretoPerform = 'pareto.wallet.perform',\n}\n\nexport type WalletVaultHistorySort = 'timestamp'\n\nexport interface WalletVaultHistoryQuery\n  extends PageSearchQuery<WalletVaultHistorySort, ''> {}\n\nexport interface WalletsClientModel {\n  search: (params?: WalletsSearchQuery) => Promise<Page<Wallet>>\n  list: (params?: WalletsSearchQuery) => Promise<Wallet[]>\n  findOne: (params?: WalletsSearchQuery) => Promise<Wallet | undefined>\n  readOne: (params: WalletsSearchQuery) => Promise<Wallet>\n  portfolio: (\n    walletId: string,\n    params?: WalletPortfolioQuery\n  ) => Promise<WalletPortfolio>\n  vaults: (\n    walletId: string,\n    params?: WalletPortfolioQuery\n  ) => Promise<WalletPosition[]>\n  vault: (\n    walletId: string,\n    vaultId: string,\n    params?: WalletVaultHistoryQuery\n  ) => Promise<Page<WalletVaultHistory>>\n  ensure: (address: string) => Promise<Wallet>\n  user: (\n    walletId: string,\n    body: { name?: string; email?: string; telegram?: string }\n  ) => Promise<User>\n  referral: (walletId: string, referral: string) => Promise<Wallet>\n  access: (walletId: string) => Promise<WalletAccess>\n}\n"],"names":["WALLET_FIELDS","WALLET_SORT_FIELDS","sWallet","sWalletAccess","sWalletAffiliate","sWalletBody","sWalletCampaign","sWalletData","sWalletPortfolioFilters","sWalletPortfolioQuery","sWalletReferred","sWalletRole","sWalletSignature","sWalletUserBody","sWalletVault","sWalletsSearchQuery","isPartial","S","object","id","additionalProperties","extend","sClientEntity","prop","sBCAddress","required","sStringId","string","minLength","maxLength","array","items","description","sEmail","sHexString","sDateString","sVaultsSearchQuery","minItems","maxItems","number","boolean","sVaultContractType","enum","WalletErrorCodes","WalletRoutes","WALLETS_ROUTES_KEY","sPageSearchQuery","WalletsRoutingKey"],"mappings":"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"}