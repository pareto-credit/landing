{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/campaigns/libs/campaign-points.lib.ts"],"sourcesContent":["import { orderBy } from 'lodash'\nimport moment from 'moment'\nimport BigNumber from 'bignumber.js'\n\nimport {\n  BlockMock,\n  BNFixed,\n  BNFloat,\n  BNgt,\n  BNgte,\n  BNify,\n  BNlte,\n} from '../../core'\nimport { Transaction, TransactionMock } from '../../transactions'\nimport { Vault, VaultPool } from '../../vaults'\nimport {\n  getWalletBlockBalance,\n  getWalletBlockTokenBalance,\n  getWalletStakedTokenBalance,\n  WalletBlock,\n  WalletBlockBalanceField,\n  WalletBlockMock,\n} from '../../wallet-blocks'\nimport {\n  Campaign,\n  CampaignBoost,\n  CampaignMetrics,\n  CampaignMetricsReward,\n  CampaignPoints,\n  CampaignPointsVault,\n  CampaignReward,\n  CampaignRule,\n  CampaignRuleDepositType,\n  CampaignRuleTrigger,\n} from '../campaign.model'\nimport { fixTokenAmount, Token } from '../../tokens'\nimport { CampaignPoint } from '../../campaign-points'\nimport { Web3Protocol } from '../../web3-client'\nimport { WalletPerformance } from '../../wallet-performances'\nimport { WalletReferred } from '../../wallets'\n\nconst CAMPAIGN_METRICS: CampaignMetrics = {\n  points: '0',\n  perDay: '0',\n  multiplier: '1',\n  multiplierScaled: '1',\n}\n\n/**\n * Get campaign points\n * @param campaign - the campaign\n * @param vaults - the vault campaign\n * @param transactions - the vault transactions\n */\nexport function getCampaignPoints(\n  campaign: Campaign,\n  campaignVaults: Vault[],\n  transactions: Transaction[],\n  walletBlocks: WalletBlock[],\n  tokens: Token[],\n  campaignTokens?: Token[],\n  affiliatedPoints?: CampaignPoint[],\n  affiliatedPerformances?: WalletPerformance[],\n  referred?: WalletReferred[]\n): CampaignPoints {\n  // Calculate vaults points\n  const vaults = campaignVaults.map((v) =>\n    getCampaignVaultPoints(\n      campaign,\n      v,\n      transactions.filter((t) => t.vaultId === v._id),\n      walletBlocks.filter((b) => b.vaultId === v._id),\n      tokens.find((t) => t._id === v.tokenId),\n      campaignTokens\n    )\n  )\n\n  const referredIds = (referred || []).map((r) => r._id)\n  const referredBlocks = walletBlocks.filter((b) =>\n    referredIds.includes(b.walletId)\n  )\n\n  // Calculate boosts\n  const { points: rulePoints } = computeMetrics(vaults)\n  const boosts = (campaign.boosts || [])\n    .filter((b) => !b.vaultIds?.length)\n    .map((b) => {\n      const boostToken = b.tokenId\n        ? campaignTokens?.find((t) => t._id === b.tokenId)\n        : undefined\n      return getCampaignBoostPoints(\n        b,\n        rulePoints,\n        affiliatedPoints,\n        affiliatedPerformances,\n        referredBlocks,\n        boostToken\n      )\n    })\n\n  // Calculate aggregation\n  const { points, perDay, multiplier, rewards } = computeMetrics(\n    vaults,\n    boosts,\n    false\n  )\n\n  return {\n    points,\n    perDay,\n    multiplier,\n    vaults,\n    rewards,\n  }\n}\n\n/**\n * Get campaign vault points\n * @param campaign - the campaign\n * @param vault - the vault\n * @param transactions - the wallet transactions\n * @param walletBlock -  the wallet block\n * @returns the vault points\n */\nexport function getCampaignVaultPoints(\n  campaign: Campaign,\n  vault: Vault,\n  transactions: Transaction[],\n  walletBlocks: WalletBlock[],\n  token?: Token,\n  campaignTokens?: Token[]\n): CampaignPointsVault {\n  // Check rules\n  const vaultCampaign = vault.campaigns?.find((c) => c._id === campaign._id)\n  const campaignRules = campaign.rules?.filter(\n    (r) => !r.vaultIds || r.vaultIds.includes(vault._id)\n  )\n  const vaultRules = campaignRules || vaultCampaign?.rules\n\n  if (!vaultRules?.length || !token) {\n    return { _id: vault._id, ...CAMPAIGN_METRICS }\n  }\n\n  // Calculate vaults points\n  const rules: CampaignMetrics[] = vaultRules\n    .filter((r) => !r.vaultIds || r.vaultIds.includes(vault._id))\n    .map((r) => {\n      const ruleToken = r.deposit.tokenId\n        ? campaignTokens?.find((t) => t._id === r.deposit.tokenId)\n        : token\n      const ruleMetrics = getCampaignRuleVaultPoints(\n        campaign,\n        r,\n        transactions,\n        walletBlocks,\n        ruleToken || token,\n        vault.pools || []\n      )\n      return {\n        code: r.code,\n        ...ruleMetrics,\n      }\n    })\n\n  const boosts: CampaignMetrics[] = (campaign.boosts || [])\n    .filter((b) => !!b.vaultIds?.includes(vault._id))\n    .map((b) => {\n      const boostToken = b.tokenId\n        ? campaignTokens?.find((t) => t._id === b.tokenId)\n        : token\n      const boostMetrics = getCampaignBoostVaultPoints(\n        campaign,\n        b,\n        walletBlocks,\n        boostToken || token,\n        vault.pools || []\n      )\n\n      return {\n        rules: b.rules,\n        ...boostMetrics,\n      }\n    })\n\n  const boostedRules = applyBoostsToRules(rules, boosts)\n\n  const { points, perDay, multiplier, rewards, multiplierScaled } =\n    boostedRules.reduce((acc, v) => makeMetrics(acc, v), CAMPAIGN_METRICS)\n\n  return {\n    _id: vault._id,\n    points,\n    perDay,\n    rewards,\n    multiplier,\n    multiplierScaled,\n  }\n}\n\n/**\n * Get campaign rule vault points\n * @param rule - the campaign rule\n * @param vault - the vault\n * @param transactions - the wallet transactions\n * @param walletBlock -  the wallet block\n * @returns the rule vault points\n */\nexport function getCampaignRuleVaultPoints(\n  campaign: Campaign,\n  rule: CampaignRule,\n  transactions: Transaction[],\n  walletBlocks: WalletBlock[],\n  token: Token,\n  vaultPools: VaultPool[]\n): CampaignMetrics {\n  const options = {\n    startDate: campaign.startDate || campaign.createdAt,\n    endDate: campaign.endDate,\n    vaultPools,\n  }\n\n  switch (rule.trigger) {\n    case 'DEPOSIT': {\n      switch (rule.deposit.type) {\n        case 'BALANCE':\n          return getRuleDepositBalancePoints(rule, walletBlocks, token, options)\n        case 'BALANCE_SUSP':\n          return getRuleDepositBalancePoints(rule, walletBlocks, token, {\n            ...options,\n            balanceField: 'suspAggregated',\n            includeYT: true, // Include YT for BALANCE_SUSP as they represent actual balance\n          })\n        case 'BALANCE_USP':\n          return getRuleDepositBalancePoints(rule, walletBlocks, token, {\n            ...options,\n            balanceField: 'uspPools',\n          })\n        case 'POOL_BALANCE':\n          return getRuleDepositBalancePoints(rule, walletBlocks, token, {\n            ...options,\n            balanceField: 'poolTokenBalance',\n          })\n        case 'AGE':\n          return getRuleDepositAgePoints(rule, walletBlocks, options)\n        default:\n          return CAMPAIGN_METRICS\n      }\n    }\n    case 'DEPOSIT_REQUEST': {\n      const depositRequestPoints = getRuleQueuePoints(\n        rule,\n        transactions,\n        token,\n        options\n      )\n      return depositRequestPoints\n    }\n  }\n}\n\n/**\n * Get campaign vault boost points\n * @param rule - the campaign rule\n * @param vault - the vault\n * @param transactions - the wallet transactions\n * @param walletBlock -  the wallet block\n * @param token -  the vault token\n * @returns the rule vault points\n */\nexport function getCampaignBoostVaultPoints(\n  campaign: Campaign,\n  boost: CampaignBoost,\n  walletBlocks: WalletBlock[],\n  token: Token,\n  vaultPools: VaultPool[]\n): CampaignMetrics {\n  const options = {\n    startDate: campaign.startDate || campaign.createdAt,\n    endDate: campaign.endDate,\n    vaultPools,\n  }\n\n  const poolsFilter = (vaultPools || []).reduce(\n    (acc: VaultPool[], p) =>\n      p.ref && (boost.pools || []).includes(p.ref) ? [...acc, p] : [...acc],\n    []\n  )\n\n  switch (boost.type) {\n    case 'STAKE': {\n      return getBoostStakeRewards(boost, walletBlocks, token, options)\n    }\n    case 'DEPOSIT_NAPIER':\n      return getBoostStakeRewards(boost, walletBlocks, token, {\n        ...options,\n        protocols: ['NapierLP', 'NapierYT'],\n        poolsFilter,\n      })\n    case 'DEPOSIT_PENDLE':\n      return getBoostStakeRewards(boost, walletBlocks, token, {\n        ...options,\n        protocols: ['PendleLP', 'PendleSY', 'PendleYT'],\n        poolsFilter,\n      })\n    case 'SUPPLY_EULER':\n      return getBoostStakeRewards(boost, walletBlocks, token, {\n        ...options,\n        protocols: ['EulerSupply'],\n      })\n    case 'SUPPLY_TERM':\n      return getBoostStakeRewards(boost, walletBlocks, token, {\n        ...options,\n        protocols: ['TermFinance'],\n      })\n    case 'DEPOSIT_BALANCER': {\n      return getBoostStakeRewards(boost, walletBlocks, token, {\n        ...options,\n        protocols: ['Balancer'],\n      })\n    }\n    default:\n      return CAMPAIGN_METRICS\n  }\n}\n\n/**\n * Get campaign boost points\n * @param rule - the campaign rule\n * @param affiliatedPoints - the affiliated points\n * @returns the boost global points\n */\nexport function getCampaignBoostPoints(\n  boost: CampaignBoost,\n  totalPoints: string,\n  affiliatedPoints?: CampaignPoint[],\n  affiliatedPerformances?: WalletPerformance[],\n  referredBlocks?: WalletBlock[],\n  token?: Token\n): CampaignMetrics {\n  switch (boost.type) {\n    case 'REFERRAL':\n      return getBoostReferralReward(boost, affiliatedPoints)\n    case 'REFERRAL_FEE':\n      return getBoostReferralFeeReward(boost, affiliatedPerformances)\n    case 'REFERRED':\n      return getBoostReferredReward(boost, totalPoints, referredBlocks, token)\n    default:\n      return CAMPAIGN_METRICS\n  }\n}\n\n/**\n * Get rule deposit balance points\n * @param rule - the rule campaign\n * @param walletBlocks - the wallet blocks\n * @param token - the vault token\n * @param options - the calculation options\n * @returns the campaign points\n */\nexport function getRuleDepositBalancePoints(\n  { frequency, reward }: CampaignRule,\n  walletBlocks: WalletBlock[],\n  token: Token,\n  options: {\n    startDate: string\n    endDate?: string\n    balanceField?: WalletBlockBalanceField\n    vaultPools?: VaultPool[]\n    poolsFilter?: VaultPool[]\n    includeYT?: boolean\n  }\n): CampaignMetrics {\n  const {\n    startDate,\n    endDate,\n    balanceField,\n    vaultPools,\n    poolsFilter,\n    includeYT,\n  } = options\n\n  // Order and filter wallet blocks\n  const blocks = orderBy(walletBlocks, 'block.number', 'asc')\n\n  // Fake current block\n  const lastBlock = blocks.length ? blocks[blocks.length - 1] : undefined\n  const currentBlock = WalletBlockMock({\n    block: { timestamp: moment(endDate).unix() },\n    tokenBalance: lastBlock\n      ? getWalletBlockBalance(lastBlock, balanceField, {\n          token,\n          vaultPools,\n          poolsFilter,\n          includeYT,\n        })\n      : '0',\n  })\n\n  return [...blocks, currentBlock].reduce<CampaignMetrics>((acc, b, i) => {\n    // Check the block timestamp\n    if (\n      moment.unix(b.block.timestamp).isBefore(moment(startDate)) ||\n      moment.unix(b.block.timestamp).isAfter(moment(endDate))\n    ) {\n      return acc\n    }\n\n    // Age calculation\n    const prevBlock = blocks[i - 1]\n    const prevTimestamp = prevBlock?.block.timestamp || 0\n    const prevBalance = prevBlock\n      ? getWalletBlockBalance(prevBlock, balanceField, {\n          token,\n          vaultPools,\n          poolsFilter,\n          includeYT,\n        })\n      : '0'\n\n    const date = moment.unix(prevTimestamp).isAfter(startDate)\n      ? moment.unix(prevTimestamp)\n      : moment(startDate)\n    const delta = moment\n      .unix(b.block.timestamp)\n      .diff(date, frequency.unit, true)\n    const ageMultiplier = BNify(delta).div(frequency.value).toString()\n    const balance = fixTokenAmount(token, prevBalance)\n    const rulePoints = BNify(balance).times(reward.value).times(ageMultiplier)\n\n    // Points per day\n    const distributionDays = moment\n      .duration(frequency.value, frequency.unit)\n      .asDays()\n    const pointsPerDay =\n      i === blocks.length && BNgt(balance, 0)\n        ? BNify(balance).times(reward.value).div(distributionDays).toString()\n        : 0\n\n    return {\n      points: BNify(acc.points).plus(rulePoints).toString(),\n      perDay: BNify(acc.perDay).plus(pointsPerDay).toString(),\n      multiplier: acc.multiplier,\n    }\n  }, CAMPAIGN_METRICS)\n}\n\n/**\n * Get rule deposit age points\n * @param rule - the rule campaign\n * @param walletBlocks - the wallet blocks\n * @param options - the calculation options\n * @returns the campaign points\n */\nexport function getRuleDepositAgePoints(\n  { frequency, reward }: CampaignRule,\n  walletBlocks: WalletBlock[],\n  options: {\n    startDate: string\n    endDate?: string\n  }\n): CampaignMetrics {\n  const { startDate, endDate } = options\n\n  // Order and filter wallet blocks\n  let age = 0\n  const blocks = orderBy(walletBlocks, 'block.number', 'asc')\n\n  // Fake current block\n  const currentBlock = WalletBlockMock({\n    block: { timestamp: moment(endDate).unix() - 1 },\n  })\n\n  return [...blocks, currentBlock].reduce<CampaignMetrics>((acc, b, i) => {\n    // Check the block timestamp\n    if (\n      !moment\n        .unix(b.block.timestamp)\n        .isBetween(moment(startDate), moment(endDate))\n    ) {\n      return acc\n    }\n\n    const prevBlock = blocks[i - 1]\n    const prevBalance = prevBlock ? getWalletBlockBalance(prevBlock) : '0'\n    if (BNgt(prevBalance)) {\n      const date = moment.unix(prevBlock?.block.timestamp).isAfter(startDate)\n        ? moment.unix(prevBlock?.block.timestamp)\n        : moment(startDate)\n      const delta = moment\n        .unix(b.block.timestamp)\n        .diff(date, frequency.unit, true)\n      age += delta\n    }\n\n    const ruleMultiplier = age >= frequency.value ? reward.value : 1\n    const multiplier = BigNumber.maximum(acc.multiplier, ruleMultiplier)\n\n    return {\n      points: acc.points,\n      perDay: acc.perDay,\n      multiplier: multiplier.toString(),\n    }\n  }, CAMPAIGN_METRICS)\n}\n\n/**\n * Get boost stake rewards\n * @param boost boost object\n * @param transactions vault transactions\n * @param walletBlocks wallet blocks\n * @param token vault token\n * @param options campaign options\n * @returns boost rewards\n */\nexport function getBoostStakeRewards(\n  boost: CampaignBoost,\n  walletBlocks: WalletBlock[],\n  token: Token,\n  options: {\n    protocols?: Web3Protocol[]\n    balanceField?: WalletBlockBalanceField\n    startDate: string\n    endDate?: string\n    vaultPools?: VaultPool[]\n    poolsFilter?: VaultPool[]\n  }\n): CampaignMetrics {\n  const { reward } = boost\n\n  // Calculate age between request and process\n  const boostRewards = getBoostRewards(token, reward, walletBlocks, options)\n\n  const multiplierScaled = BNgt(boostRewards.totalAge)\n    ? boostRewards.multiplier.div(boostRewards.totalAge)\n    : '1'\n\n  return {\n    perDay: '0',\n    rules: boost.rules,\n    points: boostRewards.points.toFixed(0),\n    multiplierScaled: BNFloat(multiplierScaled, 4),\n    multiplier: BNFloat(boostRewards.lastMultiplier, 4),\n  }\n}\n\n/**\n * Get boost referral fees reward\n * @param boost - the campaign boost\n * @param affiliatedPoints - the affiliated fees\n * @returns the metrics\n */\nexport function getBoostReferralFeeReward(\n  { reward }: CampaignBoost,\n  affiliatedPerformances?: WalletPerformance[]\n): CampaignMetrics {\n  switch (reward.type) {\n    case 'AMOUNT':\n      return {\n        points: BNify(reward.value).toString(),\n        perDay: '0',\n        multiplier: '1',\n      }\n    case 'PERCENTAGE': {\n      if (!affiliatedPerformances?.length) {\n        return CAMPAIGN_METRICS\n      }\n\n      const totalFeesUSD = affiliatedPerformances.reduce(\n        (acc, p) => BNify(acc).plus(p.fees.USD).toString(),\n        '0'\n      )\n\n      return {\n        points: '0',\n        rewards: [\n          {\n            USD: BNify(totalFeesUSD).times(reward.value).div(100).toString(),\n          },\n        ],\n        perDay: '0',\n        multiplier: '1',\n      }\n    }\n    default:\n      return CAMPAIGN_METRICS\n  }\n}\n\n/**\n * Get boost referral reward\n * @param boost - the campaign boost\n * @param affiliatedPoints - the affiliated points\n * @returns the metrics\n */\nexport function getBoostReferralReward(\n  { reward }: CampaignBoost,\n  affiliatedPoints?: CampaignPoint[]\n): CampaignMetrics {\n  switch (reward.type) {\n    case 'AMOUNT':\n      return {\n        points: BNify(reward.value).toString(),\n        perDay: '0',\n        multiplier: '1',\n      }\n    case 'PERCENTAGE': {\n      if (!affiliatedPoints?.length) {\n        return CAMPAIGN_METRICS\n      }\n\n      const totalPoints = affiliatedPoints.reduce(\n        (acc, p) => BNify(acc).plus(p.points).toString(),\n        '0'\n      )\n      return {\n        points: BNify(totalPoints).times(reward.value).div(100).toString(),\n        perDay: '0',\n        multiplier: '1',\n      }\n    }\n    default:\n      return CAMPAIGN_METRICS\n  }\n}\n\n/**\n * Get boost referred reward\n * @param param0\n * @param totalPoints\n */\nexport function getBoostReferredReward(\n  { reward }: CampaignBoost,\n  totalPoints: string,\n  referredBlocks?: WalletBlock[],\n  token?: Token\n): CampaignMetrics {\n  if (!referredBlocks) {\n    return CAMPAIGN_METRICS\n  }\n\n  // Select referred blocks with at least 100 USP if token is specified\n  const referred = token\n    ? referredBlocks.filter((wB) =>\n        BNgte(getWalletBlockBalance(wB, 'uspAggregated', { token }), 100 * 1e18)\n      )\n    : referredBlocks\n\n  if (!referred?.length) {\n    return CAMPAIGN_METRICS\n  }\n\n  switch (reward.type) {\n    case 'AMOUNT': {\n      const points = BNify(reward.value).times(referred.length).toString()\n      return {\n        points,\n        perDay: '0',\n        multiplier: '1',\n      }\n    }\n\n    case 'PERCENTAGE': {\n      if (BNlte(totalPoints)) {\n        return CAMPAIGN_METRICS\n      }\n\n      const rewardPoints = BNify(totalPoints).times(reward.value).div(100)\n      const points = rewardPoints.times(referred.length).toString()\n\n      return {\n        points,\n        perDay: '0',\n        multiplier: '1',\n      }\n    }\n    default:\n      return CAMPAIGN_METRICS\n  }\n}\n\n/**\n * Calculate boost rewards from walletBlocks\n * @param reward campaign reward data\n * @param walletBlocks wallet blocks\n * @param vaultType vault type\n * @param stakedAmount wallet staked amount\n * @returns boost rewards\n */\nexport function calculateBoostBlockRewards(\n  token: Token,\n  reward: CampaignReward,\n  walletBlock: WalletBlock,\n  vaultPools?: VaultPool[],\n  protocols?: Web3Protocol[],\n  poolsFilter?: VaultPool[]\n): {\n  points?: BigNumber\n  multiplier?: BigNumber\n  stakedAmount: BigNumber\n  blockBalance: BigNumber\n} {\n  // Get staked amount\n  const stakedAmount = BNify(\n    getWalletStakedTokenBalance(\n      token._id,\n      walletBlock,\n      0,\n      vaultPools,\n      protocols,\n      poolsFilter\n    )\n  )\n\n  const blockBalance = BNify(\n    getWalletBlockTokenBalance(token, walletBlock, vaultPools)\n  )\n\n  const rewards = {\n    points: BNify(0),\n    multiplier: BNify(1),\n    stakedAmount,\n    blockBalance,\n  }\n\n  switch (reward.type) {\n    case 'AMOUNT':\n      return {\n        ...rewards,\n        points: BNify(reward.value),\n      }\n    case 'MULTIPLIER': {\n      const stakedPercentage =\n        BNgt(stakedAmount) && BNgt(blockBalance)\n          ? stakedAmount.div(blockBalance)\n          : 0\n\n      const multiplier = BNgt(stakedPercentage)\n        ? BNify(1).plus(BNify(reward.value - 1).times(stakedPercentage))\n        : BNify(1)\n\n      return {\n        ...rewards,\n        multiplier,\n      }\n    }\n  }\n  return rewards\n}\n\n/**\n * Get boost rewards for a specific wallet\n * @param token token object\n * @param reward campaign reward\n * @param walletBlocks wallet blocks\n * @returns\n */\nexport function getBoostRewards(\n  token: Token,\n  reward: CampaignReward,\n  walletBlocks: WalletBlock[],\n  options: {\n    protocols?: Web3Protocol[]\n    balanceField?: WalletBlockBalanceField\n    startDate: string\n    endDate?: string\n    vaultPools?: VaultPool[]\n    poolsFilter?: VaultPool[]\n  }\n) {\n  const { startDate, endDate, protocols, vaultPools, poolsFilter } = options\n\n  const nowTimestamp = moment().unix()\n  const startTimestamp = moment(startDate).unix()\n  const endTimestamp = endDate ? moment(endDate).unix() : nowTimestamp\n\n  const orderedBlocks: WalletBlock[] = orderBy(\n    walletBlocks,\n    'block.number',\n    'asc'\n  )\n\n  const firstWalletBlock = orderedBlocks.find((wb) =>\n    BNgt(\n      getWalletBlockBalance(wb, 'tokenAggregated', {\n        token,\n        vaultPools,\n      })\n    )\n  )\n\n  const filteredWalletBlocks = orderedBlocks.filter((wb) =>\n    BNgte(wb.block.number, firstWalletBlock?.block.number)\n  )\n\n  // Fake current block\n  const lastBlock = filteredWalletBlocks.length\n    ? filteredWalletBlocks[filteredWalletBlocks.length - 1]\n    : undefined\n\n  const currentTimestamp = Math.min(nowTimestamp, endTimestamp)\n  const currentBlock = WalletBlockMock({\n    ...(lastBlock || {}),\n    block: BlockMock({ ...lastBlock?.block, timestamp: currentTimestamp }),\n  })\n\n  const blocks = [...filteredWalletBlocks, currentBlock]\n\n  return blocks.reduce(\n    (acc, walletBlock, i) => {\n      const nextWalletBlock = blocks[i + 1]\n      if (!nextWalletBlock) {\n        return acc\n      }\n\n      // Use campaign start/end date as time bounds\n      const nextTimestamp = Math.min(\n        endTimestamp,\n        nextWalletBlock.block.timestamp\n      )\n      const blockTimestamp = Math.max(\n        startTimestamp,\n        walletBlock.block.timestamp\n      )\n\n      const age = nextTimestamp - blockTimestamp\n      if (age < 0) {\n        return acc\n      }\n\n      const blocksRewards = calculateBoostBlockRewards(\n        token,\n        reward,\n        walletBlock,\n        vaultPools,\n        protocols,\n        poolsFilter\n      )\n\n      const blockWeight = blocksRewards.blockBalance.times(age)\n      const blockScaledMultiplier = BNify(blocksRewards.multiplier).times(\n        blockWeight\n      )\n      const multiplier = acc.multiplier.plus(blockScaledMultiplier)\n      const totalAge = acc.totalAge.plus(blockWeight)\n\n      return {\n        ...acc,\n        totalAge,\n        points: acc.points.plus(blocksRewards.points || 0),\n        multiplier,\n        stakedAmount: blocksRewards.stakedAmount,\n        lastMultiplier: BNify(blocksRewards.multiplier),\n        totalStakedAmount: acc.totalStakedAmount.plus(\n          blocksRewards.stakedAmount\n        ),\n      }\n    },\n    {\n      totalAge: BNify(0),\n      points: BNify(0),\n      multiplier: BNify(0),\n      stakedAmount: BNify(0),\n      lastMultiplier: BNify(1),\n      totalStakedAmount: BNify(0),\n    }\n  )\n}\n\n/**\n * Get rule queue balance points\n * @param rule - the rule campaign\n * @param transactions - the vault transactions\n * @param options - the calculation options\n * @returns the campaign points\n */\nexport function getRuleQueuePoints(\n  rule: CampaignRule,\n  transactions: Transaction[],\n  token: Token,\n  options: {\n    startDate: string\n    endDate?: string\n  }\n): CampaignMetrics {\n  const { frequency, reward } = rule\n  const { startDate, endDate } = options\n\n  // Fake current transaction\n  const currentTransaction = TransactionMock({\n    type: 'PROCESS_DEPOSIT_QUEUE',\n    block: { timestamp: moment(endDate).unix() - 1 },\n  })\n\n  // Order and filter transactions\n  const orderedTxs = orderBy(transactions, 'block.number', 'asc')\n  const txs = [...orderedTxs, currentTransaction].filter((t) =>\n    moment.unix(t.block.timestamp).isBetween(moment(startDate), moment(endDate))\n  )\n\n  // Check first request deposit and first process queue\n  const processDeposit = txs.find((t) => t.type === 'PROCESS_DEPOSIT_QUEUE')\n  const requestDeposits = txs.filter(\n    (t) =>\n      t.type === 'REQUEST_DEPOSIT' &&\n      t.block.timestamp < (processDeposit?.block.timestamp || 0)\n  )\n\n  // Check request deposit\n  if (!requestDeposits.length || !processDeposit) {\n    return CAMPAIGN_METRICS\n  }\n\n  // Check cancel deposit\n  const cancelDeposit = txs.find((t) => t.type === 'DELETE_DEPOSIT_REQUEST')\n\n  if (\n    cancelDeposit &&\n    moment\n      .unix(cancelDeposit.block.timestamp)\n      .isBefore(moment.unix(processDeposit.block.timestamp))\n  ) {\n    const cancelDepositIndex =\n      txs.findIndex((t) => t.type === 'DELETE_DEPOSIT_REQUEST') + 1\n    return getRuleQueuePoints(\n      rule,\n      txs.slice(cancelDepositIndex),\n      token,\n      options\n    )\n  }\n\n  // Calculate age between request and process\n  let totalReward = BNify(0)\n  let perDayReward = BNify(0)\n\n  const distributionDays = moment\n    .duration(frequency.value, frequency.unit)\n    .asDays()\n\n  for (const request of requestDeposits) {\n    const delta = moment\n      .unix(processDeposit.block.timestamp)\n      .diff(moment.unix(request.block.timestamp), frequency.unit)\n\n    const ageMultiplier = BNify(delta).div(frequency.value)\n    const requestAmount = fixTokenAmount(token, request.tokenAmount)\n    const requestReward = BNify(requestAmount).times(ageMultiplier)\n\n    totalReward = totalReward.plus(requestReward)\n\n    // Points per day\n    const pointsPerDay = BNgt(requestAmount, 0)\n      ? BNify(requestAmount)\n          .times(reward.value)\n          .div(distributionDays)\n          .toString()\n      : 0\n\n    perDayReward = perDayReward.plus(pointsPerDay)\n  }\n\n  const rulePoints = BNify(reward.value).times(totalReward)\n\n  // Get next points\n  const nextIndex = txs.findIndex((t) => t.type === 'PROCESS_DEPOSIT_QUEUE')\n\n  if (nextIndex <= 0) {\n    return {\n      points: rulePoints.toString(),\n      perDay: perDayReward.toString(),\n      multiplier: '1',\n    }\n  }\n\n  const { points, perDay } = getRuleQueuePoints(\n    rule,\n    txs.slice(nextIndex + 1),\n    token,\n    options\n  )\n\n  return {\n    points: rulePoints.plus(points).toString(),\n    perDay: perDayReward.plus(perDay).toString(),\n    multiplier: '1',\n  }\n}\n\n/**\n * Apply boosts to rules\n * @param rules rules\n * @param boosts boosts\n * @returns boosted rules\n */\nfunction applyBoostsToRules(\n  rules: CampaignMetrics[],\n  boosts: CampaignMetrics[] = []\n): CampaignMetrics[] {\n  // Aggregate rules metrics to extract the maximum multiplier to apply\n  const { multiplier: ruleMultiplier } = rules.reduce(\n    (acc, v) => makeMetrics(acc, v),\n    CAMPAIGN_METRICS\n  )\n\n  return rules.map((rule) => {\n    const basePoints = BNify(rule.points)\n    const basePerDay = BNify(rule.perDay)\n\n    // Get boosts to be applied to this rule\n    const relevantBoosts = boosts.filter(\n      (b) => !b.rules?.length || (rule.code && b.rules.includes(rule.code))\n    )\n\n    const maxBoostMultiplier = relevantBoosts.reduce(\n      (acc, b) => BigNumber.max(acc, b.multiplier || '1'),\n      BNify('1')\n    )\n\n    const totalMultiplierScaled = relevantBoosts.reduce(\n      (acc, b) => acc.times(b.multiplierScaled || '1'),\n      BNify('1')\n    )\n\n    const effectivePoints = basePoints.times(ruleMultiplier)\n    const effectivePerDay = basePerDay.times(ruleMultiplier)\n\n    const boostedPoints = effectivePoints.times(totalMultiplierScaled)\n    const boostedPerDay = effectivePerDay.times(maxBoostMultiplier)\n\n    return {\n      code: rule.code,\n      rewards: rule.rewards || [],\n      points: boostedPoints.toFixed(0),\n      perDay: boostedPerDay.toFixed(0),\n      multiplier: BNFloat(BigNumber.max(maxBoostMultiplier, ruleMultiplier), 4),\n      multiplierScaled: BNFloat(totalMultiplierScaled, 4),\n    }\n  })\n}\n\n/**\n * Generic function to calculate or aggregate metrics\n * @param rules - the base metrics (rules or vaults)\n * @param boosts - the boost metrics\n * @param applyMultiplier - whether to apply the rules multiplier\n * @returns the computed CampaignMetrics\n */\nfunction computeMetrics<T extends CampaignMetrics>(\n  rules: T[],\n  boosts: T[] = [],\n  applyMultiplier?: boolean\n): CampaignMetrics {\n  const {\n    points: rulesPoints,\n    perDay: rulesPerDay,\n    multiplier: rulesMultiplier,\n    rewards: rulesRewards,\n  } = rules.reduce((acc, r) => makeMetrics(acc, r), CAMPAIGN_METRICS)\n\n  const {\n    points: boostsPoints,\n    perDay: boostsPerDay,\n    multiplier: boostsMultiplier,\n    multiplierScaled,\n    rewards: boostsRewards,\n  } = boosts.reduce((acc, b) => makeMetrics(acc, b), CAMPAIGN_METRICS)\n\n  const multiplier = BigNumber.max(rulesMultiplier, boostsMultiplier).toString()\n\n  const boostsPointsScaled = BNify(boostsPoints).times(multiplierScaled || '1')\n\n  const points = applyMultiplier\n    ? BNify(rulesPoints).times(rulesMultiplier).plus(boostsPointsScaled)\n    : BNify(rulesPoints).plus(boostsPointsScaled)\n\n  const perDay = applyMultiplier\n    ? BNify(rulesPerDay).times(rulesMultiplier).plus(boostsPerDay)\n    : BNify(rulesPerDay).plus(boostsPerDay)\n\n  const finalPerDay = perDay.times(boostsMultiplier).toString()\n\n  const rewards = mergeRewards(\n    [],\n    [...(rulesRewards || []), ...(boostsRewards || [])]\n  )\n\n  return {\n    rewards,\n    points: points.toString(),\n    perDay: finalPerDay,\n    multiplier,\n    multiplierScaled,\n  }\n}\n\n/**\n * Campaign metrics accumulator\n * @param acc accumulator\n * @param item campaign metric\n * @returns campaign metrics\n */\nexport function makeMetrics<T extends CampaignMetrics>(\n  acc: CampaignMetrics,\n  item: T\n) {\n  const points = BNify(item.points).plus(acc.points)\n  const perDay = BNify(item.perDay).plus(acc.perDay)\n  const multiplierScaled = BNify(acc.multiplierScaled).times(\n    item.multiplierScaled || '1'\n  )\n  const multiplier = BigNumber.maximum(item.multiplier, acc.multiplier)\n\n  const rewards = mergeRewards(acc.rewards || [], item.rewards || [])\n\n  return {\n    rewards,\n    points: points.toString(),\n    perDay: perDay.toString(),\n    multiplier: multiplier.toString(),\n    multiplierScaled: multiplierScaled.toString(),\n  }\n}\n\n/**\n * Aggregate rewards by tokenId or USD\n * @param source source rewards\n * @param target target rewards\n * @returns aggregated rewards amounts\n */\nexport function mergeRewards(\n  source: CampaignMetricsReward[],\n  target: CampaignMetricsReward[]\n): CampaignMetricsReward[] {\n  return [...source, ...target].reduce<CampaignMetricsReward[]>((acc, r) => {\n    const existing = acc.find((r) => r.tokenId === r.tokenId)\n\n    const amount = BNify(r.amount ?? '0')\n    const USD = BNify(r.USD ?? '0')\n\n    // Update reward amounts\n    if (existing) {\n      existing.amount = BNFixed(BNify(existing.amount ?? '0').plus(amount))\n      existing.USD = BNFixed(BNify(existing.USD ?? '0').plus(USD))\n    } else {\n      // Add reward\n      const reward: CampaignMetricsReward = {\n        USD: BNFixed(USD),\n        ...(r.tokenId && { tokenId: r.tokenId, amount: BNFixed(amount) }),\n      }\n      acc.push(reward)\n    }\n\n    return acc\n  }, [])\n}\n\n/**\n * Get campaign deposit point\n * @param campaign - the campaign\n * @param trigger - the rule trigger\n * @param token - the deposit token\n * @param depositAmount - the deposit amount\n * @returns the campaign point\n */\nexport function getCampaignPointsPerDay(\n  campaign: Campaign,\n  trigger: CampaignRuleTrigger,\n  depositType: CampaignRuleDepositType,\n  token: Token,\n  vaultId: string,\n  depositAmount = '1000000' // $1\n): string {\n  const rules = campaign.rules?.filter(\n    (r) =>\n      r.trigger === trigger &&\n      r.deposit.type === depositType &&\n      (!r.vaultIds || r.vaultIds.includes(vaultId))\n  )\n  const deposit = fixTokenAmount(token, depositAmount)\n\n  if (!rules?.length || BNlte(deposit, 0)) {\n    return '0'\n  }\n\n  return rules.reduce((acc, { frequency, reward }) => {\n    // const points = BNify(deposit).times(r.reward.value)\n    const distributionDays = moment\n      .duration(frequency.value, frequency.unit)\n      .asDays()\n    const pointsPerDay = BNify(deposit)\n      .times(reward.value)\n      .div(distributionDays)\n      .toString()\n\n    return BNify(acc).plus(pointsPerDay).toString()\n  }, '0')\n}\n"],"names":["calculateBoostBlockRewards","getBoostReferralFeeReward","getBoostReferralReward","getBoostReferredReward","getBoostRewards","getBoostStakeRewards","getCampaignBoostPoints","getCampaignBoostVaultPoints","getCampaignPoints","getCampaignPointsPerDay","getCampaignRuleVaultPoints","getCampaignVaultPoints","getRuleDepositAgePoints","getRuleDepositBalancePoints","getRuleQueuePoints","makeMetrics","mergeRewards","CAMPAIGN_METRICS","points","perDay","multiplier","multiplierScaled","campaign","campaignVaults","transactions","walletBlocks","tokens","campaignTokens","affiliatedPoints","affiliatedPerformances","referred","vaults","map","v","filter","t","vaultId","_id","b","find","tokenId","referredIds","r","referredBlocks","includes","walletId","rulePoints","computeMetrics","boosts","vaultIds","length","boostToken","undefined","rewards","vault","token","vaultCampaign","campaigns","c","campaignRules","rules","vaultRules","ruleToken","deposit","ruleMetrics","pools","code","boostMetrics","boostedRules","applyBoostsToRules","reduce","acc","rule","vaultPools","options","startDate","createdAt","endDate","trigger","type","balanceField","includeYT","depositRequestPoints","boost","poolsFilter","p","ref","protocols","totalPoints","frequency","reward","blocks","orderBy","lastBlock","currentBlock","WalletBlockMock","block","timestamp","moment","unix","tokenBalance","getWalletBlockBalance","i","isBefore","isAfter","prevBlock","prevTimestamp","prevBalance","date","delta","diff","unit","ageMultiplier","BNify","div","value","toString","balance","fixTokenAmount","times","distributionDays","duration","asDays","pointsPerDay","BNgt","plus","age","isBetween","ruleMultiplier","BigNumber","maximum","boostRewards","totalAge","toFixed","BNFloat","lastMultiplier","totalFeesUSD","fees","USD","wB","BNgte","BNlte","rewardPoints","walletBlock","stakedAmount","getWalletStakedTokenBalance","blockBalance","getWalletBlockTokenBalance","stakedPercentage","nowTimestamp","startTimestamp","endTimestamp","orderedBlocks","firstWalletBlock","wb","filteredWalletBlocks","number","currentTimestamp","Math","min","BlockMock","nextWalletBlock","nextTimestamp","blockTimestamp","max","blocksRewards","blockWeight","blockScaledMultiplier","totalStakedAmount","currentTransaction","TransactionMock","orderedTxs","txs","processDeposit","requestDeposits","cancelDeposit","cancelDepositIndex","findIndex","slice","totalReward","perDayReward","request","requestAmount","tokenAmount","requestReward","nextIndex","basePoints","basePerDay","relevantBoosts","maxBoostMultiplier","totalMultiplierScaled","effectivePoints","effectivePerDay","boostedPoints","boostedPerDay","applyMultiplier","rulesPoints","rulesPerDay","rulesMultiplier","rulesRewards","boostsPoints","boostsPerDay","boostsMultiplier","boostsRewards","boostsPointsScaled","finalPerDay","item","source","target","existing","amount","BNFixed","push","depositType","depositAmount"],"mappings":"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"}