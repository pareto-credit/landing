{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/wallet-performances/libs/wallet-performances-block.lib.ts"],"sourcesContent":["import BigNumber from 'bignumber.js'\nimport { fixAmount, getTokenAmount, Token, TokenPriceData } from '../../tokens'\nimport {\n  Block,\n  BNFixed,\n  BNgt,\n  BNify,\n  BNlte,\n  compLower,\n  iBigInt,\n  Reward,\n} from '../../core'\nimport {\n  WalletBlockAmounts,\n  WalletBlockEarnings,\n  WalletBlockPerformance,\n  WalletDistributedRewards,\n  WalletPerformance,\n  WalletPortfolio,\n  WalletPosition,\n  WalletPositionToken,\n} from '../wallet-performance.model'\nimport { cloneDeep, defaultsDeep } from 'lodash'\nimport {\n  WALLET_PERFORMANCE,\n  WALLET_PORTFOLIO,\n  WALLET_POSITION,\n} from '../wallet-performance.const'\nimport {\n  getWalletBlockBalance,\n  getWalletBlockPoolTokenBalanceUSD,\n  getPendleWalletBalanceByRef,\n  makeWalletPoolTokensData,\n  WalletBlock,\n  WalletBlockData,\n} from '../../wallet-blocks'\nimport { VaultBlock, VaultBlocks } from '../../vault-blocks'\nimport { VaultBlockPerformance } from '../../vault-performances'\nimport { Vault, VaultWalletPoolData } from '../../vaults'\n\n/**\n * Init wallet performance object\n * @param options partial vault performance\n * @returns wallet performance object\n */\nexport function initWalletPerformance(\n  performance: Partial<WalletBlockPerformance> = {}\n): WalletBlockPerformance {\n  return defaultsDeep(cloneDeep(performance), WALLET_PERFORMANCE)\n}\n\n/**\n * Init wallet performance object\n * @param options partial vault performance\n * @returns wallet performance object\n */\nexport function initWalletPortfolio(\n  position: Partial<WalletPortfolio> = {}\n): WalletPortfolio {\n  return defaultsDeep(cloneDeep(position), WALLET_PORTFOLIO)\n}\n\n/**\n * Init wallet position object\n * @param options partial vault position\n * @returns wallet position object\n */\nexport function initWalletPosition(\n  position: Partial<WalletPosition> = {}\n): WalletPosition {\n  return defaultsDeep(cloneDeep(position), WALLET_POSITION)\n}\n\n/**\n * Init wallet earnings object\n * @param earnings partial earnings\n * @returns wallet earnings object\n */\nexport function initWalletEarnings(\n  earnings: Partial<WalletBlockEarnings> = {}\n): WalletBlockEarnings {\n  return defaultsDeep(cloneDeep(earnings), WALLET_PERFORMANCE.earnings)\n}\n\nconst WALLET_BLOCK_AMOUNTS: WalletBlockAmounts = {\n  USD: '0',\n}\n\n/**\n * Init wallet block amounts object\n * @param options partial wallet block amounts\n * @returns wallet block amounts object\n */\nexport function initWalletBlockAmounts(\n  amounts: Partial<WalletBlockAmounts> = {}\n): WalletBlockAmounts {\n  return defaultsDeep(cloneDeep(amounts), WALLET_BLOCK_AMOUNTS)\n}\n\n/**\n * Calculate wallet earnings\n * @param token vault token entity\n * @param tokenBalance wallet balance in underlying tokens\n * @param earningsPercentage earnings percentage\n * @param tokenPriceData token USD conversion data\n * @returns the wallet earnings\n */\nexport function getWalletEarnings(\n  token: Token,\n  tokenBalance: iBigInt,\n  earningsPercentage: number,\n  { price }: TokenPriceData\n): WalletBlockEarnings {\n  // Calculate earnings\n  const earningsToken = BNify(tokenBalance).times(earningsPercentage).div(100)\n  const earningsUSD = earningsToken.times(price).div(getTokenAmount(token))\n\n  return initWalletEarnings({\n    percentage: earningsPercentage,\n    token: BNFixed(earningsToken),\n    USD: BNFixed(earningsUSD),\n  })\n}\n\n/**\n * Calculate wallet rewards eranings\n * @param distributedRewards distributed rewards\n * @returns wallet rewards earnings\n */\nexport function getWalletRewardsEarnings(\n  distributedRewards: WalletDistributedRewards[]\n): WalletBlockEarnings {\n  return distributedRewards.reduce((acc: WalletBlockEarnings, r) => {\n    const USD = BNFixed(BNify(acc.USD).plus(r.amountUSD))\n    const percentage = BNify(acc.percentage).plus(r.percentage).toNumber()\n    return {\n      USD,\n      percentage,\n    }\n  }, initWalletEarnings())\n}\n\n/**\n * Calculate age between current block and last wallet performance block\n * @param block current block\n * @param lastWalletBlock last wallet block\n * @param lastWalletPerformance last wallet performance block\n * @returns age in seconds\n */\nexport function calculateWalletPerformanceAge(\n  block: Block,\n  lastWalletBlock: WalletBlockData,\n  lastWalletPerformance: WalletPerformance | undefined\n): number {\n  // First wallet performance block\n  if (!lastWalletPerformance) {\n    return block.timestamp - lastWalletBlock.block.timestamp\n  }\n\n  // Get max timestamp between walletBlock and walletPerformance\n  const latestTimestamp = BNgt(lastWalletPerformance.age)\n    ? BigNumber.maximum(\n        BNify(lastWalletPerformance?.block.timestamp),\n        lastWalletBlock.block.timestamp\n      ).toNumber()\n    : lastWalletBlock.block.timestamp\n\n  // Calculate age from last wallet performance or from wallet block\n  return block.timestamp - latestTimestamp\n}\n\n/**\n * Calculate wallet last performance\n * @param lastWalletBlock - the last wallet block\n * @param lastWalletPerformance - the last performance of the wallet\n * @param vaultBlocks - the current and last vault blocks\n * @param currentVaultPerformance - the current vault performance\n * @param tokenPriceData - the token price data\n * @returns the current wallet performance\n */\nexport function getWalletPerformance(\n  vault: Vault,\n  token: Token,\n  lastWalletBlock: WalletBlockData,\n  lastWalletPerformance: WalletPerformance | undefined,\n  { current: currentVault, last: lastVault }: VaultBlocks,\n  vaultPerformance: VaultBlockPerformance,\n  tokenPrice: TokenPriceData,\n  distributedRewards?: WalletDistributedRewards[]\n): WalletBlockPerformance {\n  const { feePercentage, pools } = vault\n\n  const balance = getWalletBlockBalance(lastWalletBlock, 'poolTokenBalance', {\n    token,\n    vaultPools: pools,\n    startBalance: lastWalletBlock.balance,\n    timestamp: currentVault.block.timestamp,\n  })\n\n  // Exit if last wallet tokenBalance <= 0\n  if (BNlte(balance)) {\n    return initWalletPerformance()\n  }\n  // Get performance age\n  const age = calculateWalletPerformanceAge(\n    currentVault.block,\n    lastWalletBlock,\n    lastWalletPerformance\n  )\n\n  // If age <= 0 return empty performance\n  if (BNlte(age)) {\n    return initWalletPerformance()\n  }\n\n  const tokenBalance = BNFixed(\n    BNify(balance)\n      .times(lastVault?.price || getTokenAmount(token, 1))\n      .div(1e18)\n  )\n\n  // Calculate earnings\n  const earnings = getWalletEarnings(\n    token,\n    tokenBalance,\n    vaultPerformance.earnings.percentage,\n    tokenPrice\n  )\n\n  // Fees\n  const fees = {\n    USD: BNFixed(BNify(earnings.USD).times(fixAmount(feePercentage, 5))),\n    token: BNFixed(BNify(earnings.token).times(fixAmount(feePercentage, 5))),\n  }\n\n  const rewards = distributedRewards?.length\n    ? getWalletRewardsEarnings(distributedRewards)\n    : initWalletEarnings()\n\n  // Realized APY and share percentage\n  const realizedAPY = BNify(vaultPerformance.realizedAPY)\n\n  // Calculate pool share using latest vault block totalSupply\n  const poolSharePercentage = BNgt(lastVault?.totalSupply)\n    ? BNify(balance).div(BNify(lastVault?.totalSupply))\n    : BNify()\n\n  return initWalletPerformance({\n    startBlock: lastVault?.block || lastWalletBlock.block,\n    endBlock: currentVault.block,\n    age,\n    fees,\n    balance: BNFixed(fixAmount(balance, 18)),\n    tokenBalance: BNFixed(tokenBalance),\n    earnings: {\n      ...earnings,\n      rewards,\n    },\n    realizedAPY: realizedAPY.toNumber(),\n    poolSharePercentage: poolSharePercentage.times(100).toNumber(),\n  })\n}\n\n/**\n * Aggregate rewards earnings by tokenId\n * @param rewards distributed rewards\n * @returns aggregated earnings\n */\nexport function getWalletAccruedRewards(\n  rewards: WalletDistributedRewards[]\n): Reward[] {\n  return rewards.reduce((acc: Reward[], reward) => {\n    const foundReward = acc.find((r) => r.tokenId === reward.tokenId)\n    return foundReward\n      ? acc.map((r) =>\n          r.tokenId === reward.tokenId\n            ? {\n                tokenId: reward.tokenId,\n                amount: BNFixed(BNify(r.amount).plus(BNify(reward.amount))),\n                amountUSD: BNFixed(\n                  BNify(r.amountUSD).plus(BNify(reward.amountUSD))\n                ),\n                APR: BNify(r.APR).plus(reward.APR).div(2).toNumber(),\n                percentage: BNify(r.percentage)\n                  .plus(reward.percentage)\n                  .toNumber(),\n              }\n            : r\n        )\n      : [\n          ...acc,\n          {\n            tokenId: reward.tokenId,\n            amount: reward.amount,\n            amountUSD: reward.amountUSD,\n            APR: reward.APR,\n            percentage: reward.percentage,\n          },\n        ]\n  }, [])\n}\n\n/**\n * Calculate performance aggregation\n * @param currentPerformance - the performance of the current block\n * @param lastPerformance - the performance of the latest block\n * @returns the aggregation of the performances\n */\nexport function getWalletAggregatedPerformance(\n  currentPerformance: WalletPerformance,\n  lastPerformance?: WalletBlockPerformance\n): WalletBlockPerformance {\n  if (\n    !lastPerformance ||\n    BNlte(currentPerformance.age) ||\n    BNlte(currentPerformance.poolSharePercentage)\n  ) {\n    return initWalletPerformance(currentPerformance)\n  }\n\n  // Current age of the wallet\n  const age = lastPerformance.age + currentPerformance.age\n\n  // Calculated earnings\n  const earningsToken = BNify(lastPerformance.earnings.token).plus(\n    currentPerformance.earnings.token || 0\n  )\n\n  const earningsUSD = BNify(lastPerformance.earnings.USD).plus(\n    currentPerformance.earnings.USD\n  )\n\n  const earningsPercentage = BNify(lastPerformance.earnings.percentage)\n    .plus(currentPerformance.earnings.percentage)\n    .toNumber()\n\n  const earnings = {\n    token: BNFixed(earningsToken),\n    USD: BNFixed(earningsUSD),\n    percentage: earningsPercentage,\n  }\n\n  const realizedAPY = BNify(lastPerformance.realizedAPY)\n    .times(lastPerformance.age)\n    .plus(BNify(currentPerformance.realizedAPY).times(currentPerformance.age))\n    .div(age)\n    .toNumber()\n\n  const poolSharePercentage = lastPerformance?.poolSharePercentage\n    ? BNify(lastPerformance.poolSharePercentage)\n        .times(lastPerformance.age)\n        .plus(\n          BNify(currentPerformance.poolSharePercentage).times(\n            currentPerformance.age\n          )\n        )\n        .div(age)\n    : BNify(currentPerformance.poolSharePercentage)\n\n  return initWalletPerformance({\n    age,\n    earnings,\n    realizedAPY,\n    poolSharePercentage: poolSharePercentage\n      ? poolSharePercentage.toNumber()\n      : 0,\n  })\n}\n\n/**\n * Get vault tokens staked in pools\n * @param vault vault entity\n * @param walletBlock wallet block entity\n * @param options mongodb options\n * @returns wallet pools tokens balances\n */\nexport function getWalletPoolsTokens(\n  vault: Vault,\n  token: Token,\n  walletBlock: WalletBlock,\n  vaultBlock: VaultBlock\n): WalletPositionToken[] {\n  const positionTokens = (walletBlock.pools || []).reduce(\n    (acc: WalletPositionToken[], walletPool: VaultWalletPoolData) => {\n      const vaultPool = vault.pools?.find((p) =>\n        compLower(p.address, walletPool.address)\n      )\n      const vaultBlockPool = vaultBlock.pools?.find((p) =>\n        compLower(p.address, walletPool.address)\n      )\n\n      if (!vaultPool || !vaultBlockPool) {\n        return acc\n      }\n      const tokenAddress = walletPool.tokens?.[0].tokenAddress || token.address\n      const tokenId = walletPool.tokens?.[0].tokenId || token._id\n\n      const tokens = makeWalletPoolTokensData(\n        vaultPool,\n        vaultBlockPool,\n        walletPool,\n        vaultBlock.pools || [],\n        walletBlock.pools || []\n      )\n\n      const amount = BNFixed(\n        tokens\n          .filter((t) => t.tokenId === tokenId)\n          .reduce((sum, t) => sum.plus(t.balance), BNify(0))\n      )\n\n      if (BNlte(amount)) {\n        return acc\n      }\n\n      const USD = getWalletBlockPoolTokenBalanceUSD(\n        vault,\n        token,\n        vaultBlock,\n        tokenId,\n        amount\n      )\n      return [\n        ...acc,\n        {\n          pool: vaultPool.ref,\n          protocol: walletPool.protocol,\n          endDate: vaultPool.endDate,\n          walletId: walletBlock.walletId,\n          operatorId: walletPool.operatorId,\n          tokenId,\n          tokenAddress,\n          amount,\n          USD,\n          percentage: 0,\n        },\n      ]\n    },\n    []\n  )\n\n  if (vault.contractType === 'PARETO_DOLLAR') {\n    const amount = BNFixed(walletBlock.paretoDollar?.uspBalance)\n    const USD = BNFixed(fixAmount(amount, 18).times(1e6))\n    positionTokens.push({\n      walletId: walletBlock.walletId,\n      tokenId: vault.tokenId,\n      tokenAddress: token.address,\n      amount,\n      USD,\n      percentage: 0,\n    })\n  }\n\n  return positionTokens.filter((t) => BNgt(t.amount))\n}\n\n/**\n * Get Pendle wallet position tokens grouped by ref\n * This function properly handles Pendle pools avoiding double-counting\n * and excluding YT tokens in LP performance context\n *\n * @param vault vault entity\n * @param token vault token\n * @param walletBlock wallet block entity\n * @param timestamp current timestamp for maturity filtering\n * @returns wallet position tokens for Pendle pools\n */\nexport function getPendleWalletPositionTokens(\n  vault: Vault,\n  token: Token,\n  walletBlock: WalletBlock,\n  timestamp?: number\n): WalletPositionToken[] {\n  const { byRef } = getPendleWalletBalanceByRef(\n    vault.pools || [],\n    walletBlock.pools || [],\n    token._id,\n    timestamp || walletBlock.block.timestamp,\n    {\n      includeYT: false, // Don't include YT in LP performance context\n      activeOnly: false, // Include all pools with balance\n    }\n  )\n\n  const positionTokens: WalletPositionToken[] = []\n\n  byRef.forEach((balance, ref) => {\n    if (BNlte(balance)) {\n      return\n    }\n\n    // Find the pool group for this ref\n    const refPools = vault.pools?.filter((p) => p.ref === ref) || []\n    const lpPool = refPools.find((p) => p.protocol === 'PendleLP')\n\n    if (!lpPool) {\n      return\n    }\n\n    const amount = BNFixed(balance)\n    // Note: For USD calculation, we need vaultBlock but it's not available here\n    // This function should be called with vaultBlock available in the calling context\n    const USD = '0' // Will be calculated in the calling context\n\n    positionTokens.push({\n      pool: ref,\n      protocol: 'PendleLP',\n      endDate: lpPool.endDate,\n      walletId: walletBlock.walletId,\n      operatorId: lpPool.operatorId,\n      tokenId: token._id,\n      tokenAddress: token.address,\n      amount,\n      USD,\n      percentage: 0,\n    })\n  })\n\n  return positionTokens\n}\n"],"names":["calculateWalletPerformanceAge","getPendleWalletPositionTokens","getWalletAccruedRewards","getWalletAggregatedPerformance","getWalletEarnings","getWalletPerformance","getWalletPoolsTokens","getWalletRewardsEarnings","initWalletBlockAmounts","initWalletEarnings","initWalletPerformance","initWalletPortfolio","initWalletPosition","performance","defaultsDeep","cloneDeep","WALLET_PERFORMANCE","position","WALLET_PORTFOLIO","WALLET_POSITION","earnings","WALLET_BLOCK_AMOUNTS","USD","amounts","token","tokenBalance","earningsPercentage","price","earningsToken","BNify","times","div","earningsUSD","getTokenAmount","percentage","BNFixed","distributedRewards","reduce","acc","r","plus","amountUSD","toNumber","block","lastWalletBlock","lastWalletPerformance","timestamp","latestTimestamp","BNgt","age","BigNumber","maximum","vault","current","currentVault","last","lastVault","vaultPerformance","tokenPrice","feePercentage","pools","balance","getWalletBlockBalance","vaultPools","startBalance","BNlte","fees","fixAmount","rewards","length","realizedAPY","poolSharePercentage","totalSupply","startBlock","endBlock","reward","foundReward","find","tokenId","map","amount","APR","currentPerformance","lastPerformance","walletBlock","vaultBlock","positionTokens","walletPool","vaultPool","p","compLower","address","vaultBlockPool","tokenAddress","tokens","_id","makeWalletPoolTokensData","filter","t","sum","getWalletBlockPoolTokenBalanceUSD","pool","ref","protocol","endDate","walletId","operatorId","contractType","paretoDollar","uspBalance","push","byRef","getPendleWalletBalanceByRef","includeYT","activeOnly","forEach","refPools","lpPool"],"mappings":"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"}