{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/wallet-performances/libs/wallet-performances.lib.ts"],"sourcesContent":["import BigNumber from 'bignumber.js'\nimport {\n  BNeq,\n  BNFixed,\n  BNgt,\n  BNify,\n  BNlte,\n  BNSafeDiv,\n  compLower,\n  iBigInt,\n  ServerError,\n} from '../../core'\nimport {\n  WalletBlockAmounts,\n  WalletBlockEarnings,\n  WalletBlockPerformance,\n  WalletDeposits,\n  WalletDistributedRewards,\n  WalletPerformanceErrorCodes,\n  WalletPortfolio,\n  WalletPosition,\n  WalletPositionChain,\n  WalletPositionOperator,\n  WalletPositionToken,\n  WalletVaultHistory,\n} from '../wallet-performance.model'\nimport { compoundVaultApr, VaultBlock, VaultBlocks } from '../../vault-blocks'\nimport {\n  getWalletBalanceWithRequests,\n  getWalletPoolsTokenBalances,\n  WalletBlock,\n  WalletBlockDistributedRewards,\n} from '../../wallet-blocks'\nimport { TokenBlock } from '../../token-blocks'\nimport {\n  fixAmount,\n  fixTokenAmount,\n  getTokenAmount,\n  normalizeTokenAmount,\n  Token,\n  TokenPriceData,\n} from '../../tokens'\nimport {\n  getWalletAccruedRewards,\n  getWalletPerformance,\n  initWalletBlockAmounts,\n  initWalletPerformance,\n} from './wallet-performances-block.lib'\nimport { VaultEpoch } from '../../vault-epochs'\nimport {\n  getVaultPerformance,\n  getVaultPerformanceOptions,\n  getVaultRealizedAPR,\n} from '../../vault-performances'\nimport {\n  Vault,\n  WalletEpochStats,\n  VaultRewardProgramFrequency,\n} from '../../vaults'\nimport { Transaction } from '../../transactions'\nimport moment from 'moment'\n\n/**\n * Get wallet position total USD\n * @param walletPosition wallet position object\n * @returns wallet position total USD\n */\nexport function getPositionTotalUSD(walletPosition: WalletPosition) {\n  return (walletPosition.tokens || []).reduce(\n    (acc, t) => acc.plus(t.USD),\n    BNify(walletPosition.redeemable.USD)\n  )\n}\n\n/**\n * Aggregate tokens data for aggregated wallet performance\n * @param tokens current tokens data\n * @param walletPosition wallet vault position\n * @returns tokens aggregated data\n */\nexport function aggregateTokens(\n  tokens: WalletPositionToken[],\n  walletPosition: WalletPosition\n): WalletPositionToken[] {\n  const redeemableUSD = BNify(walletPosition.redeemable.USD)\n  const updatedTokens = tokens.map((token) =>\n    token.tokenId === walletPosition.tokenId\n      ? {\n          ...token,\n          amount: BNify(token.amount)\n            .plus(BNify(walletPosition.redeemable.token))\n            .toFixed(0),\n          USD: BNify(token.USD).plus(redeemableUSD).toFixed(0),\n          percentage: 0,\n        }\n      : token\n  )\n\n  const tokenExists = tokens.some(\n    (token) => token.tokenId === walletPosition.tokenId\n  )\n\n  const newTokens: WalletPositionToken[] = tokenExists\n    ? updatedTokens\n    : [\n        ...updatedTokens,\n        {\n          walletId: walletPosition.walletId,\n          tokenId: walletPosition.tokenId,\n          tokenAddress: walletPosition.tokenAddress,\n          amount: BNify(walletPosition.redeemable.token).toFixed(0),\n          USD: redeemableUSD.toFixed(0),\n          percentage: 0,\n        },\n      ]\n\n  // Insert pools tokens\n  walletPosition.tokens?.forEach((positionToken) => {\n    const matchingTokenIndex = newTokens.findIndex(\n      (token) =>\n        token.tokenId === positionToken.tokenId &&\n        token.operatorId === positionToken.operatorId &&\n        token.pool === positionToken.pool\n    )\n\n    if (matchingTokenIndex !== -1) {\n      const matchingToken = newTokens[matchingTokenIndex]\n      newTokens[matchingTokenIndex] = {\n        ...matchingToken,\n        amount: BNFixed(BNify(matchingToken.amount).plus(positionToken.amount)),\n        USD: BNFixed(BNify(matchingToken.USD).plus(positionToken.USD)),\n      }\n    } else {\n      newTokens.push(positionToken)\n    }\n  })\n\n  // Calculate percentage\n  const totalUSD = newTokens.reduce((acc: BigNumber, token) => {\n    return acc.plus(token.USD)\n  }, BNify(0))\n\n  return newTokens.reduce((acc: WalletPositionToken[], token) => {\n    return [\n      ...acc,\n      {\n        ...token,\n        percentage: BNSafeDiv(token.USD, totalUSD).times(100).toNumber(),\n      },\n    ]\n  }, [])\n}\n\ninterface WalletVaultPerformanceState {\n  lastVaultBlock?: VaultBlock\n  lastWalletBlock?: WalletBlock\n  latestWalletBlockWithBalance?: WalletBlock\n  lastWalletPerformance: WalletBlockPerformance\n  points: WalletBlockPerformance[]\n}\n\nfunction collectWalletVaultPerformance(\n  vault: Vault,\n  token: Token,\n  vaultBlocks: VaultBlock[],\n  walletBlocks: WalletBlock[],\n  walletVaultRewards: WalletDistributedRewards[],\n  tokenBlocks: TokenBlock[],\n  vaultEpochs: VaultEpoch[]\n): WalletVaultPerformanceState {\n  return vaultBlocks.reduce<WalletVaultPerformanceState>(\n    (acc, vaultBlock: VaultBlock) => {\n      const {\n        lastVaultBlock,\n        lastWalletBlock,\n        latestWalletBlockWithBalance,\n        lastWalletPerformance,\n        points,\n      } = acc\n\n      const walletBlock = walletBlocks.find((block) =>\n        BNeq(vaultBlock.block.number, block.block.number)\n      )\n\n      const distributedRewards = walletVaultRewards.filter((reward) =>\n        BNeq(reward.block.number, walletBlock?.block.number)\n      )\n\n      const tokenBlock = tokenBlocks.find((block) =>\n        BNeq(block.block.number, vaultBlock.block.number)\n      )\n\n      const tokenData = {\n        price: tokenBlock?.price || getTokenAmount(token, 1, 6),\n        decimals: 6,\n      }\n\n      if (!vaultBlock) {\n        return acc\n      }\n\n      if (\n        !lastWalletBlock ||\n        BNlte(getWalletBalanceWithRequests(lastWalletBlock, vaultBlock))\n      ) {\n        return {\n          lastVaultBlock: vaultBlock,\n          lastWalletBlock: walletBlock,\n          latestWalletBlockWithBalance:\n            walletBlock || latestWalletBlockWithBalance,\n          lastWalletPerformance: initWalletPerformance(),\n          points,\n        }\n      }\n\n      const currLastBlocks: VaultBlocks = {\n        current: vaultBlock,\n        last: lastVaultBlock,\n      }\n\n      // Get vault performance options\n      const vaultPerformanceOptions = getVaultPerformanceOptions(\n        vault,\n        vaultEpochs,\n        currLastBlocks,\n        latestWalletBlockWithBalance\n      )\n\n      // Calculate vault performance with additional options\n      const vaultPerformance = getVaultPerformance(\n        currLastBlocks,\n        token,\n        tokenData,\n        vaultPerformanceOptions\n      )\n\n      const walletPerformance = getWalletPerformance(\n        vault,\n        token,\n        lastWalletBlock,\n        undefined,\n        currLastBlocks,\n        vaultPerformance,\n        tokenData,\n        distributedRewards\n      )\n\n      const age = BNify(lastWalletPerformance.age)\n        .plus(walletPerformance.age)\n        .toNumber()\n\n      const rewards = {\n        ...lastWalletPerformance.earnings.rewards,\n        USD: BNify(lastWalletPerformance.earnings.rewards?.USD || 0)\n          .plus(walletPerformance.earnings.rewards?.USD || 0)\n          .toFixed(0),\n        percentage: BNify(\n          lastWalletPerformance.earnings.rewards?.percentage || 0\n        )\n          .plus(walletPerformance.earnings.rewards?.percentage || 0)\n          .toNumber(),\n      }\n\n      const earnings = {\n        ...lastWalletPerformance.earnings,\n        USD: BNify(lastWalletPerformance.earnings.USD)\n          .plus(walletPerformance.earnings.USD || 0)\n          .toFixed(0),\n        token: BNify(lastWalletPerformance.earnings.token)\n          .plus(walletPerformance.earnings.token || 0)\n          .toFixed(0),\n        percentage: BNify(lastWalletPerformance.earnings.percentage)\n          .plus(walletPerformance.earnings.percentage || 0)\n          .toNumber(),\n        rewards,\n      }\n\n      const fees = {\n        ...lastWalletPerformance.fees,\n        USD: BNify(lastWalletPerformance.fees.USD)\n          .plus(walletPerformance.fees.USD || 0)\n          .toFixed(0),\n        token: BNify(lastWalletPerformance.fees.token)\n          .plus(walletPerformance.fees.token || 0)\n          .toFixed(0),\n      }\n\n      const realizedAPY = BNgt(age)\n        ? BNify(lastWalletPerformance.realizedAPY)\n            .times(lastWalletPerformance.age)\n            .plus(\n              BNify(walletPerformance.realizedAPY).times(walletPerformance.age)\n            )\n            .div(age)\n            .toNumber()\n        : 0\n\n      return {\n        lastWalletPerformance: {\n          ...lastWalletPerformance,\n          startBlock: vaultBlocks[0].block,\n          endBlock: walletPerformance.endBlock,\n          age,\n          earnings,\n          fees,\n          realizedAPY,\n        },\n        lastWalletBlock: walletBlock || lastWalletBlock,\n        lastVaultBlock: vaultBlock,\n        latestWalletBlockWithBalance,\n        points: [...points, walletPerformance],\n      }\n    },\n    {\n      lastVaultBlock: undefined,\n      lastWalletBlock: undefined,\n      latestWalletBlockWithBalance: undefined,\n      lastWalletPerformance: initWalletPerformance(),\n      points: [],\n    }\n  )\n}\n\nexport function makeWalletVaultPerformancePoints(\n  vault: Vault,\n  token: Token,\n  vaultBlocks: VaultBlock[],\n  walletBlocks: WalletBlock[],\n  walletVaultRewards: WalletDistributedRewards[],\n  tokenBlocks: TokenBlock[],\n  vaultEpochs: VaultEpoch[]\n): WalletBlockPerformance[] {\n  return collectWalletVaultPerformance(\n    vault,\n    token,\n    vaultBlocks,\n    walletBlocks,\n    walletVaultRewards,\n    tokenBlocks,\n    vaultEpochs\n  ).points\n}\n\n/**\n * Get vault epoch holders journeys paginated\n * @param vaultEpochId vault epoch\n * @param options system options\n * @returns holders journeys page\n */\nexport function getWalletVaultHistory(\n  vault: Vault,\n  vaultEpochs: VaultEpoch[],\n  vaultBlocks: VaultBlock[],\n  walletBlocks: WalletBlock[],\n  transactions: Transaction[],\n  feePercentage?: number\n): WalletVaultHistory[] {\n  let lastVaultBlock: VaultBlock | undefined = undefined\n  let latestWalletBlock: WalletBlock | undefined = undefined\n\n  return vaultBlocks.reduce((acc: WalletVaultHistory[], vaultBlock) => {\n    // Find latest wallet block before or at vault block\n    const walletBlock = walletBlocks.find(\n      (wb) => wb.block.number === vaultBlock.block.number\n    )\n\n    const transaction = transactions.find((tx) =>\n      BNeq(tx.block.number, vaultBlock.block.number)\n    )\n\n    if (!transaction) {\n      return acc\n    }\n\n    const walletHistory = makeWalletVaultHistory(\n      vault,\n      vaultEpochs,\n      {\n        current: vaultBlock,\n        last: lastVaultBlock,\n      },\n      {\n        current: walletBlock,\n        last: latestWalletBlock,\n      },\n      transaction,\n      feePercentage\n    )\n\n    // Update latest wallet block\n    latestWalletBlock = walletBlock || latestWalletBlock\n    lastVaultBlock = vaultBlock\n\n    return [...acc, walletHistory]\n  }, [])\n}\n\nexport function getWalletBalances(\n  vault: Vault,\n  vaultBlocks: VaultBlocks,\n  walletBlocks: {\n    current: WalletBlock | undefined\n    last: WalletBlock | undefined\n  }\n): {\n  lpBalance: iBigInt\n  tokenBalance: iBigInt\n  stakedBalance?: iBigInt\n  poolsBalance?: iBigInt\n} {\n  const { current: vaultBlock } = vaultBlocks\n  const { current: walletBlock, last: latestWalletBlock } = walletBlocks\n\n  if (vault.contractType === 'PARETO_DOLLAR' && vault.paretoDollar) {\n    const uspBalance = walletBlock?.paretoDollar?.uspBalance || '0'\n    const stakedBalance = walletBlock?.tokenBalance || '0'\n\n    const sUSPTokenId = vault.paretoDollar.staking.tokenId\n\n    const uspPoolsBalance = walletBlock\n      ? getWalletPoolsTokenBalances(vault.tokenId, walletBlock.pools || [])\n      : '0'\n    const suspPoolsBalance =\n      walletBlock && sUSPTokenId\n        ? getWalletPoolsTokenBalances(sUSPTokenId, walletBlock.pools || [])\n        : '0'\n    const suspPoolsBalanceConverted = BNify(suspPoolsBalance)\n      .times(vaultBlock.price)\n      .div(1e18)\n      .toFixed(0)\n    const poolsBalance = BNFixed(\n      BNify(uspPoolsBalance).plus(suspPoolsBalanceConverted)\n    )\n\n    return {\n      lpBalance: uspBalance,\n      tokenBalance: uspBalance,\n      stakedBalance,\n      poolsBalance,\n    }\n  }\n\n  const lpBalance = walletBlock?.balance || latestWalletBlock?.balance || '0'\n  const tokenBalance =\n    walletBlock?.tokenBalance ||\n    BNFixed(\n      fixAmount(\n        BNify(latestWalletBlock?.balance || '0').times(vaultBlock.price),\n        18\n      )\n    )\n\n  return {\n    lpBalance,\n    tokenBalance,\n  }\n}\n\nexport function makeWalletVaultHistory(\n  vault: Vault,\n  vaultEpochs: VaultEpoch[],\n  vaultBlocks: VaultBlocks,\n  walletBlocks: {\n    current: WalletBlock | undefined\n    last: WalletBlock | undefined\n  },\n  transaction: Transaction,\n  feePercentage?: number\n): WalletVaultHistory {\n  const { current: vaultBlock, last: lastVaultBlock } = vaultBlocks\n  const { last: latestWalletBlock } = walletBlocks\n\n  const { lpBalance, tokenBalance, stakedBalance, poolsBalance } =\n    getWalletBalances(vault, vaultBlocks, walletBlocks)\n\n  const earnings = makeWalletVaultEarnings(\n    latestWalletBlock?.balance || '0',\n    lastVaultBlock?.price || '0',\n    vaultBlock.price,\n    feePercentage\n  )\n\n  const startBalance = BNFixed(\n    fixAmount(\n      BNify(latestWalletBlock?.balance || '0').times(\n        lastVaultBlock?.price || '0'\n      ),\n      18\n    )\n  )\n\n  const earningsPercentage = makeWalletVaultEarningsPercentage(\n    startBalance,\n    earnings\n  )\n\n  // Get vault performance options\n  const { age, compoundingPeriod, avgAPY, avgAPR } = getVaultPerformanceOptions(\n    vault,\n    vaultEpochs,\n    vaultBlocks,\n    latestWalletBlock\n  )\n\n  // Realized APY\n  const realizedAPR = avgAPR || getVaultRealizedAPR(age, earningsPercentage.NET)\n\n  const realizedAPY =\n    avgAPY ||\n    compoundVaultApr(\n      vault.contractType,\n      'BASE',\n      realizedAPR,\n      age,\n      compoundingPeriod\n    )\n\n  return {\n    hash: transaction.hash,\n    vaultId: vaultBlock.vaultId,\n    tokenId: transaction.tokenId,\n    action: transaction.type,\n    operatorId: transaction.operatorId,\n    block: vaultBlock.block,\n    amount: transaction.amount,\n    tokenAmount: transaction.tokenAmount,\n    lpBalance,\n    tokenBalance,\n    stakedBalance,\n    poolsBalance,\n    earnings,\n    earningsPercentage,\n    realizedAPY,\n    price: vaultBlock.price,\n    epochNumber: vaultBlock.cdoEpoch?.epochNumber,\n  }\n}\n\nexport function makeWalletVaultEarningsPercentage(\n  balance: iBigInt,\n  earnings: WalletEpochStats['earnings']\n): WalletEpochStats['earningsPercentage'] {\n  if (BNlte(balance)) {\n    return {\n      GROSS: 0,\n      NET: 0,\n      FEE: 0,\n    }\n  }\n  const GROSS = BNify(earnings.GROSS).div(balance)\n  const NET = BNify(earnings.NET).div(balance)\n  const FEE = BNify(earnings.FEE).div(balance)\n  return {\n    GROSS: GROSS.times(100).toNumber(),\n    NET: NET.times(100).toNumber(),\n    FEE: FEE.times(100).toNumber(),\n  }\n}\n\nexport function makeWalletVaultEarnings(\n  balance: iBigInt,\n  currentPrice: iBigInt,\n  nextPrice: iBigInt,\n  feePercentage?: number\n): WalletEpochStats['earnings'] {\n  const startBalance = BNFixed(\n    fixAmount(BNify(balance).times(currentPrice), 18)\n  )\n  const endBalance = BNFixed(fixAmount(BNify(balance).times(nextPrice), 18))\n\n  const netEarningsBN = BNify(endBalance).minus(startBalance)\n  const grossEarningsBN = netEarningsBN.div(\n    BNify(1).minus(BNify(feePercentage || 0).div(1e5))\n  )\n  const feesBN = grossEarningsBN.minus(netEarningsBN)\n\n  return {\n    FEE: BNFixed(feesBN),\n    NET: BNFixed(netEarningsBN),\n    GROSS: BNFixed(grossEarningsBN),\n  }\n}\n\n/**\n * Aggregate chains data for aggregated wallet performance\n * @param chains current chains data\n * @param walletPosition wallet vault position\n * @returns chains aggregated data\n */\nexport function aggregateChains(\n  chains: WalletPositionChain[],\n  walletPosition: WalletPosition\n): WalletPositionChain[] {\n  const redeemableUSD = getPositionTotalUSD(walletPosition)\n\n  const updatedChains = chains.map((chain) =>\n    chain.chainId === walletPosition.chainId\n      ? {\n          ...chain,\n          USD: BNify(chain.USD).plus(redeemableUSD).toFixed(0),\n          percentage: 0,\n        }\n      : chain\n  )\n\n  const chainExists = chains.some(\n    (chain) => chain.chainId === walletPosition.chainId\n  )\n\n  const newChains = chainExists\n    ? updatedChains\n    : [\n        ...updatedChains,\n        {\n          chainId: walletPosition.chainId,\n          USD: redeemableUSD.toFixed(0),\n        },\n      ]\n\n  // Calculate percentage\n  const totalUSD = newChains.reduce((acc: BigNumber, chain) => {\n    return acc.plus(chain.USD)\n  }, BNify(0))\n\n  return newChains.reduce((acc: WalletPositionChain[], chain) => {\n    return [\n      ...acc,\n      {\n        ...chain,\n        percentage: BNSafeDiv(chain.USD, totalUSD).times(100).toNumber(),\n      },\n    ]\n  }, [])\n}\n\n/**\n * Aggregate tokens data for aggregated wallet performance\n * @param tokens current tokens data\n * @param walletPosition wallet vault position\n * @returns tokens aggregated data\n */\nexport function aggregateOperators(\n  operatorIds: string[],\n  operators: WalletPositionOperator[],\n  walletPosition: WalletPosition\n): WalletPositionOperator[] {\n  const updatedOperators = operators.map((operator) =>\n    operatorIds.includes(operator.operatorId)\n      ? {\n          ...operator,\n          USD: BNify(operator.USD)\n            .plus(BNify(walletPosition.redeemable.USD))\n            .toFixed(0),\n        }\n      : operator\n  )\n\n  const operatorExists = operators.some((operator) =>\n    operatorIds.includes(operator.operatorId)\n  )\n\n  const newOperators = operatorExists\n    ? updatedOperators\n    : [\n        ...updatedOperators,\n        ...operatorIds.map((operatorId) => ({\n          operatorId,\n          USD: BNify(walletPosition.redeemable.USD).toFixed(0),\n        })),\n      ]\n\n  // Calculate percentage\n  const totalUSD = newOperators.reduce((acc: BigNumber, operator) => {\n    return acc.plus(operator.USD)\n  }, BNify(0))\n\n  return newOperators.reduce((acc: WalletPositionOperator[], operator) => {\n    return [\n      ...acc,\n      {\n        ...operator,\n        percentage: BNSafeDiv(operator.USD, totalUSD).times(100).toNumber(),\n      },\n    ]\n  }, [])\n}\n\n/**\n * Aggregate vaults data\n * @param portfolio the wallet portfolio data\n * @param position - the wallet position\n * @param vault - the vault\n * @returns the vaults data\n */\nexport function aggregateVaults(\n  portfolio: WalletPortfolio,\n  position: WalletPosition\n) {\n  const redeemableUSD = getPositionTotalUSD(position)\n\n  // Redeemable\n  const redeemable = {\n    ...portfolio.redeemable,\n    USD: BNFixed(BNify(portfolio.redeemable.USD).plus(redeemableUSD)),\n  }\n\n  const percentageRewards = BNgt(redeemable.USD)\n    ? BNify(portfolio.earnings.rewards?.percentage)\n        .times(portfolio.redeemable.USD)\n        .plus(\n          BNify(position.earnings.rewards?.percentage).times(\n            position.redeemable.USD\n          )\n        )\n        .div(redeemable.USD)\n        .toNumber()\n    : 0\n\n  const rewards = {\n    ...position.earnings.rewards,\n    USD: BNFixed(\n      BNify(position.earnings.rewards?.USD).plus(\n        position.earnings.rewards?.USD || 0\n      )\n    ),\n    percentage: percentageRewards,\n  }\n\n  const percentageEarnings = BNgt(redeemable.USD)\n    ? BNify(position.earnings.percentage)\n        .times(position.redeemable.USD)\n        .plus(\n          BNify(position.earnings.percentage).times(position.redeemable.USD)\n        )\n        .div(redeemable.USD)\n        .toNumber()\n    : 0\n\n  // Earnings\n  const earnings: WalletBlockEarnings = {\n    ...portfolio.earnings,\n    USD: BNify(portfolio.earnings.USD)\n      .plus(position.earnings.USD || 0)\n      .toFixed(0),\n    percentage: percentageEarnings,\n    rewards,\n  }\n\n  // Deposits\n  const deposits = {\n    ...portfolio.deposits,\n    USD: BNify(portfolio.deposits.USD)\n      .plus(position.deposits.USD || 0)\n      .toFixed(0),\n  }\n\n  // Pending Deposits\n  const pendingDeposits = {\n    USD: BNify(portfolio.pendingDeposits.USD)\n      .plus(position.pendingDeposits.USD)\n      .toFixed(0),\n  }\n\n  // Pending Withdraws\n  const pendingWithdraws = {\n    USD: BNify(portfolio.pendingWithdraws.USD)\n      .plus(position.pendingWithdraws.USD)\n      .toFixed(0),\n  }\n\n  // APY realized\n  const realizedAPY = BNgt(redeemable.USD)\n    ? BNify(portfolio.realizedAPY)\n        .times(portfolio.redeemable.USD)\n        .plus(BNify(position.realizedAPY).times(position.redeemable.USD))\n        .div(redeemable.USD)\n        .toNumber()\n    : 0\n\n  // APY realized with rewards\n  const rewardsRealizedAPY = BNgt(redeemable.USD)\n    ? BNify(portfolio.rewardsRealizedAPY)\n        .times(portfolio.redeemable.USD)\n        .plus(BNify(position.rewardsRealizedAPY).times(position.redeemable.USD))\n        .div(redeemable.USD)\n        .toNumber()\n    : 0\n\n  const vaultIds = [...portfolio.vaultIds, position.vaultId]\n\n  const accruedRewards = [\n    ...(portfolio.accruedRewards || []),\n    ...(position.accruedRewards || []),\n  ]\n\n  return {\n    vaultIds,\n    earnings,\n    deposits,\n    redeemable,\n    pendingDeposits,\n    pendingWithdraws,\n    realizedAPY,\n    accruedRewards,\n    rewardsRealizedAPY,\n  }\n}\n\n/**\n * Get wallet performances for a specific vault\n * @param vault vault\n * @param token token\n * @param vaultBlocks vault blocks\n * @param walletBlocks wallet blocks\n * @param walletVaultRewards wallet vault rewards\n * @param tokenBlocks token blocks\n * @param vaultEpochs vault epochs\n * @param latestVaultBlock latest vault block\n * @param walletVaultDeposits wallet vault deposited\n * @param tokens wallet position tokens\n * @returns wallet vault performances\n */\nexport function makeWalletVaultPerformance(\n  vault: Vault,\n  token: Token,\n  vaultBlocks: VaultBlock[],\n  walletBlocks: WalletBlock[],\n  walletVaultRewards: WalletDistributedRewards[],\n  tokenBlocks: TokenBlock[],\n  vaultEpochs: VaultEpoch[],\n  latestVaultBlock: VaultBlock,\n  walletVaultDeposits: WalletDeposits,\n  tokens: WalletPositionToken[]\n): WalletPosition {\n  const performance = collectWalletVaultPerformance(\n    vault,\n    token,\n    vaultBlocks,\n    walletBlocks,\n    walletVaultRewards,\n    tokenBlocks,\n    vaultEpochs\n  )\n\n  const walletPerformance = performance.lastWalletPerformance\n\n  const accruedRewards = getWalletAccruedRewards(walletVaultRewards)\n\n  const rewardsRealizedAPY = accruedRewards\n    .reduce((acc, r) => acc.plus(r.APR), BNify(0))\n    .toNumber()\n\n  const walletAddress = walletBlocks[walletBlocks.length - 1].walletAddress\n\n  const walletPosition: WalletPosition = {\n    walletAddress,\n    block: latestVaultBlock.block,\n    vaultId: vault._id,\n    vaultAddress: vault.address,\n    chainId: vault.chainId,\n    tokenId: token._id,\n    tokenAddress: token.address,\n    vaultPrice: latestVaultBlock.price,\n    ...walletPerformance,\n    ...walletVaultDeposits,\n    accruedRewards,\n    rewardsRealizedAPY,\n    tokens,\n  }\n\n  return walletPosition\n}\n\n/**\n * Make distributed reward performance for wallet portfolio\n * @param vault vault entity\n * @param token token entity\n * @param walletBlock wallet block entity\n * @param distributedReward distributed reward object\n * @param tokenPrice token price at specific block\n * @returns distributed rewards performance\n */\nexport function makeWalletDistributedReward(\n  vault: Vault,\n  token: Token,\n  walletBlock: WalletBlock,\n  distributedReward: WalletBlockDistributedRewards,\n  tokenPrice: string\n): WalletDistributedRewards {\n  const rewardProgram = vault.rewardPrograms?.find(\n    (r) => r.tokenId === distributedReward.tokenId\n  )\n  if (!rewardProgram) {\n    throw new ServerError({\n      code: WalletPerformanceErrorCodes.rewardProgramNotFound,\n      message: `Reward program not found (vaultId: ${vault._id}, tokenId: ${distributedReward.tokenId})`,\n      statusCode: 404,\n    })\n  }\n  const balanceUSD = BNFixed(\n    fixAmount(BNify(walletBlock.tokenBalance).times(tokenPrice), token.decimals)\n  )\n  const APR = calculateDistributedRewardAPR(\n    distributedReward.amountUSD,\n    balanceUSD,\n    rewardProgram.distributionFrequency\n  )\n  const percentage = BNSafeDiv(distributedReward.amountUSD, balanceUSD)\n    .times(100)\n    .toNumber()\n\n  return {\n    ...distributedReward,\n    walletId: walletBlock.walletId,\n    block: walletBlock.block,\n    APR,\n    percentage,\n  }\n}\n\n/**\n * Calculate APR from distributed rewards\n * @param distributedAmountUSD amount received in USD\n * @param balanceUSD wallet balance in USD\n * @param distributionFrequency reward program distribution frequency\n * @returns APR from distributed rewards\n */\nexport function calculateDistributedRewardAPR(\n  distributedAmountUSD: string,\n  balanceUSD: string,\n  distributionFrequency: VaultRewardProgramFrequency\n) {\n  const periodsPerYear: Record<string, number> = {\n    D: 365,\n    W: 52,\n    M: 12,\n    Y: 1,\n  }\n\n  const frequency = periodsPerYear[distributionFrequency.unit] || 1\n  const periods = frequency / distributionFrequency.value\n\n  return BNSafeDiv(distributedAmountUSD, balanceUSD)\n    .times(periods)\n    .times(100)\n    .toNumber()\n}\n\nexport function calculateWalletAvgPriceAccumulator(\n  num: BigNumber,\n  den: BigNumber,\n  transaction: Transaction\n) {\n  return {\n    num: BNify(num).plus(BNify(transaction.price).times(transaction.amount)),\n    den: BNify(den).plus(transaction.amount),\n  }\n}\n\nexport function calculateWalletDeposits(\n  deposits: WalletBlockAmounts,\n  transaction: Transaction\n) {\n  switch (transaction.type) {\n    case 'STAKE':\n    case 'DEPOSIT':\n    case 'REQUEST_DEPOSIT':\n    case 'DELETE_WITHDRAW_REQUEST':\n      return {\n        ...deposits,\n        token: BNFixed(BNify(deposits.token).plus(transaction.tokenAmount)),\n      }\n    case 'UNSTAKE':\n    case 'REDEEM':\n    case 'REQUEST_WITHDRAW':\n    case 'DELETE_DEPOSIT_REQUEST':\n      return {\n        ...deposits,\n        vault: BNFixed(\n          BigNumber.maximum(0, BNify(deposits.vault).minus(transaction.amount))\n        ),\n        token: BNFixed(\n          BigNumber.maximum(\n            0,\n            BNify(deposits.token).minus(transaction.tokenAmount)\n          )\n        ),\n      }\n  }\n  return deposits\n}\n\nexport function makeWalletVaultDeposits(\n  token: Token,\n  transactions: Transaction[],\n  tokenPriceData: TokenPriceData,\n  walletLatestBlock: WalletBlock,\n  vaultLatestBlock: VaultBlock\n): WalletDeposits {\n  const info = transactions.reduce(\n    (\n      acc: {\n        num: BigNumber\n        den: BigNumber\n        deposits: WalletBlockAmounts\n      },\n      transaction: Transaction\n    ) => {\n      const deposits = calculateWalletDeposits(acc.deposits, transaction)\n      const { num, den } = calculateWalletAvgPriceAccumulator(\n        acc.num,\n        acc.den,\n        transaction\n      )\n\n      return {\n        num,\n        den,\n        deposits,\n      }\n    },\n    {\n      num: BNify(0),\n      den: BNify(0),\n      deposits: initWalletBlockAmounts(),\n    }\n  )\n\n  // Calculate AVG deposit price\n  const { num, den, deposits } = info\n  const avgPrice = den.gt(0) ? BNFixed(num.div(den)) : BNFixed()\n\n  // Set USD amount\n  deposits.USD = BNFixed(\n    BNify(deposits.token).times(tokenPriceData.price).div(getTokenAmount(token))\n  )\n\n  const pendingDeposits = (vaultLatestBlock.requests || [])\n    .filter(\n      (r) =>\n        r.type === 'DEPOSIT' &&\n        compLower(r.walletAddress, walletLatestBlock.walletAddress)\n    )\n    .reduce(\n      (acc: WalletBlockAmounts, request) => {\n        const requestAmountUSD = fixTokenAmount(\n          token,\n          BNify(request.amount).times(tokenPriceData.price)\n        )\n        return {\n          token: BNFixed(BNify(acc.token).plus(request.amount)),\n          USD: BNFixed(BNify(acc.USD).plus(requestAmountUSD)),\n        }\n      },\n      initWalletBlockAmounts({\n        USD: '0',\n        token: '0',\n      })\n    )\n\n  const pendingWithdraws = (vaultLatestBlock.requests || [])\n    .filter(\n      (r) =>\n        ['WITHDRAW', 'REDEEM'].includes(r.type) &&\n        compLower(r.walletAddress, walletLatestBlock.walletAddress)\n    )\n    .reduce(\n      (acc: WalletBlockAmounts, request) => {\n        const requestAmountUSD = fixTokenAmount(\n          token,\n          BNify(request.amount).times(tokenPriceData.price)\n        )\n        return {\n          token: BNFixed(BNify(acc.token).plus(request.amount)),\n          USD: BNFixed(BNify(acc.USD).plus(requestAmountUSD)),\n        }\n      },\n      initWalletBlockAmounts({\n        USD: '0',\n        token: '0',\n      })\n    )\n\n  const tokenBalance = fixAmount(\n    BNify(walletLatestBlock.balance).times(vaultLatestBlock.price),\n    18\n  )\n\n  const redeemableToken = BNify(tokenBalance).plus(\n    pendingWithdraws.token || '0'\n  )\n\n  const redeemableVault = normalizeTokenAmount(\n    token,\n    BNSafeDiv(redeemableToken, vaultLatestBlock.price)\n  )\n\n  const redeemableUSD = fixAmount(\n    BNify(redeemableToken).times(tokenPriceData.price),\n    token.decimals\n  )\n\n  const redeemable: WalletBlockAmounts = initWalletBlockAmounts({\n    vault: BNFixed(redeemableVault),\n    token: BNFixed(redeemableToken),\n    USD: BNFixed(redeemableUSD),\n  })\n\n  return {\n    walletId: walletLatestBlock.walletId,\n    redeemable,\n    deposits,\n    avgPrice,\n    pendingDeposits,\n    pendingWithdraws,\n  }\n}\n"],"names":["aggregateChains","aggregateOperators","aggregateTokens","aggregateVaults","calculateDistributedRewardAPR","calculateWalletAvgPriceAccumulator","calculateWalletDeposits","getPositionTotalUSD","getWalletBalances","getWalletVaultHistory","makeWalletDistributedReward","makeWalletVaultDeposits","makeWalletVaultEarnings","makeWalletVaultEarningsPercentage","makeWalletVaultHistory","makeWalletVaultPerformance","makeWalletVaultPerformancePoints","walletPosition","tokens","reduce","acc","t","plus","USD","BNify","redeemable","redeemableUSD","updatedTokens","map","token","tokenId","amount","toFixed","percentage","tokenExists","some","newTokens","walletId","tokenAddress","forEach","positionToken","matchingTokenIndex","findIndex","operatorId","pool","matchingToken","BNFixed","push","totalUSD","BNSafeDiv","times","toNumber","collectWalletVaultPerformance","vault","vaultBlocks","walletBlocks","walletVaultRewards","tokenBlocks","vaultEpochs","vaultBlock","lastWalletPerformance","walletPerformance","lastVaultBlock","lastWalletBlock","latestWalletBlockWithBalance","points","walletBlock","find","block","BNeq","number","distributedRewards","filter","reward","tokenBlock","tokenData","price","getTokenAmount","decimals","BNlte","getWalletBalanceWithRequests","initWalletPerformance","currLastBlocks","current","last","vaultPerformanceOptions","getVaultPerformanceOptions","vaultPerformance","getVaultPerformance","getWalletPerformance","undefined","age","rewards","earnings","fees","realizedAPY","BNgt","div","startBlock","endBlock","transactions","feePercentage","latestWalletBlock","wb","transaction","tx","walletHistory","contractType","paretoDollar","uspBalance","stakedBalance","tokenBalance","sUSPTokenId","staking","uspPoolsBalance","getWalletPoolsTokenBalances","pools","suspPoolsBalance","suspPoolsBalanceConverted","poolsBalance","lpBalance","balance","fixAmount","startBalance","earningsPercentage","compoundingPeriod","avgAPY","avgAPR","realizedAPR","getVaultRealizedAPR","NET","compoundVaultApr","hash","vaultId","action","type","tokenAmount","epochNumber","cdoEpoch","GROSS","FEE","currentPrice","nextPrice","endBalance","netEarningsBN","minus","grossEarningsBN","feesBN","chains","updatedChains","chain","chainId","chainExists","newChains","operatorIds","operators","updatedOperators","operator","includes","operatorExists","newOperators","portfolio","position","percentageRewards","percentageEarnings","deposits","pendingDeposits","pendingWithdraws","rewardsRealizedAPY","vaultIds","accruedRewards","latestVaultBlock","walletVaultDeposits","performance","getWalletAccruedRewards","r","APR","walletAddress","length","_id","vaultAddress","address","vaultPrice","distributedReward","tokenPrice","rewardProgram","rewardPrograms","ServerError","code","WalletPerformanceErrorCodes","rewardProgramNotFound","message","statusCode","balanceUSD","amountUSD","distributionFrequency","distributedAmountUSD","periodsPerYear","D","W","M","Y","frequency","unit","periods","value","num","den","BigNumber","maximum","tokenPriceData","walletLatestBlock","vaultLatestBlock","info","initWalletBlockAmounts","avgPrice","gt","requests","compLower","request","requestAmountUSD","fixTokenAmount","redeemableToken","redeemableVault","normalizeTokenAmount"],"mappings":"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"}