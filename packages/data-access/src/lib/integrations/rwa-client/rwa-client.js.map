{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/integrations/rwa-client/rwa-client.ts"],"sourcesContent":["import axios, { Axios, CreateAxiosDefaults } from 'axios'\nimport { ApiClientModel } from '../../api-client'\nimport { BNgt, BNify, SharedLogger, stringify } from '../../core'\nimport { fixAmount, fixTokenAmount } from '../../tokens/libs/token.lib'\nimport { Token } from '../../tokens/token.model'\nimport { Vault, VaultCdoEpochMode, VaultFields, VaultRwa } from '../../vaults'\nimport { VaultBlock } from '../../vault-blocks'\nimport { VaultEpoch } from '../../vault-epochs/vault-epoch.model'\nimport moment from 'moment'\nimport {\n  RwaDailySnapshot,\n  RwaMetrics,\n  RwaMetricsEntry,\n} from './rwa-client.model'\n\nconst RWA_BASE_URL = 'https://ingestion-api.rwa.xyz/v1/assets/metrics'\n\nexport class RwaClient {\n  private axios: Axios\n  private apiKey: string\n  private api: ApiClientModel\n  private logger: SharedLogger\n  private dryRun: boolean\n\n  constructor(options: {\n    api: ApiClientModel\n    apiKey: string\n    logger?: SharedLogger\n    dryRun?: boolean\n  }) {\n    this.api = options.api\n    this.apiKey = options.apiKey\n    this.logger = options.logger || console\n    this.dryRun = Boolean(options.dryRun)\n    this.axios = this.initAxios()\n  }\n\n  public async pushLatest(): Promise<{\n    results: {\n      date: string\n      vaultId: string\n      rwaId: string\n      message?: string\n    }[]\n  }> {\n    const results: {\n      date: string\n      vaultId: string\n      rwaId: string\n      message?: string\n    }[] = []\n\n    const fields: VaultFields[] = [\n      '_id',\n      'tokenId',\n      'kyc',\n      'contractType',\n      'cdoEpoch',\n      'rwa',\n    ]\n    const vaults = await this.api.vaults.list({\n      status: 'READY',\n      limit: 200,\n      fields,\n    })\n\n    const byDate = new Map<\n      string,\n      {\n        payload: RwaMetricsEntry[]\n        items: Array<{ vaultId: string; rwaId: string }>\n      }\n    >()\n\n    for (const vault of vaults) {\n      const rwaTargets: VaultRwa[] | undefined = vault.rwa?.filter(\n        (t) => t.isActive\n      )\n      if (!rwaTargets?.length) continue\n\n      const token = await this.api.tokens.readOne({ _id: vault.tokenId })\n      const latestBlock = await this.api.vaultLatestBlocks.readOne({\n        vaultId: vault._id,\n      })\n\n      this.logger.debug?.(\n        `RWA: processing vault ${vault._id}, latest block: ${moment(\n          normalizeTimestamp(latestBlock.block.timestamp)\n        ).format('YYYY-MM-DD HH:mm:ss')}`\n      )\n\n      if (vault.contractType === 'PARETO_DOLLAR') {\n        this.addParetoDollarEntries(byDate, vault, token, latestBlock)\n      } else if (vault.contractType === 'CDO_EPOCH') {\n        if (!vault.cdoEpoch) {\n          this.logger.debug?.(\n            `RWA: skipping vault ${vault._id} (missing cdoEpoch info)`\n          )\n          continue\n        }\n\n        const epochs = await this.api.vaultEpochs.list({\n          vaultId: vault._id,\n          sort: 'count',\n          order: 'desc',\n          limit: 2,\n        })\n\n        const latest = epochs[0]\n        const prev = epochs[1]\n\n        if (!latest) continue\n\n        this.logger.debug?.(\n          `RWA: vault ${vault._id} latest epoch ${moment(\n            normalizeTimestamp(latest?.block.timestamp)\n          ).format('YYYY-MM-DD HH:mm:ss')}, prev epoch ${moment(\n            normalizeTimestamp(prev?.block.timestamp)\n          ).format('YYYY-MM-DD HH:mm:ss')})}`\n        )\n\n        const timestampMs = normalizeTimestamp(latestBlock.block.timestamp)\n        const date = toDateString(timestampMs)\n\n        if (!timestampMs || !date) continue\n\n        const snapshot = buildCdoEpochSnapshotForDate(\n          token,\n          latest,\n          prev,\n          vault.cdoEpoch?.mode,\n          date\n        )\n\n        if (!snapshot) continue\n\n        for (const t of rwaTargets) {\n          const entry = buildMetricsEntry(snapshot, token, t.rwaId, vault)\n          if (!entry) continue\n          const bucket = byDate.get(date) || { payload: [], items: [] }\n          bucket.payload.push(entry)\n          bucket.items.push({ vaultId: vault._id, rwaId: t.rwaId })\n          byDate.set(date, bucket)\n        }\n      } else {\n        this.logger.debug?.(\n          `RWA: skipping vault ${vault._id} (contractType=${vault.contractType})`\n        )\n      }\n    }\n\n    for (const [date, batch] of byDate) {\n      const url = `${RWA_BASE_URL}/${date}`\n      try {\n        if (this.dryRun) {\n          this.logger.info?.(\n            `RWA ${date} dry-run: skipping PUT (${batch.payload.length} entries)`\n          )\n          this.logger.info?.(\n            {\n              url,\n              payload: batch.payload,\n            },\n            'RWA dry-run payload:'\n          )\n\n          for (const item of batch.items) {\n            results.push({\n              date,\n              vaultId: item.vaultId,\n              rwaId: item.rwaId,\n              message: 'DRY_RUN',\n            })\n          }\n          continue\n        }\n\n        const res = await this.axios.put(url, batch.payload, {\n          headers: {\n            Authorization: `Bearer ${this.apiKey}`,\n            'Content-Type': 'application/json',\n          },\n        })\n\n        const message = getRwaResponseMessage(res.data) || String(res.status)\n        this.logger.info?.(`RWA ${date}: ${message}`)\n\n        for (const item of batch.items) {\n          results.push({\n            date,\n            vaultId: item.vaultId,\n            rwaId: item.rwaId,\n            message: String(message),\n          })\n        }\n      } catch (error: unknown) {\n        const message = getErrorMessage(error)\n        throw new Error(`RWA ${date} failed: ${message}`)\n      }\n    }\n\n    return { results }\n  }\n\n  private initAxios() {\n    const options: CreateAxiosDefaults = {\n      headers: {\n        'content-type': 'application/json',\n      },\n      timeout: 30_000,\n    }\n    return axios.create(options)\n  }\n\n  private addParetoDollarEntries(\n    byDate: Map<\n      string,\n      {\n        payload: RwaMetricsEntry[]\n        items: Array<{ vaultId: string; rwaId: string }>\n      }\n    >,\n    vault: Vault,\n    token: Token,\n    block: VaultBlock\n  ) {\n    const rwaTargets: VaultRwa[] | undefined = vault.rwa\n    if (!rwaTargets?.length) return\n\n    const timestampMs = normalizeTimestamp(block.block?.timestamp)\n    const date = toDateString(timestampMs)\n    if (!timestampMs || !date) return\n\n    const bucket = byDate.get(date) || { payload: [], items: [] }\n\n    for (const t of rwaTargets) {\n      const snapshot =\n        t.type === 'sUSP'\n          ? buildParetoDollarSnapshotSUSP(block, token, date)\n          : buildParetoDollarSnapshotUSP(block, date)\n      const entry = buildMetricsEntry(snapshot, token, t.rwaId, vault)\n      if (!entry) continue\n      bucket.payload.push(entry)\n      bucket.items.push({ vaultId: vault._id, rwaId: t.rwaId })\n    }\n\n    byDate.set(date, bucket)\n  }\n}\n\nfunction buildMetricsEntry(\n  snapshot: RwaDailySnapshot,\n  token: Token,\n  rwaId: string,\n  vault: Vault\n): RwaMetricsEntry | null {\n  if (!BNgt(snapshot?.supply)) return null\n  const metrics: RwaMetrics = {\n    net_asset_value: Number(snapshot.price.toFixed(token.decimals)),\n    net_asset_value_dollar: Number(snapshot.price.toFixed(6)),\n    token_supply_circulating: Number(snapshot.supply.toFixed(18)),\n    aum: Number(snapshot.tvlToken.toFixed(token.decimals)),\n    aum_dollar: Number(snapshot.tvlUSD.toFixed(6)),\n  }\n\n  if (vault.kyc?.hideSensitiveData !== true) {\n    const netYield1d = Number(snapshot.yieldToken.toFixed(token.decimals))\n    if (netYield1d !== 0) metrics.net_yield_1d = netYield1d\n\n    const netYield1dDollar = Number(snapshot.yieldUSD.toFixed(6))\n    if (netYield1dDollar !== 0) metrics.net_yield_1d_dollar = netYield1dDollar\n  }\n\n  return {\n    id: rwaId,\n    metrics,\n  }\n}\n\nfunction buildParetoDollarSnapshotUSP(\n  block: VaultBlock,\n  date: string\n): RwaDailySnapshot {\n  const supply = fixAmount(block.totalSupply, 18)\n  return {\n    date,\n    supply,\n    price: BNify(1),\n    tvlToken: supply,\n    tvlUSD: supply,\n    yieldToken: BNify(0),\n    yieldUSD: BNify(0),\n  }\n}\n\nfunction buildParetoDollarSnapshotSUSP(\n  block: VaultBlock,\n  token: Token,\n  date: string\n): RwaDailySnapshot {\n  const supply = fixTokenAmount(\n    token,\n    block.paretoDollar?.staking?.totalAssets || 0\n  )\n  const price = fixTokenAmount(token, block.price)\n  const tvlToken = fixTokenAmount(token, block.TVL?.token || 0)\n  const tvlUSD = fixAmount(block.TVL?.USD || 0, 6)\n  const yieldRate1d = BNify(block.APYs?.NET || 0).div(36500)\n  const yieldToken = tvlToken.times(yieldRate1d)\n  const yieldUSD = tvlUSD.times(yieldRate1d)\n\n  return {\n    date,\n    supply,\n    price,\n    tvlToken,\n    tvlUSD,\n    yieldToken,\n    yieldUSD,\n  }\n}\n\nfunction computeEpochData(epoch: VaultEpoch, token: Token) {\n  const tvl = epoch.TVL\n  const interest = epoch.interest\n  const supply = fixAmount(epoch.totalSupply || 0, 18)\n\n  const startTvlToken = fixTokenAmount(token, tvl.token)\n  const startTvlUSD = fixAmount(tvl.USD, 6)\n  const grossInterest = fixTokenAmount(token, interest?.GROSS || 0)\n\n  const tokenToUsdRatio =\n    startTvlToken.gt(0) && startTvlUSD.gt(0)\n      ? startTvlUSD.div(startTvlToken)\n      : BNify(1)\n\n  const grossInterestUSD = grossInterest.times(tokenToUsdRatio)\n  const startPrice = fixAmount(epoch.price, token.decimals)\n\n  const yieldRate1d = BNify(epoch.APYs?.NET || 0).div(36500)\n  const yieldToken = startTvlToken.times(yieldRate1d)\n  const yieldUSD = startTvlUSD.times(yieldRate1d)\n\n  return {\n    supply,\n    startTvlToken,\n    startTvlUSD,\n    grossInterest,\n    grossInterestUSD,\n    startPrice,\n    yieldRate1d,\n    yieldToken,\n    yieldUSD,\n  }\n}\n\nfunction buildCdoEpochSnapshotForDate(\n  token: Token,\n  epoch: VaultEpoch,\n  prevEpoch: VaultEpoch | undefined,\n  epochMode: VaultCdoEpochMode,\n  date: string\n): RwaDailySnapshot | null {\n  const data = computeEpochData(epoch, token)\n  const prevData = prevEpoch ? computeEpochData(prevEpoch, token) : undefined\n\n  const dailyYield = (() => {\n    if (epochMode === 'STRATEGY') {\n      if (!prevData) return { yieldToken: BNify(0), yieldUSD: BNify(0) }\n      return {\n        yieldToken: prevData.yieldToken,\n        yieldUSD: prevData.yieldUSD,\n      }\n    }\n    return {\n      yieldToken: data.yieldToken,\n      yieldUSD: data.yieldUSD,\n    }\n  })()\n\n  const tvlToken = data.startTvlToken\n  const tvlUSD = data.startTvlUSD\n  const price = data.startPrice\n  return {\n    date,\n    supply: data.supply,\n    price,\n    tvlToken,\n    tvlUSD,\n    yieldToken: dailyYield.yieldToken,\n    yieldUSD: dailyYield.yieldUSD,\n  }\n}\n\nfunction normalizeTimestamp(value?: string | number | Date): number {\n  if (!value) return 0\n\n  if (value instanceof Date) {\n    const t = value.getTime()\n    return Number.isFinite(t) ? t : 0\n  }\n\n  const num = Number(value)\n  if (Number.isFinite(num)) {\n    return num > 1e12 ? num : num * 1000\n  }\n\n  const parsed = Date.parse(String(value))\n  return Number.isFinite(parsed) ? parsed : 0\n}\n\n// Always send previous day date string\nfunction toDateString(timestamp: number): string {\n  const date = new Date(timestamp)\n  return moment(date).subtract(1, 'day').format('YYYY-MM-DD')\n}\n\nfunction getRwaResponseMessage(data: unknown): string | null {\n  if (!data || typeof data !== 'object') return null\n  const record = data as Record<string, unknown>\n  const message = record['message'] ?? record['status']\n  if (typeof message === 'string' || typeof message === 'number') {\n    return String(message)\n  }\n  return null\n}\n\nfunction getErrorMessage(error: unknown): string {\n  if (axios.isAxiosError(error)) {\n    const status = error.response?.status\n    const data = error.response?.data\n    const responsePart =\n      typeof data === 'string' ? data : safeJson(data) || undefined\n\n    if (status && responsePart) return `HTTP ${status}: ${responsePart}`\n    if (status) return `HTTP ${status}: ${error.message}`\n    return responsePart || error.message\n  }\n\n  if (error instanceof Error) return error.message\n  return String(error)\n}\n\nfunction safeJson(value: unknown): string | null {\n  try {\n    return JSON.stringify(value)\n  } catch {\n    return null\n  }\n}\n"],"names":["RwaClient","RWA_BASE_URL","pushLatest","results","fields","vaults","api","list","status","limit","byDate","Map","vault","rwaTargets","rwa","filter","t","isActive","length","token","tokens","readOne","_id","tokenId","latestBlock","vaultLatestBlocks","vaultId","logger","debug","moment","normalizeTimestamp","block","timestamp","format","contractType","addParetoDollarEntries","cdoEpoch","epochs","vaultEpochs","sort","order","latest","prev","timestampMs","date","toDateString","snapshot","buildCdoEpochSnapshotForDate","mode","entry","buildMetricsEntry","rwaId","bucket","get","payload","items","push","set","batch","url","dryRun","info","item","message","res","axios","put","headers","Authorization","apiKey","getRwaResponseMessage","data","String","error","getErrorMessage","Error","initAxios","options","timeout","create","type","buildParetoDollarSnapshotSUSP","buildParetoDollarSnapshotUSP","constructor","console","Boolean","BNgt","supply","metrics","net_asset_value","Number","price","toFixed","decimals","net_asset_value_dollar","token_supply_circulating","aum","tvlToken","aum_dollar","tvlUSD","kyc","hideSensitiveData","netYield1d","yieldToken","net_yield_1d","netYield1dDollar","yieldUSD","net_yield_1d_dollar","id","fixAmount","totalSupply","BNify","fixTokenAmount","paretoDollar","staking","totalAssets","TVL","USD","yieldRate1d","APYs","NET","div","times","computeEpochData","epoch","tvl","interest","startTvlToken","startTvlUSD","grossInterest","GROSS","tokenToUsdRatio","gt","grossInterestUSD","startPrice","prevEpoch","epochMode","prevData","undefined","dailyYield","value","Date","getTime","isFinite","num","parsed","parse","subtract","record","isAxiosError","response","responsePart","safeJson","JSON","stringify"],"mappings":"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"}