{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/integrations/term-finance-client/term-finance-client.lib.ts"],"sourcesContent":["import axios, { Axios, CreateAxiosDefaults } from 'axios'\nimport BigNumber from 'bignumber.js'\nimport { BNify, BNstring } from '../../core'\nimport {\n  IntegrationClientModel,\n  IntegrationRepoTokensParams,\n} from '../integration-client.model'\nimport { TermFinanceHolder } from '../../vaults'\nimport { EtherscanClient } from '../etherscan-client/etherscan-client.lib'\nimport type {\n  GraphQLResponse,\n  TermRepoCollateralResponse,\n} from './term-finance-client.model'\n\nconst ZERO_ADDRESS = '0x0000000000000000000000000000000000000000'\nconst TERM_FINANCE_SUBGRAPH_ENDPOINT =\n  'https://graphql-gateway-term.mainnet.mainnet.termfinance.io/graphql'\n\nexport class TermFinanceClient implements IntegrationClientModel {\n  private readonly axios: Axios\n  private readonly etherscanClient: EtherscanClient\n\n  constructor() {\n    this.axios = this.initAxios()\n    this.etherscanClient = new EtherscanClient()\n  }\n\n  public async getRepoTokensHolders(\n    params: IntegrationRepoTokensParams\n  ): Promise<TermFinanceHolder[]> {\n    const { collateralToken, blockNumber } = params\n\n    if (!collateralToken) {\n      throw new Error(\n        'Integration Error: TermFinance collateralToken parameter is required'\n      )\n    }\n\n    const repoTokens = await this.fetchRepoTokens(collateralToken, blockNumber)\n\n    if (!repoTokens.length) {\n      return []\n    }\n\n    const lenders: TermFinanceHolder[] = []\n\n    for (const { repoToken, purchaseToken } of repoTokens) {\n      const balances = await this.getRepoTokenBalances(repoToken, blockNumber)\n\n      balances.forEach((balance, address) => {\n        if (balance.lte(0)) {\n          return\n        }\n\n        lenders.push({\n          address,\n          repoToken,\n          purchaseToken,\n          balance: BNstring(balance),\n        })\n      })\n    }\n\n    return lenders\n  }\n\n  private initAxios(): Axios {\n    const options: CreateAxiosDefaults = {\n      baseURL: TERM_FINANCE_SUBGRAPH_ENDPOINT,\n      headers: {\n        'content-type': 'application/json',\n      },\n    }\n\n    return axios.create(options)\n  }\n\n  private async fetchRepoTokens(\n    collateralToken: string,\n    blockNumber?: number\n  ): Promise<{ repoToken: string; purchaseToken: string }[]> {\n    const normalizedCollateral = collateralToken.toLowerCase()\n    const blockArg =\n      blockNumber && !isNaN(blockNumber)\n        ? `, block: { number: ${blockNumber} }`\n        : ''\n    const query = `{\n      termRepoCollaterals(where:{collateralToken:\"${normalizedCollateral}\" amountLocked_gt:0}${blockArg}){\n        term{termRepoToken purchaseToken}\n      }\n    }`\n\n    const { data } = await this.axios.request<\n      GraphQLResponse<TermRepoCollateralResponse>\n    >({\n      method: 'POST',\n      data: { query },\n    })\n\n    if (data.errors?.length) {\n      const [error] = data.errors\n      throw new Error(\n        `Integration Error: TermFinance repo token query failed (${error.message})`\n      )\n    }\n\n    const termRepoCollaterals = data.data?.termRepoCollaterals ?? []\n\n    const tokensMap = new Map<string, string>()\n\n    termRepoCollaterals.forEach(({ term }) => {\n      const repoToken = term?.termRepoToken?.toLowerCase()\n      const purchaseToken = term?.purchaseToken?.toLowerCase()\n\n      if (!repoToken || !purchaseToken) {\n        return\n      }\n\n      tokensMap.set(repoToken, purchaseToken)\n    })\n\n    return Array.from(tokensMap.entries()).map(\n      ([repoToken, purchaseToken]) => ({\n        repoToken,\n        purchaseToken,\n      })\n    )\n  }\n\n  private async getRepoTokenBalances(\n    repoToken: string,\n    blockNumber?: number\n  ): Promise<Map<string, BigNumber>> {\n    const transfers = await this.etherscanClient.getTokenTransfers(repoToken, {\n      blockNumber,\n    })\n    const balances = new Map<string, BigNumber>()\n\n    transfers.forEach((transfer) => {\n      const value = BNify(transfer.value)\n      const from = transfer.from?.toLowerCase()\n      const to = transfer.to?.toLowerCase()\n\n      if (!from || !to) {\n        return\n      }\n\n      if (from !== ZERO_ADDRESS) {\n        const current = balances.get(from) || BNify(0)\n        const updated = current.minus(value)\n\n        if (updated.lte(0)) {\n          balances.delete(from)\n        } else {\n          balances.set(from, updated)\n        }\n      }\n\n      if (to !== ZERO_ADDRESS) {\n        const current = balances.get(to) || BNify(0)\n        const updated = current.plus(value)\n\n        if (updated.lte(0)) {\n          balances.delete(to)\n        } else {\n          balances.set(to, updated)\n        }\n      }\n    })\n\n    return balances\n  }\n}\n"],"names":["TermFinanceClient","ZERO_ADDRESS","TERM_FINANCE_SUBGRAPH_ENDPOINT","getRepoTokensHolders","params","collateralToken","blockNumber","Error","repoTokens","fetchRepoTokens","length","lenders","repoToken","purchaseToken","balances","getRepoTokenBalances","forEach","balance","address","lte","push","BNstring","initAxios","options","baseURL","headers","axios","create","data","normalizedCollateral","toLowerCase","blockArg","isNaN","query","request","method","errors","error","message","termRepoCollaterals","tokensMap","Map","term","termRepoToken","set","Array","from","entries","map","transfers","etherscanClient","getTokenTransfers","transfer","value","BNify","to","current","get","updated","minus","delete","plus","constructor","EtherscanClient"],"mappings":"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"}