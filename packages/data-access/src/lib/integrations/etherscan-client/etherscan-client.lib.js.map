{"version":3,"sources":["../../../../../../../../libs/shared/data-access/src/lib/integrations/etherscan-client/etherscan-client.lib.ts"],"sourcesContent":["import axios, { Axios, CreateAxiosDefaults } from 'axios'\nimport type {\n  EtherscanClientOptions,\n  EtherscanResponse,\n  EtherscanTokenTransfer,\n  GetTokenTransfersOptions,\n} from './etherscan-client.model'\n\nconst DEFAULT_BASE_URL = 'https://api.etherscan.io/v2/api'\nconst DEFAULT_CHAIN_ID = 1\nconst DEFAULT_PAGE_SIZE = 1000\n\nexport class EtherscanClient {\n  private readonly axios: Axios\n  private readonly apiKey?: string\n  private readonly defaultPageSize: number\n\n  constructor(options: EtherscanClientOptions = {}) {\n    const {\n      apiKey = process.env['ETHERSCAN_API_TOKEN'],\n      baseURL = DEFAULT_BASE_URL,\n      chainId = DEFAULT_CHAIN_ID,\n      defaultPageSize = DEFAULT_PAGE_SIZE,\n    } = options\n\n    this.apiKey = apiKey\n    this.defaultPageSize = defaultPageSize\n\n    const axiosOptions: CreateAxiosDefaults = {\n      baseURL,\n      params: {\n        chainid: chainId,\n      },\n      headers: {\n        'content-type': 'application/json',\n      },\n    }\n\n    this.axios = axios.create(axiosOptions)\n  }\n\n  public async getTokenTransfers(\n    contractAddress: string,\n    options: GetTokenTransfersOptions = {}\n  ): Promise<EtherscanTokenTransfer[]> {\n    if (!this.apiKey) {\n      throw new Error(\n        'Integration Error: ETHERSCAN_API_TOKEN is not configured in the environment'\n      )\n    }\n\n    const { blockNumber, pageSize = this.defaultPageSize } = options\n\n    const transfers: EtherscanTokenTransfer[] = []\n    let page = 1\n    let dataLen = 0\n\n    do {\n      const params: Record<string, string | number> = {\n        module: 'account',\n        action: 'tokentx',\n        contractaddress: contractAddress,\n        page,\n        offset: pageSize,\n        sort: 'asc',\n        apikey: this.apiKey,\n      }\n\n      if (typeof blockNumber === 'number') {\n        params['endblock'] = blockNumber\n      }\n\n      const { data } = await this.axios.request<\n        EtherscanResponse<EtherscanTokenTransfer[]>\n      >({\n        method: 'GET',\n        params,\n      })\n\n      if (data.status === '0') {\n        if (data.message === 'No transactions found') {\n          break\n        }\n\n        const errorMessage =\n          typeof data.result === 'string' && data.result.length\n            ? data.result\n            : data.message\n\n        throw new Error(\n          `Integration Error: Etherscan response error (${errorMessage})`\n        )\n      }\n\n      if (typeof data.result === 'string') {\n        throw new Error(\n          `Integration Error: Etherscan response error (${data.result})`\n        )\n      }\n\n      transfers.push(...data.result)\n      dataLen = data.result.length\n      page += 1\n    } while (dataLen >= pageSize)\n\n    return transfers\n  }\n}\n"],"names":["EtherscanClient","DEFAULT_BASE_URL","DEFAULT_CHAIN_ID","DEFAULT_PAGE_SIZE","getTokenTransfers","contractAddress","options","apiKey","Error","blockNumber","pageSize","defaultPageSize","transfers","page","dataLen","params","module","action","contractaddress","offset","sort","apikey","data","axios","request","method","status","message","errorMessage","result","length","push","constructor","process","env","baseURL","chainId","axiosOptions","chainid","headers","create"],"mappings":";;;;+BAYaA;;;eAAAA;;;;gEAZqC;AAQlD,MAAMC,mBAAmB;AACzB,MAAMC,mBAAmB;AACzB,MAAMC,oBAAoB;AAEnB,IAAA,AAAMH,kBAAN,MAAMA;IA6BX,MAAaI,kBACXC,eAAuB,EACvBC,UAAoC,CAAC,CAAC,EACH;QACnC,IAAI,CAAC,IAAI,CAACC,MAAM,EAAE;YAChB,MAAM,IAAIC,MACR;QAEJ;QAEA,MAAM,EAAEC,WAAW,EAAEC,WAAW,IAAI,CAACC,eAAe,EAAE,GAAGL;QAEzD,MAAMM,YAAsC,EAAE;QAC9C,IAAIC,OAAO;QACX,IAAIC,UAAU;QAEd,GAAG;YACD,MAAMC,SAA0C;gBAC9CC,QAAQ;gBACRC,QAAQ;gBACRC,iBAAiBb;gBACjBQ;gBACAM,QAAQT;gBACRU,MAAM;gBACNC,QAAQ,IAAI,CAACd,MAAM;YACrB;YAEA,IAAI,OAAOE,gBAAgB,UAAU;gBACnCM,MAAM,CAAC,WAAW,GAAGN;YACvB;YAEA,MAAM,EAAEa,IAAI,EAAE,GAAG,MAAM,IAAI,CAACC,KAAK,CAACC,OAAO,CAEvC;gBACAC,QAAQ;gBACRV;YACF;YAEA,IAAIO,KAAKI,MAAM,KAAK,KAAK;gBACvB,IAAIJ,KAAKK,OAAO,KAAK,yBAAyB;oBAC5C;gBACF;gBAEA,MAAMC,eACJ,OAAON,KAAKO,MAAM,KAAK,YAAYP,KAAKO,MAAM,CAACC,MAAM,GACjDR,KAAKO,MAAM,GACXP,KAAKK,OAAO;gBAElB,MAAM,IAAInB,MACR,CAAC,6CAA6C,EAAEoB,aAAa,CAAC,CAAC;YAEnE;YAEA,IAAI,OAAON,KAAKO,MAAM,KAAK,UAAU;gBACnC,MAAM,IAAIrB,MACR,CAAC,6CAA6C,EAAEc,KAAKO,MAAM,CAAC,CAAC,CAAC;YAElE;YAEAjB,UAAUmB,IAAI,IAAIT,KAAKO,MAAM;YAC7Bf,UAAUQ,KAAKO,MAAM,CAACC,MAAM;YAC5BjB,QAAQ;QACV,QAASC,WAAWJ,SAAS;QAE7B,OAAOE;IACT;IAzFAoB,YAAY1B,UAAkC,CAAC,CAAC,CAAE;QAChD,MAAM,EACJC,SAAS0B,QAAQC,GAAG,CAAC,sBAAsB,EAC3CC,UAAUlC,gBAAgB,EAC1BmC,UAAUlC,gBAAgB,EAC1BS,kBAAkBR,iBAAiB,EACpC,GAAGG;QAEJ,IAAI,CAACC,MAAM,GAAGA;QACd,IAAI,CAACI,eAAe,GAAGA;QAEvB,MAAM0B,eAAoC;YACxCF;YACApB,QAAQ;gBACNuB,SAASF;YACX;YACAG,SAAS;gBACP,gBAAgB;YAClB;QACF;QAEA,IAAI,CAAChB,KAAK,GAAGA,cAAK,CAACiB,MAAM,CAACH;IAC5B;AAoEF"}