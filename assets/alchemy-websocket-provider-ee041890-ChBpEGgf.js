import{g as Y,W as j,V,E as U,_ as m,n as $,C as P,a as q,i as E,v as z,b as X,c as k,A as C,D as J,d as x,e as T,f as H,B as Q,h as b,t as _}from"./index-DI4LdDzf.js";import{AlchemyProvider as R}from"./alchemy-provider-2577f5a5-BguhP5jD.js";var I={},M;function Z(){if(M)return I;M=1,Object.defineProperty(I,"__esModule",{value:!0});var l="Provided shouldReconnect() returned false. Closing permanently.",e="Provided shouldReconnect() resolved to false. Closing permanently.",t=(function(){function i(s,o,a){if(a===void 0&&(a={}),this.url=s,this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this.ondown=null,this.onreopen=null,this.CONNECTING=i.CONNECTING,this.OPEN=i.OPEN,this.CLOSING=i.CLOSING,this.CLOSED=i.CLOSED,this.hasBeenOpened=!1,this.isClosed=!1,this.messageBuffer=[],this.nextRetryTime=0,this.reconnectCount=0,this.lastKnownExtensions="",this.lastKnownProtocol="",this.listeners={},o==null||typeof o=="string"||Array.isArray(o)?this.protocols=o:a=o,this.options=n(a),!this.options.wsConstructor)if(typeof WebSocket<"u")this.options.wsConstructor=WebSocket;else throw new Error("WebSocket not present in global scope and no wsConstructor option was provided.");this.openNewWebSocket()}return Object.defineProperty(i.prototype,"binaryType",{get:function(){return this.binaryTypeInternal||"blob"},set:function(s){this.binaryTypeInternal=s,this.ws&&(this.ws.binaryType=s)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"bufferedAmount",{get:function(){var s=this.ws?this.ws.bufferedAmount:0,o=!1;return this.messageBuffer.forEach(function(a){var h=r(a);h!=null?s+=h:o=!0}),o&&this.debugLog("Some buffered data had unknown length. bufferedAmount() return value may be below the correct amount."),s},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"extensions",{get:function(){return this.ws?this.ws.extensions:this.lastKnownExtensions},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"protocol",{get:function(){return this.ws?this.ws.protocol:this.lastKnownProtocol},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"readyState",{get:function(){return this.isClosed?i.CLOSED:i.OPEN},enumerable:!0,configurable:!0}),i.prototype.close=function(s,o){this.disposeSocket(s,o),this.shutdown(),this.debugLog("WebSocket permanently closed by client.")},i.prototype.send=function(s){if(this.isClosed)throw new Error("WebSocket is already in CLOSING or CLOSED state.");this.ws&&this.ws.readyState===this.OPEN?this.ws.send(s):this.messageBuffer.push(s)},i.prototype.reconnect=function(){if(this.isClosed)throw new Error("Cannot call reconnect() on socket which is permanently closed.");this.disposeSocket(1e3,"Client requested reconnect."),this.handleClose(void 0)},i.prototype.addEventListener=function(s,o){this.listeners[s]||(this.listeners[s]=[]),this.listeners[s].push(o)},i.prototype.dispatchEvent=function(s){return this.dispatchEventOfType(s.type,s)},i.prototype.removeEventListener=function(s,o){this.listeners[s]&&(this.listeners[s]=this.listeners[s].filter(function(a){return a!==o}))},i.prototype.openNewWebSocket=function(){var s=this;if(!this.isClosed){var o=this.options,a=o.connectTimeout,h=o.wsConstructor;this.debugLog("Opening new WebSocket to "+this.url+".");var f=new h(this.url,this.protocols);f.onclose=function(d){return s.handleClose(d)},f.onerror=function(d){return s.handleError(d)},f.onmessage=function(d){return s.handleMessage(d)},f.onopen=function(d){return s.handleOpen(d)},this.connectTimeoutId=setTimeout(function(){s.clearConnectTimeout(),s.disposeSocket(),s.handleClose(void 0)},a),this.ws=f}},i.prototype.handleOpen=function(s){var o=this;if(!(!this.ws||this.isClosed)){var a=this.options.allClearResetTime;this.debugLog("WebSocket opened."),this.binaryTypeInternal!=null?this.ws.binaryType=this.binaryTypeInternal:this.binaryTypeInternal=this.ws.binaryType,this.clearConnectTimeout(),this.hasBeenOpened?this.dispatchEventOfType("reopen",s):(this.dispatchEventOfType("open",s),this.hasBeenOpened=!0),this.messageBuffer.forEach(function(h){return o.send(h)}),this.messageBuffer=[],this.allClearTimeoutId=setTimeout(function(){o.clearAllClearTimeout(),o.nextRetryTime=0,o.reconnectCount=0;var h=a/1e3|0;o.debugLog("WebSocket remained open for "+h+" seconds. Resetting retry time and count.")},a)}},i.prototype.handleMessage=function(s){this.isClosed||this.dispatchEventOfType("message",s)},i.prototype.handleClose=function(s){var o=this;if(!this.isClosed){var a=this.options,h=a.maxReconnectAttempts,f=a.shouldReconnect;if(this.clearConnectTimeout(),this.clearAllClearTimeout(),this.ws&&(this.lastKnownExtensions=this.ws.extensions,this.lastKnownProtocol=this.ws.protocol,this.disposeSocket()),this.dispatchEventOfType("down",s),this.reconnectCount>=h){this.stopReconnecting(s,this.getTooManyFailedReconnectsMessage());return}var d=!s||f(s);typeof d=="boolean"?this.handleWillReconnect(d,s,l):d.then(function(y){o.isClosed||o.handleWillReconnect(y,s,e)})}},i.prototype.handleError=function(s){this.dispatchEventOfType("error",s),this.debugLog("WebSocket encountered an error.")},i.prototype.handleWillReconnect=function(s,o,a){s?this.reestablishConnection():this.stopReconnecting(o,a)},i.prototype.reestablishConnection=function(){var s=this,o=this.options,a=o.minReconnectDelay,h=o.maxReconnectDelay,f=o.reconnectBackoffFactor;this.reconnectCount++;var d=this.nextRetryTime;this.nextRetryTime=Math.max(a,Math.min(this.nextRetryTime*f,h)),setTimeout(function(){return s.openNewWebSocket()},d);var y=d/1e3|0;this.debugLog("WebSocket was closed. Re-opening in "+y+" seconds.")},i.prototype.stopReconnecting=function(s,o){this.debugLog(o),this.shutdown(),s&&this.dispatchEventOfType("close",s)},i.prototype.shutdown=function(){this.isClosed=!0,this.clearAllTimeouts(),this.messageBuffer=[],this.disposeSocket()},i.prototype.disposeSocket=function(s,o){this.ws&&(this.ws.onerror=u,this.ws.onclose=u,this.ws.onmessage=u,this.ws.onopen=u,this.ws.close(s,o),this.ws=void 0)},i.prototype.clearAllTimeouts=function(){this.clearConnectTimeout(),this.clearAllClearTimeout()},i.prototype.clearConnectTimeout=function(){this.connectTimeoutId!=null&&(clearTimeout(this.connectTimeoutId),this.connectTimeoutId=void 0)},i.prototype.clearAllClearTimeout=function(){this.allClearTimeoutId!=null&&(clearTimeout(this.allClearTimeoutId),this.allClearTimeoutId=void 0)},i.prototype.dispatchEventOfType=function(s,o){var a=this;switch(s){case"close":this.onclose&&this.onclose(o);break;case"error":this.onerror&&this.onerror(o);break;case"message":this.onmessage&&this.onmessage(o);break;case"open":this.onopen&&this.onopen(o);break;case"down":this.ondown&&this.ondown(o);break;case"reopen":this.onreopen&&this.onreopen(o);break}return s in this.listeners&&this.listeners[s].slice().forEach(function(h){return a.callListener(h,o)}),!o||!o.defaultPrevented},i.prototype.callListener=function(s,o){typeof s=="function"?s.call(this,o):s.handleEvent.call(this,o)},i.prototype.debugLog=function(s){this.options.debug&&console.log(s)},i.prototype.getTooManyFailedReconnectsMessage=function(){var s=this.options.maxReconnectAttempts;return"Failed to reconnect after "+s+" "+c("attempt",s)+". Closing permanently."},i.DEFAULT_OPTIONS={allClearResetTime:5e3,connectTimeout:5e3,debug:!1,minReconnectDelay:1e3,maxReconnectDelay:3e4,maxReconnectAttempts:Number.POSITIVE_INFINITY,reconnectBackoffFactor:1.5,shouldReconnect:function(){return!0},wsConstructor:void 0},i.CONNECTING=0,i.OPEN=1,i.CLOSING=2,i.CLOSED=3,i})();I.default=t;function n(i){var s={};return Object.keys(t.DEFAULT_OPTIONS).forEach(function(o){var a=i[o];s[o]=a===void 0?t.DEFAULT_OPTIONS[o]:a}),s}function r(i){return typeof i=="string"?2*i.length:i instanceof ArrayBuffer?i.byteLength:i instanceof Blob?i.size:void 0}function c(i,s){return s===1?i:i+"s"}function u(){}return I}var ee=Z();const te=Y(ee),se=120;class ne{constructor(e){this.provider=e,this.maxBackfillBlocks=se}getNewHeadsBackfill(e,t,n){return m(this,void 0,void 0,function*(){p(e);const r=yield this.getBlockNumber();if(p(e),t.length===0)return this.getHeadEventsInRange(Math.max(n,r-this.maxBackfillBlocks)+1,r+1);const c=b(t[t.length-1].number),u=r-this.maxBackfillBlocks+1;if(c<=u)return this.getHeadEventsInRange(u,r+1);const i=yield this.getReorgHeads(e,t);p(e);const s=yield this.getHeadEventsInRange(c+1,r+1);return p(e),[...i,...s]})}getLogsBackfill(e,t,n,r){return m(this,void 0,void 0,function*(){p(e);const c=yield this.getBlockNumber();if(p(e),n.length===0)return this.getLogsInRange(t,Math.max(r,c-this.maxBackfillBlocks)+1,c+1);const u=b(n[n.length-1].blockNumber),i=c-this.maxBackfillBlocks+1;if(u<i)return this.getLogsInRange(t,i,c+1);const s=yield this.getCommonAncestor(e,n);p(e);const o=n.filter(f=>b(f.blockNumber)>s.blockNumber).map(f=>Object.assign(Object.assign({},f),{removed:!0})),a=s.blockNumber===Number.NEGATIVE_INFINITY?b(n[0].blockNumber):s.blockNumber;let h=yield this.getLogsInRange(t,a,c+1);return h=h.filter(f=>f&&(b(f.blockNumber)>s.blockNumber||b(f.logIndex)>s.logIndex)),p(e),[...o,...h]})}setMaxBackfillBlock(e){this.maxBackfillBlocks=e}getBlockNumber(){return m(this,void 0,void 0,function*(){const e=yield this.provider.send("eth_blockNumber");return b(e)})}getHeadEventsInRange(e,t){return m(this,void 0,void 0,function*(){if(e>=t)return[];const n=[];for(let c=e;c<t;c++)n.push({method:"eth_getBlockByNumber",params:[_(c),!1]});return(yield this.provider.sendBatch(n)).map(D)})}getReorgHeads(e,t){return m(this,void 0,void 0,function*(){const n=[];for(let r=t.length-1;r>=0;r--){const c=t[r],u=yield this.getBlockByNumber(b(c.number));if(p(e),c.hash===u.hash)break;n.push(D(u))}return n.reverse()})}getBlockByNumber(e){return m(this,void 0,void 0,function*(){return this.provider.send("eth_getBlockByNumber",[_(e),!1])})}getCommonAncestor(e,t){return m(this,void 0,void 0,function*(){let n=yield this.getBlockByNumber(b(t[t.length-1].blockNumber));p(e);for(let r=t.length-1;r>=0;r--){const c=t[r];if(c.blockNumber!==n.number&&(n=yield this.getBlockByNumber(b(c.blockNumber))),c.blockHash===n.hash)return{blockNumber:b(c.blockNumber),logIndex:b(c.logIndex)}}return{blockNumber:Number.NEGATIVE_INFINITY,logIndex:Number.NEGATIVE_INFINITY}})}getLogsInRange(e,t,n){return m(this,void 0,void 0,function*(){if(t>=n)return[];const r=Object.assign(Object.assign({},e),{fromBlock:_(t),toBlock:_(n-1)});return this.provider.send("eth_getLogs",[r])})}}function D(l){const e=Object.assign({},l);return delete e.totalDifficulty,delete e.transactions,delete e.uncles,e}function ie(l){return K(l,e=>e.hash)}function re(l){return K(l,e=>`${e.blockHash}/${e.logIndex}`)}function K(l,e){const t=new Set,n=[];return l.forEach(r=>{const c=e(r);t.has(c)||(t.add(c),n.push(r))}),n}const oe=new Error("Cancelled");function p(l){if(l())throw oe}const ce=3e4,le=1e4,F=6e4,W=5,ae=10;class _e extends j{constructor(e,t){var n;const r=R.getApiKey(e.apiKey),c=R.getAlchemyNetwork(e.network),u=R.getAlchemyConnectionInfo(c,r,"wss"),i=`alchemy-sdk-${V}`,s=new te((n=e.url)!==null&&n!==void 0?n:u.url,i,{wsConstructor:t??ue()}),o=U[c];super(s,o??void 0),this._events=[],this.virtualSubscriptionsById=new Map,this.virtualIdsByPhysicalId=new Map,this.handleMessage=a=>{const h=JSON.parse(a.data);if(!ge(h))return;const f=h.params.subscription,d=this.virtualIdsByPhysicalId.get(f);if(!d)return;const y=this.virtualSubscriptionsById.get(d);if(y.method==="eth_subscribe")switch(y.params[0]){case"newHeads":{const v=y,B=h,{isBackfilling:A,backfillBuffer:S}=v,{result:g}=B.params;A?Ee(S,g):f!==d?this.emitAndRememberEvent(d,g,w):this.rememberEvent(d,g,w);break}case"logs":{const v=y,B=h,{isBackfilling:A,backfillBuffer:S}=v,{result:g}=B.params;A?ke(S,g):d!==f?this.emitAndRememberEvent(d,g,N):this.rememberEvent(d,g,N);break}default:if(f!==d){const{result:v}=h.params;this.emitEvent(d,v)}}},this.handleReopen=()=>{this.virtualIdsByPhysicalId.clear();const{cancel:a,isCancelled:h}=de();this.cancelBackfill=a;for(const f of this.virtualSubscriptionsById.values())m(this,void 0,void 0,function*(){try{yield this.resubscribeAndBackfill(h,f)}catch(d){h()||console.error(`Error while backfilling "${f.params[0]}" subscription. Some events may be missing.`,d)}});this.startHeartbeat()},this.stopHeartbeatAndBackfill=()=>{this.heartbeatIntervalId!=null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=void 0),this.cancelBackfill()},this.apiKey=r,this.backfiller=new ne(this),this.addSocketListeners(),this.startHeartbeat(),this.cancelBackfill=$}static getNetwork(e){return typeof e=="string"&&e in P?P[e]:q(e)}on(e,t){return this._addEventListener(e,t,!1)}once(e,t){return this._addEventListener(e,t,!0)}off(e,t){return E(e)?this._off(e,t):super.off(e,t)}removeAllListeners(e){return e!==void 0&&E(e)?this._removeAllListeners(e):super.removeAllListeners(e)}listenerCount(e){return e!==void 0&&E(e)?this._listenerCount(e):super.listenerCount(e)}listeners(e){return e!==void 0&&E(e)?this._listeners(e):super.listeners(e)}_addEventListener(e,t,n){if(E(e)){z(e);const r=new X(k(e),t,n);return this._events.push(r),this._startEvent(r),this}else return super._addEventListener(e,t,n)}_startEvent(e){[...C,"block","filter"].includes(e.type)?this.customStartEvent(e):super._startEvent(e)}_subscribe(e,t,n,r){return m(this,void 0,void 0,function*(){let c=this._subIds[e];const u=yield this.getBlockNumber();c==null&&(c=Promise.all(t).then(o=>this.send("eth_subscribe",o)),this._subIds[e]=c);const i=yield c,s=yield Promise.all(t);this.virtualSubscriptionsById.set(i,{event:r,method:"eth_subscribe",params:s,startingBlockNumber:u,virtualId:i,physicalId:i,sentEvents:[],isBackfilling:!1,backfillBuffer:[]}),this.virtualIdsByPhysicalId.set(i,i),this._subs[i]={tag:e,processFunc:n}})}emit(e,...t){if(E(e)){let n=!1;const r=[],c=k(e);return this._events=this._events.filter(u=>u.tag!==c?!0:(setTimeout(()=>{u.listener.apply(this,t)},0),n=!0,u.once?(r.push(u),!1):!0)),r.forEach(u=>{this._stopEvent(u)}),n}else return super.emit(e,...t)}sendBatch(e){return m(this,void 0,void 0,function*(){let t=0;const n=e.map(({method:r,params:c})=>({method:r,params:c,jsonrpc:"2.0",id:`alchemy-sdk:${t++}`}));return this.sendBatchConcurrently(n)})}destroy(){return this.removeSocketListeners(),this.stopHeartbeatAndBackfill(),super.destroy()}isCommunityResource(){return this.apiKey===J}_stopEvent(e){let t=e.tag;if(C.includes(e.type)){if(this._events.filter(r=>C.includes(r.type)).length)return}else if(e.type==="tx"){if(this._events.filter(r=>r.type==="tx").length)return;t="tx"}else if(this.listenerCount(e.event))return;const n=this._subIds[t];n&&(delete this._subIds[t],n.then(r=>{this._subs[r]&&(delete this._subs[r],this.send("eth_unsubscribe",[r]))}))}addSocketListeners(){this._websocket.addEventListener("message",this.handleMessage),this._websocket.addEventListener("reopen",this.handleReopen),this._websocket.addEventListener("down",this.stopHeartbeatAndBackfill)}removeSocketListeners(){this._websocket.removeEventListener("message",this.handleMessage),this._websocket.removeEventListener("reopen",this.handleReopen),this._websocket.removeEventListener("down",this.stopHeartbeatAndBackfill)}resubscribeAndBackfill(e,t){return m(this,void 0,void 0,function*(){const{virtualId:n,method:r,params:c,sentEvents:u,backfillBuffer:i,startingBlockNumber:s}=t;t.isBackfilling=!0,i.length=0;try{const o=yield this.send(r,c);switch(p(e),t.physicalId=o,this.virtualIdsByPhysicalId.set(o,n),c[0]){case"newHeads":{const a=yield G(()=>L(this.backfiller.getNewHeadsBackfill(e,u,s),F),W,()=>!e());p(e),ie([...a,...i]).forEach(f=>this.emitNewHeadsEvent(n,f));break}case"logs":{const a=c[1]||{},h=yield G(()=>L(this.backfiller.getLogsBackfill(e,a,u,s),F),W,()=>!e());p(e),re([...h,...i]).forEach(d=>this.emitLogsEvent(n,d));break}default:break}}finally{t.isBackfilling=!1,i.length=0}})}emitNewHeadsEvent(e,t){this.emitAndRememberEvent(e,t,w)}emitLogsEvent(e,t){this.emitAndRememberEvent(e,t,N)}emitAndRememberEvent(e,t,n){this.rememberEvent(e,t,n),this.emitEvent(e,t)}emitEvent(e,t){const n=this.virtualSubscriptionsById.get(e);n&&this.emitGenericEvent(n,t)}rememberEvent(e,t,n){const r=this.virtualSubscriptionsById.get(e);r&&O(r.sentEvents,Object.assign({},t),n)}emitGenericEvent(e,t){this.emitProcessFn(e.event)(t)}startHeartbeat(){this.heartbeatIntervalId==null&&(this.heartbeatIntervalId=setInterval(()=>m(this,void 0,void 0,function*(){try{yield L(this.send("net_version"),le)}catch{this._websocket.reconnect()}}),ce))}sendBatchConcurrently(e){return m(this,void 0,void 0,function*(){return Promise.all(e.map(t=>this.send(t.method,t.params)))})}customStartEvent(e){if(e.type===x){const{fromAddress:t,toAddress:n,hashesOnly:r}=e;this._subscribe(e.tag,[T.PENDING_TRANSACTIONS,{fromAddress:t,toAddress:n,hashesOnly:r}],this.emitProcessFn(e),e)}else if(e.type===H){const{addresses:t,includeRemoved:n,hashesOnly:r}=e;this._subscribe(e.tag,[T.MINED_TRANSACTIONS,{addresses:t,includeRemoved:n,hashesOnly:r}],this.emitProcessFn(e),e)}else e.type==="block"?this._subscribe("block",["newHeads"],this.emitProcessFn(e),e):e.type==="filter"&&this._subscribe(e.tag,["logs",this._getFilter(e.filter)],this.emitProcessFn(e),e)}emitProcessFn(e){switch(e.type){case x:return t=>this.emit({method:T.PENDING_TRANSACTIONS,fromAddress:e.fromAddress,toAddress:e.toAddress,hashesOnly:e.hashesOnly},t);case H:return t=>this.emit({method:T.MINED_TRANSACTIONS,addresses:e.addresses,includeRemoved:e.includeRemoved,hashesOnly:e.hashesOnly},t);case"block":return t=>{const n=Q.from(t.number).toNumber();this._emitted.block=n,this.emit("block",n)};case"filter":return t=>{t.removed==null&&(t.removed=!1),this.emit(e.filter,this.formatter.filterLog(t))};default:throw new Error("Invalid event type to `emitProcessFn()`")}}_off(e,t){if(t==null)return this.removeAllListeners(e);const n=[];let r=!1;const c=k(e);return this._events=this._events.filter(u=>u.tag!==c||u.listener!=t||r?!0:(r=!0,n.push(u),!1)),n.forEach(u=>{this._stopEvent(u)}),this}_removeAllListeners(e){let t=[];if(e==null)t=this._events,this._events=[];else{const n=k(e);this._events=this._events.filter(r=>r.tag!==n?!0:(t.push(r),!1))}return t.forEach(n=>{this._stopEvent(n)}),this}_listenerCount(e){if(!e)return this._events.length;const t=k(e);return this._events.filter(n=>n.tag===t).length}_listeners(e){if(e==null)return this._events.map(n=>n.listener);const t=k(e);return this._events.filter(n=>n.tag===t).map(n=>n.listener)}}function ue(){return he()?require("websocket").w3cwebsocket:WebSocket}function he(){return typeof process<"u"&&process!=null&&process.versions!=null&&process.versions.node!=null}function de(){let l=!1;return{cancel:()=>l=!0,isCancelled:()=>l}}const fe=1e3,me=2,be=3e4;function G(l,e,t=()=>!0){return m(this,void 0,void 0,function*(){let n=0,r=0;for(;;)try{return yield l()}catch(c){if(r++,r>=e||!t(c)||(yield pe(n),!t(c)))throw c;n=n===0?fe:Math.min(be,me*n)}})}function pe(l){return new Promise(e=>setTimeout(e,l))}function L(l,e){return Promise.race([l,new Promise((t,n)=>setTimeout(()=>n(new Error("Timeout")),e))])}function w(l){return b(l.number)}function N(l){return b(l.blockNumber)}function ye(l){return Array.isArray(l)||l.jsonrpc==="2.0"&&l.id!==void 0}function ge(l){return!ye(l)}function Ee(l,e){O(l,e,w)}function ke(l,e){O(l,e,N)}function O(l,e,t){const n=t(e),r=l.findIndex(c=>t(c)>n-ae);r===-1?l.length=0:l.splice(0,r),l.push(e)}export{_e as AlchemyWebSocketProvider};
