import{J as g,E as w,D as u,C as l,a as E,j as b,N as p,V as m,I as N,_ as d,l as _,k as v,m as f,o as A,p as y}from"./index-Cr4pEBxH.js";const B=100,R=10;class k{constructor(e,t=B){this.sendBatchFn=e,this.maxBatchSize=t,this.pendingBatch=[]}enqueueRequest(e){return d(this,void 0,void 0,function*(){const t={request:e,resolve:void 0,reject:void 0},s=new Promise((r,i)=>{t.resolve=r,t.reject=i});return this.pendingBatch.push(t),this.pendingBatch.length===this.maxBatchSize?this.sendBatchRequest():this.pendingBatchTimer||(this.pendingBatchTimer=setTimeout(()=>this.sendBatchRequest(),R)),s})}sendBatchRequest(){return d(this,void 0,void 0,function*(){const e=this.pendingBatch;this.pendingBatch=[],this.pendingBatchTimer&&(clearTimeout(this.pendingBatchTimer),this.pendingBatchTimer=void 0);const t=e.map(s=>s.request);return this.sendBatchFn(t).then(s=>{e.forEach((r,i)=>{const n=s[i];if(n.error){const o=new Error(n.error.message);o.code=n.error.code,o.data=n.error.data,r.reject(o)}else r.resolve(n.result)})},s=>{e.forEach(r=>{r.reject(s)})})})}}class a extends g{constructor(e){const t=a.getApiKey(e.apiKey),s=a.getAlchemyNetwork(e.network);let r=a.getAlchemyConnectionInfo(s,t,"http");e.url!==void 0&&(r.url=e.url),r.throttleLimit=e.maxRetries,e.connectionInfoOverrides&&(r=Object.assign(Object.assign({},r),e.connectionInfoOverrides));const i=w[s];if(!i)throw new Error(`Unsupported network: ${s}`);super(r,i),this.apiKey=e.apiKey,this.maxRetries=e.maxRetries,this.batchRequests=e.batchRequests;const n=Object.assign(Object.assign({},this.connection),{headers:Object.assign(Object.assign({},this.connection.headers),{"Alchemy-Ethers-Sdk-Method":"batchSend"})}),o=c=>f(n,JSON.stringify(c));this.batcher=new k(o),this.modifyFormatter()}static getApiKey(e){if(e==null)return u;if(e&&typeof e!="string")throw new Error(`Invalid apiKey '${e}' provided. apiKey must be a string.`);return e}static getNetwork(e){return typeof e=="string"&&e in l?l[e]:E(e)}static getAlchemyNetwork(e){if(e===void 0)return b;if(typeof e=="number")throw new Error(`Invalid network '${e}' provided. Network must be a string.`);if(!Object.values(p).includes(e))throw new Error(`Invalid network '${e}' provided. Network must be one of: ${Object.values(p).join(", ")}.`);return e}static getAlchemyConnectionInfo(e,t,s){const r=s==="http"?A(e,t):y(e,t);return{headers:N?{"Alchemy-Ethers-Sdk-Version":m}:{"Alchemy-Ethers-Sdk-Version":m,"Accept-Encoding":"gzip"},allowGzip:!0,url:r}}detectNetwork(){const e=Object.create(null,{detectNetwork:{get:()=>super.detectNetwork}});return d(this,void 0,void 0,function*(){let t=this.network;if(t==null&&(t=yield e.detectNetwork.call(this),!t))throw new Error("No network detected");return t})}_startPending(){_("WARNING: Alchemy Provider does not support pending filters")}isCommunityResource(){return this.apiKey===u}send(e,t){return this._send(e,t,"send")}_send(e,t,s){const r={method:e,params:t,id:this._nextId++,jsonrpc:"2.0"},i=Object.assign({},this.connection);if(i.headers["Alchemy-Ethers-Sdk-Method"]=s,this.batchRequests)return this.batcher.enqueueRequest(r);this.emit("debug",{action:"request",request:v(r),provider:this});const n=["eth_chainId","eth_blockNumber"].indexOf(e)>=0;if(n&&this._cache[e]!=null)return this._cache[e];const o=f(this.connection,JSON.stringify(r),O).then(c=>(this.emit("debug",{action:"response",request:r,response:c,provider:this}),c),c=>{throw this.emit("debug",{action:"response",error:c,request:r,provider:this}),c});return n&&(this._cache[e]=o,setTimeout(()=>{this._cache[e]=null},0)),o}modifyFormatter(){this.formatter.formats.receiptLog.removed=e=>{if(typeof e=="boolean")return e}}}function O(h){if(h.error){const e=new Error(h.error.message);throw e.code=h.error.code,e.data=h.error.data,e}return h.result}export{a as AlchemyProvider};
